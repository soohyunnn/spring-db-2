# ìŠ¤í”„ë§ íŠ¸ëœì­ì…˜ ì „íŒŒ2 - í™œìš©

## íŠ¸ëœì­ì…˜ ì „íŒŒ í™œìš© 1 - ì˜ˆì œ í”„ë¡œì íŠ¸ ì‹œì‘

### ë¹„ì¦ˆë‹ˆìŠ¤ ìš”êµ¬ì‚¬í•­

- íšŒì›ì„ ë“±ë¡í•˜ê³  ì¡°íšŒí•œë‹¤.
- íšŒì›ì— ëŒ€í•œ ë³€ê²½ ì´ë ¥ì„ ì¶”ì í•  ìˆ˜ ìˆë„ë¡ íšŒì› ë°ì´í„°ê°€ ë³€ê²½ë  ë•Œ ë³€ê²½ ì´ë ¥ì„ DB LOG í…Œì´ë¸”ì— ë‚¨ê²¨ì•¼ í•œë‹¤.
    - ì—¬ê¸°ì„œëŠ” ì˜ˆì œë¥¼ ë‹¨ìˆœí™” í•˜ê¸° ìœ„í•´ íšŒì› ë“±ë¡ì‹œì—ë§Œ DB LOG í…Œì´ë¸”ì— ë‚¨ê¸´ë‹¤.

**Member**

```java
package hello.springtx.propagation;

import jakarta.persistence.Entity;
import jakarta.persistence.GeneratedValue;
import jakarta.persistence.Id;
import lombok.Getter;
import lombok.Setter;

@Entity
@Getter
@Setter
public class Member {

    @Id
    @GeneratedValue
    private Long id;

    private String username;

    public Member() {
    }

    public Member(String username) {
        this.username = username;
    }
}
```

- JPAë¥¼ í†µí•´ ê´€ë¦¬í•˜ëŠ” íšŒì› ì—”í‹°í‹°ì´ë‹¤.

**MemberRepository**

```java
package hello.springtx.propagation;

import jakarta.persistence.EntityManager;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Repository;
import org.springframework.transaction.annotation.Transactional;

import java.util.Optional;

@Slf4j
@Repository
@RequiredArgsConstructor
public class MemberRepository {

    private final EntityManager em;

    @Transactional
    public void save(Member member) {
        log.info("member ì €ì¥");
        em.persist(member);
    }

    public Optional<Member> find(String username) {
        return em.createQuery("select m from Member m where m.username=:username", Member.class)
                .setParameter("username", username)
                .getResultList()
                .stream()
                .findFirst();
    }

}
```

- JPAë¥¼ ì‚¬ìš©í•˜ëŠ” íšŒì› ë¦¬í¬ì§€í† ë¦¬ì´ë‹¤. ì €ì¥ê³¼ ì¡°íšŒ ê¸°ëŠ¥ì„ ì œê³µí•œë‹¤.

**Log**

```java
package hello.springtx.propagation;

import jakarta.persistence.Entity;
import jakarta.persistence.GeneratedValue;
import jakarta.persistence.Id;
import lombok.Getter;
import lombok.Setter;

@Entity
@Getter
@Setter
public class Log {

    @Id
    @GeneratedValue
    private Long id;

    private String message;
    
    public Log() {
    }
    
    public Log(String message) {
        this.message = message;
    }
    
}
```

- JPAë¥¼ í†µí•´ ê´€ë¦¬í•˜ëŠ” ë¡œê·¸ ì—”í‹°í‹°ì´ë‹¤.

**LogRepository**

```java
package hello.springtx.propagation;

import jakarta.persistence.EntityManager;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Repository;
import org.springframework.transaction.annotation.Transactional;

import java.util.Optional;

@Slf4j
@Repository
@RequiredArgsConstructor
public class LogRepository {

    private final EntityManager em;

    @Transactional
    public void save(Log logMessage) {
        log.info("log ì €ì¥");
        em.persist(logMessage);

        if (logMessage.getMessage().contains("ë¡œê·¸ì˜ˆì™¸")) {
            log.info("log ì €ì¥ì‹œ ì˜ˆì™¸ ë°œìƒ");
            throw new RuntimeException("ë¡œê·¸ì˜ˆì™¸");
        }
    }

    public Optional<Log> find(String message) {
        return em.createQuery("select l from Log l where l.message=:message", Log.class)
                .setParameter("message", message)
                .getResultList()
                .stream()
                .findFirst();
    }

}
```

- JPAë¥¼ ì‚¬ìš©í•˜ëŠ” ë¡œê·¸ ë¦¬í¬ì§€í† ë¦¬ì´ë‹¤. ì €ì¥ê³¼ ì¡°íšŒ ê¸°ëŠ¥ì„ ì œê³µí•œë‹¤.
- ì¤‘ê°„ì— ì˜ˆì™¸ ìƒí™©ì„ ì¬í˜„í•˜ê¸° ìœ„í•´ `ë¡œê·¸ì˜ˆì™¸`ë¼ê³  ì…ë ¥í•˜ëŠ” ê²½ìš° ì˜ˆì™¸ë¥¼ ë°œìƒì‹œí‚¨ë‹¤.

**MemberService**

```java
package hello.springtx.propagation;

import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;

@Slf4j
@Service
@RequiredArgsConstructor
public class MemberService {

    private final MemberRepository memberRepository;
    private final LogRepository logRepository;

    public void joinV1(String username) {

        Member member = new Member(username);
        Log logMessage = new Log(username);

        log.info("== memberRepository í˜¸ì¶œ ì‹œì‘ ==");
        memberRepository.save(member);
        log.info("== memberRepository í˜¸ì¶œ ì¢…ë£Œ ==");

        log.info("== logRepository í˜¸ì¶œ ì‹œì‘ ==");
        logRepository.save(logMessage);
        log.info("== logRepository í˜¸ì¶œ ì¢…ë£Œ ==");

    }

    public void joinV2(String username) {
        Member member = new Member(username);
        Log logMessage = new Log(username);

        log.info("== memberRepository í˜¸ì¶œ ì‹œì‘ ==");
        memberRepository.save(member);
        log.info("== memberRepository í˜¸ì¶œ ì¢…ë£Œ ==");

        log.info("== logRepository í˜¸ì¶œ ì‹œì‘ ==");
        try {
            logRepository.save(logMessage);
        } catch (RuntimeException e) {
            log.info("log ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹¤. logMessage={}", logMessage.getMessage());
            log.info("ì •ìƒ íë¦„ ë³€í™˜");
        }
        log.info("== logRepository í˜¸ì¶œ ì¢…ë£Œ ==");
    }

}
```

- íšŒì›ì„ ë“±ë¡í•˜ë©´ì„œ ë™ì‹œì— íšŒì› ë“±ë¡ì— ëŒ€í•œ DB ë¡œê·¸ë„ í•¨ê»˜ ë‚¨ê¸´ë‹¤.
- `joinV1()`
    - íšŒì›ê³¼ DBë¡œê·¸ë¥¼ í•¨ê»˜ ë‚¨ê¸°ëŠ” ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì´ë‹¤.
    - í˜„ì¬ ë³„ë„ì˜ íŠ¸ëœì­ì…˜ì€ ì„¤ì •í•˜ì§€ ì•ŠëŠ”ë‹¤.
- `joinV2()`
    - `joinV1()`ê³¼ ê°™ì€ ê¸°ëŠ¥ì„ ìˆ˜í–‰í•œë‹¤.
    - DBë¡œê·¸ ì €ì¥ì‹œ ì˜ˆì™¸ê°€ ë°œìƒí•˜ë©´ ì˜ˆì™¸ë¥¼ ë³µêµ¬í•œë‹¤.
    - í˜„ì¬ ë³„ë„ì˜ íŠ¸ëœì­ì…˜ì€ ì„¤ì •í•˜ì§€ ì•ŠëŠ”ë‹¤.
    

**MemberServiceTest**

```java
package hello.springtx.propagation;

import lombok.extern.slf4j.Slf4j;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;

import static org.junit.jupiter.api.Assertions.*;

@Slf4j
@SpringBootTest
class MemberServiceTest {

    @Autowired
    MemberService memberService;
    @Autowired
    MemberRepository memberRepository;
    @Autowired
    LogRepository logRepository;

    /**
     * MemberService @Transactional: OFF
     * MemberRepository @Transactional: ON
     * LogRepository @Transactional: ON
     */
    @Test
    void outerTxOff_success() {
        //given
        String username = "outerTxOff_success";
        
        //when
        memberService.joinV1(username);
        
        //then: ëª¨ë“  ë°ì´í„°ê°€ ì •ìƒ ì €ì¥ëœë‹¤.
        assertTrue(memberRepository.find(username).isPresent());
        assertTrue(logRepository.find(username).isPresent());
    } 
    
    

}
```

ì •ìƒ ë™ì‘í•˜ëŠ”ì§€ í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•´ë³´ì.

> ğŸ’¡ì°¸ê³ 
> 
- JPAì˜ êµ¬í˜„ì²´ì¸ í•˜ì´ë²„ë„¤ì´íŠ¸ê°€ í…Œì´ë¸”ì„ ìë™ìœ¼ë¡œ ìƒì„±í•´ì¤€ë‹¤.
- ë©”ëª¨ë¦¬ DBì´ê¸° ë•Œë¬¸ì— ëª¨ë“  í…ŒìŠ¤íŠ¸ê°€ ì™„ë£Œëœ ì´í›„ì— DBëŠ” ì‚¬ë¼ì§„ë‹¤.
- ì—¬ê¸°ì„œëŠ” ê°ê°ì˜ í…ŒìŠ¤íŠ¸ê°€ ì™„ë£Œëœ ì‹œì ì— ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì§€ ì•ŠëŠ”ë‹¤. ë”°ë¼ì„œ `username`ì€ í…ŒìŠ¤íŠ¸ë³„ë¡œ ê°ê° ë‹¤ë¥´ê²Œ ì„¤ì •í•´ì•¼ í•œë‹¤. ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ ë‹¤ìŒ í…ŒìŠ¤íŠ¸ì— ì˜í–¥ì„ ì¤€ë‹¤. (ëª¨ë“  í…ŒìŠ¤íŠ¸ê°€ ì™„ë£Œë˜ì–´ì•¼ DBê°€ ì‚¬ë¼ì§„ë‹¤.)

**JPAì™€ ë°ì´í„° ë³€ê²½**

- JPAë¥¼ í†µí•œ ëª¨ë“  ë°ì´í„° ë³€ê²½(ë“±ë¡, ìˆ˜ì •, ì‚­ì œ)ì—ëŠ” íŠ¸ëœì­ì…˜ì´ í•„ìš”í•˜ë‹¤. (ì¡°íšŒëŠ” íŠ¸ëœì­ì…˜ ì—†ì´ ê°€ëŠ¥í•˜ë‹¤.)
    - í˜„ì¬ ì½”ë“œì—ì„œ ì„œë¹„ìŠ¤ ê³„ì¸µì— íŠ¸ëœì­ì…˜ì´ ì—†ê¸° ë•Œë¬¸ì— ë¦¬í¬ì§€í† ë¦¬ì— íŠ¸ëœì­ì…˜ì´ ìˆë‹¤.

## íŠ¸ëœì­ì…˜ ì „íŒŒ í™œìš© 2 - ì»¤ë°‹, ë¡¤ë°±

### ì„œë¹„ìŠ¤ ê³„ì¸µì— íŠ¸ëœì­ì…˜ì´ ì—†ì„ ë•Œ - ì»¤ë°‹

ì˜ˆì œë¥¼ í†µí•´ ì„œë¹„ìŠ¤ ê³„ì¸µì— íŠ¸ëœì­ì…˜ì´ ì—†ì„ ë•Œ íŠ¸ëœì­ì…˜ì´ ê°ê° ì–´ë–»ê²Œ ì‘ë™í•˜ëŠ”ì§€ í™•ì¸í•´ë³´ì.

**ìƒí™©**

- ì„œë¹„ìŠ¤ ê³„ì¸µì— íŠ¸ëœì­ì…˜ì´ ì—†ë‹¤.
- íšŒì›, ë¡œê·¸ ë¦¬í¬ì§€í† ë¦¬ê°€ ê°ê° íŠ¸ëœì­ì…˜ì„ ê°€ì§€ê³  ìˆë‹¤.
- íšŒì›, ë¡œê·¸ ë¦¬í¬ì§€í† ë¦¬ ë‘˜ë‹¤ ì»¤ë°‹ì— ì„±ê³µí•œë‹¤.

**outerTxOff_success**

```java
/**
 * MemberService @Transactional: OFF
 * MemberRepository @Transactional: ON
 * LogRepository @Transactional: ON
 */
@Test
void outerTxOff_success() {
    //given
    String username = "outerTxOff_success";
    
    //when
    memberService.joinV1(username);
    
    //then: ëª¨ë“  ë°ì´í„°ê°€ ì •ìƒ ì €ì¥ëœë‹¤.
    assertTrue(memberRepository.find(username).isPresent());
    assertTrue(logRepository.find(username).isPresent());
} 
```

![Untitled](https://github.com/soohyunnn/spring-db-2/assets/58289675/25569f0d-dbf5-4e07-ad20-3fff1acf2146)

![Untitled 1](https://github.com/soohyunnn/spring-db-2/assets/58289675/705b31f5-9372-461c-95f5-2d36bb2584f4)

1. `MemberService`ì—ì„œ `MemberRepository`ë¥¼ í˜¸ì¶œí•œë‹¤. `MemberRepository`ì—ëŠ” `@Transactional` ì–´ë…¸í…Œì´ì…˜ì´ ìˆìœ¼ë¯€ë¡œ íŠ¸ëœì­ì…˜ AOPê°€ ì‘ë™í•œë‹¤. ì—¬ê¸°ì„œ íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì €ë¥¼ í†µí•´ íŠ¸ëœì­ì…˜ì„ ì‹œì‘í•œë‹¤. ì´ë ‡ê²Œ ì‹œì‘í•œ íŠ¸ëœì­ì…˜ì„ íŠ¸ëœì­ì…˜Bë¼ í•˜ì.
    - ê·¸ë¦¼ì—ì„œëŠ” ìƒëµí–ˆì§€ë§Œ, íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì €ì— íŠ¸ëœì­ì…˜ì„ ìš”ì²­í•˜ë©´ ë°ì´í„°ì†ŒìŠ¤ë¥¼ í†µí•´ ì»¤ë„¥ì…˜ `con1`ì„ íšë“í•˜ê³ , í•´ë‹¹ ì»¤ë„¥ì…˜ì„ ìˆ˜ë™ ì»¤ë°‹ ëª¨ë“œë¡œ ë³€ê²½í•´ì„œ íŠ¸ëœì­ì…˜ì„ ì‹œì‘í•œë‹¤.
    - ê·¸ë¦¬ê³  íŠ¸ëœì­ì…˜ ë™ê¸°í™” ë§¤ë‹ˆì €ë¥¼ í†µí•´ íŠ¸ëœì­ì…˜ì„ ì‹œì‘í•œ ì»¤ë„¥ì…˜ì„ ë³´ê´€í•œë‹¤.
    - íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì €ì˜ í˜¸ì¶œ ê²°ê³¼ë¡œ `status`ë¥¼ ë°˜í™˜í•œë‹¤. ì—¬ê¸°ì„œëŠ” ì‹ ê·œ íŠ¸ëœì­ì…˜ ì—¬ë¶€ê°€ ì°¸ì´ ëœë‹¤.
2. `MemberRepository`ëŠ” JPAë¥¼ í†µí•´ íšŒì›ì„ ì €ì¥í•˜ëŠ”ë°, ì´ë•Œ JPAëŠ” íŠ¸ëœì­ì…˜ì´ ì‹œì‘ëœ `con1`ì„ ì‚¬ìš©í•´ì„œ íšŒì›ì„ ì €ì¥í•œë‹¤.
3. `MemberRepository`ê°€ ì •ìƒ ì‘ë‹µì„ ë°˜í™˜í–ˆê¸° ë•Œë¬¸ì— íŠ¸ëœì­ì…˜ AOPëŠ” íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì €ì— ì»¤ë°‹ì„ ìš”ì²­í•œë‹¤.
4. íŠ¸ëœì­ì…” ë§¤ë‹ˆì €ëŠ” `con1`ì„ í†µí•´ ë¬¼ë¦¬ íŠ¸ëœì­ì…˜ì„ ì»¤ë°‹í•œë‹¤.
    - ë¬¼ë¡  ì´ ì‹œì ì— ì•ì„œ ì„¤ëª…í•œ ì‹ ê·œ íŠ¸ëœì­ì…˜ ì—¬ë¶€, `rollbackOnly` ì—¬ë¶€ë¥¼ ëª¨ë‘ ì²´í¬í•œë‹¤.

ì´ë ‡ê²Œ í•´ì„œ `MemberRepository`ì™€ ê´€ë ¨ëœ ëª¨ë“  ë°ì´í„°ëŠ” ì •ìƒ ì»¤ë°‹ë˜ê³ , íŠ¸ëœì¬ì…˜BëŠ” ì™„ì „íˆ ì¢…ë£Œëœë‹¤.

ì´í›„ì— `LogRepository`ë¥¼ í†µí•´ íŠ¸ëœì­ì…˜Cë¥¼ ì‹œì‘í•˜ê³ , ì •ìƒ ì»¤ë°‹í•œë‹¤.

ê²°ê³¼ì ìœ¼ë¡œ ë‘˜ë‹¤ ì»¤ë°‹ë˜ì—ˆìœ¼ë¯€ë¡œ `Member`, `Log` ëª¨ë‘ ì•ˆì „í•˜ê²Œ ì €ì¥ëœë‹¤.

**@Transactionalê³¼ REQUIRED**

- íŠ¸ëœì­ì…˜ ì „íŒŒì˜ ê¸°ë³¸ ê°’ì€ `REQUIRED`ì´ë‹¤. ë”°ë¼ì„œ ë‹¤ìŒ ë‘˜ì€ ê°™ë‹¤.
    - `@Transactional(propagation = Propagation.REQUIRED)`
    - `@Transactional`
- `REQUIRED`ëŠ” ê¸°ì¡´ íŠ¸ëœì­ì…˜ì´ ì—†ìœ¼ë©´ ìƒˆë¡œìš´ íŠ¸ëœì­ì…˜ì„ ë§Œë“¤ê³ , ê¸°ì¡´ íŠ¸ëœì­ì…˜ì´ ìˆìœ¼ë©´ ì°¸ì—¬í•œë‹¤.

### ì„œë¹„ìŠ¤ ê³„ì¸µì— íŠ¸ëœì­ì…˜ì´ ì—†ì„ ë•Œ - ë¡¤ë°±

**ìƒí™©**

- ì„œë¹„ìŠ¤ ê³„ì¸µì— íŠ¸ëœì­ì…˜ì´ ì—†ë‹¤.
- íšŒì›, ë¡œê·¸ ë¦¬í¬ì§€í† ë¦¬ê°€ ê°ê° íŠ¸ëœì­ì…˜ì„ ê°€ì§€ê³  ìˆë‹¤.
- íšŒì› ë¦¬í¬ì§€í† ë¦¬ëŠ” ì •ìƒ ë™ì‘í•˜ì§€ë§Œ ë¡œê·¸ ë¦¬í¬ì§€í† ë¦¬ì—ì„œ ì˜ˆì™¸ê°€ ë°œìƒí•œë‹¤.

**outerTxOff_fail**

```java
/**
 * MemberService @Transactional: OFF
 * MemberRepository @Transactional: ON
 * LogRepository @Transactional: ON Exception
 */
@Test
void outerTxOff_fail() {
    //given
    String username = "ë¡œê·¸ì˜ˆì™¸_outerTxOff_fail";

    //when
    assertThatThrownBy(() -> memberService.joinV1(username))
            .isInstanceOf(RuntimeException.class);

    //then: ì™„ì „íˆ ë¡¤ë°±ë˜ì§€ ì•Šê³ , member ë°ì´í„°ê°€ ë‚¨ì•„ì„œ ì €ì¥ëœë‹¤.
    assertTrue(memberRepository.find(username).isPresent());
    assertTrue(logRepository.find(username).isEmpty());

}
```

- ì‚¬ìš©ì ì´ë¦„ì— `ë¡œê·¸ì˜ˆì™¸`ë¼ëŠ” ë‹¨ì–´ê°€ í¬í•¨ë˜ì–´ ìˆìœ¼ë©´ `LogRepository`ì—ì„œ ëŸ°íƒ€ì„ ì˜ˆì™¸ê°€ ë°œìƒí•œë‹¤.
- íŠ¸ëœì­ì…˜ AOPëŠ” í•´ë‹¹ ëŸ°íƒ€ì„ ì˜ˆì™¸ë¥¼ í™•ì¸í•˜ê³  ë¡¤ë°± ì²˜ë¦¬í•œë‹¤.

**ë¡œê·¸ì˜ˆì™¸ ë¡œì§**

```java
if (logMessage.getMessage().contains("ë¡œê·¸ì˜ˆì™¸")) {
    log.info("log ì €ì¥ì‹œ ì˜ˆì™¸ ë°œìƒ");
    throw new RuntimeException("ë¡œê·¸ì˜ˆì™¸");
}
```

![Untitled 2](https://github.com/soohyunnn/spring-db-2/assets/58289675/81d56c5c-9102-4a90-bd78-cd80411beef5)

![Untitled 3](https://github.com/soohyunnn/spring-db-2/assets/58289675/8fcaaa04-fc38-4c02-b412-961450251a00)

- `MemberService`ì—ì„œ `MemberRepository`ë¥¼ í˜¸ì¶œí•˜ëŠ” ë¶€ë¶„ì€ ì•ì—ì„œ ì„¤ëª…í•œ ë‚´ìš©ê³¼ ê°™ë‹¤. íŠ¸ëœì­ì…˜ì´ ì •ìƒ ì»¤ë°‹ë˜ê³ , íšŒì› ë°ì´í„°ë„ DBì— ì •ìƒ ë°˜ì˜ëœë‹¤.
- `MemberService`ì—ì„œ `LogRepository`ë¥¼ í˜¸ì¶œí•˜ëŠ”ë°, `ë¡œê·¸ì˜ˆì™¸`ë¼ëŠ” ì´ë¦„ì„ ì „ë‹¬í•œë‹¤. ì´ ê³¼ì •ì—ì„œ ìƒˆë¡œìš´ íŠ¸ëœì­ì…˜ Cê°€ ë§Œë“¤ì–´ì§„ë‹¤.

**LogRepository ì‘ë‹µ ë¡œì§**

1. `LogRepository`ëŠ” íŠ¸ëœì­ì…˜ Cì™€ ê´€ë ¨ëœ `con2`ë¥¼ ì‚¬ìš©í•œë‹¤.
2. `ë¡œê·¸ì˜ˆì™¸`ë¼ëŠ” ì´ë¦„ì„ ì „ë‹¬í•´ì„œ `LogRepository`ì— ëŸ°íƒ€ì„ ì˜ˆì™¸ê°€ ë°œìƒí•œë‹¤.
3. `LogRepository`ëŠ” í•´ë‹¹ ì˜ˆì™¸ë¥¼ ë°–ìœ¼ë¡œ ë˜ì§„ë‹¤. ì´ ê²½ìš° íŠ¸ëœì­ì…˜ AOPê°€ ì˜ˆì™¸ë¥¼ ë°›ê²Œëœë‹¤.
4. ëŸ°íƒ€ì„ ì˜ˆì™¸ê°€ ë°œìƒí•´ì„œ íŠ¸ëœì­ì…˜ AOPëŠ” íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì €ì— ë¡¤ë°±ì„ í˜¸ì¶œí•œë‹¤.
5. íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì €ëŠ” ì‹ ê·œ íŠ¸ëœì­ì…˜ì´ë¯€ë¡œ ë¬¼ë¦¬ ë¡¤ë°±ì„ í˜¸ì¶œí•œë‹¤.

> **ğŸ’¡Â ì°¸ê³ **
> 

íŠ¸ëœì­ì…˜ AOPë„ ê²°êµ­ ë‚´ë¶€ì—ì„œëŠ” íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì €ë¥¼ ì‚¬ìš©í•˜ê²Œ ëœë‹¤.

ì´ ê²½ìš° íšŒì›ì€ ì €ì¥ë˜ì§€ë§Œ, íšŒì› ì´ë ¥ ë¡œê·¸ëŠ” ë¡¤ë°±ëœë‹¤. ë”°ë¼ì„œ ë°ì´í„° ì •í•©ì„±ì— ë¬¸ì œê°€ ë°œìƒí•  ìˆ˜ ìˆë‹¤.

ë‘˜ì„ í•˜ë‚˜ì˜ íŠ¸ëœì­ì…˜ìœ¼ë¡œ ë¬¶ì–´ì„œ ì²˜ë¦¬í•´ë³´ì.

## íŠ¸ëœì­ì…˜ ì „íŒŒ í™œìš© 3 - ë‹¨ì¼ íŠ¸ëœì­ì…˜

### íŠ¸ëœì­ì…˜ í•˜ë‚˜ë§Œ ì‚¬ìš©í•˜ê¸°

íšŒì› ë¦¬í¬ì§€í† ë¦¬ì™€ ë¡œê·¸ ë¦¬í¬ì§€í† ë¦¬ë¥¼ í•˜ë‚˜ì˜ íŠ¸ëœì­ì…˜ìœ¼ë¡œ ë¬¶ëŠ” ê°€ì¥ ê°„ë‹¨í•œ ë°©ë²•ì€ ì´ ë‘˜ì„ í˜¸ì¶œí•˜ëŠ” íšŒì› ì„œë¹„ìŠ¤ì—ë§Œ íŠ¸ëœì­ì…˜ì„ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ë‹¤.

**singleTx**

```java
/**
 * MemberService @Transactional: ON
 * MemberRepository @Transactional: OFF
 * LogRepository @Transactional: OFF
 */
@Test
void singleTx() {
    //given
    String username = "singleTx";

    //when
    memberService.joinV1(username);

    //then: ëª¨ë“  ë°ì´í„°ê°€ ì •ìƒ ì €ì¥ëœë‹¤.
    assertTrue(memberRepository.find(username).isPresent());
    assertTrue(logRepository.find(username).isPresent());
}
```

- í´ë˜ìŠ¤ ìƒìœ„ì˜ ì£¼ì„ì„ ì°¸ê³ í•˜ì. ì–´ë””ì— íŠ¸ëœì­ì…˜ì„ ê±¸ê³  ë¹¼ì•¼ í•˜ëŠ”ì§€ ë‚˜ì™€ìˆë‹¤.

**MemberService - joinV1()**

```java
@Transactional //ì¶”ê°€
public void joinV1(String username)
```

**MemberRepository - save()**

```java
//@Transactional //ì œê±°
public void save(Member member)
```

**LogRepository - save()**

```java
//@Transactional //ì œê±°
public void save(Log logMessage)
```

- `MemberRepository`, `LogRepository`ì˜ `@Transactional` ì½”ë“œë¥¼ ì œê±°í•˜ì.
- ê·¸ë¦¬ê³  `MemberService`ì—ë§Œ `@Transactional` ì½”ë“œë¥¼ ì¶”ê°€í•˜ì.

![Untitled 4](https://github.com/soohyunnn/spring-db-2/assets/58289675/1d89fe0b-358b-42f1-bb7b-8ab6993a2c42)

- ì´ë ‡ê²Œ í•˜ë©´ `MemberService`ë¥¼ ì‹œì‘í•  ë•Œ ë¶€í„° ì¢…ë£Œí•  ë•Œ ê¹Œì§€ì˜ ëª¨ë“  ë¡œì§ì„ í•˜ë‚˜ì˜ íŠ¸ëœì­ì…˜ìœ¼ë¡œ ë¬¶ì„ ìˆ˜ ìˆë‹¤.
    - ë¬¼ë¡  `MemberService`ê°€ `MemberRepository`, `LogRepository`ë¥¼ í˜¸ì¶œí•˜ë¯€ë¡œ ì´ ë¡œì§ë“¤ì€ ê°™ì€ íŠ¸ëœì­ì…˜ì„ ì‚¬ìš©í•œë‹¤.
- `MemberService`ë§Œ íŠ¸ëœì­ì…˜ì„ ì²˜ë¦¬í•˜ê¸° ë•Œë¬¸ì— ì•ì„œ ë°°ìš´ ë…¼ë¦¬ íŠ¸ëœì­ì…˜, ë¬¼ë¦¬ íŠ¸ëœì­ì…˜, ì™¸ë¶€ íŠ¸ëœì­ì…˜, ë‚´ë¶€ íŠ¸ëœì­ì…˜, `rollbackOnly`, ì‹ ê·œ íŠ¸ëœì­ì…˜, íŠ¸ëœì­ì…˜ ì „íŒŒì™€ ê°™ì€ ë³µì¡í•œ ê²ƒì„ ê³ ë¯¼í•  í•„ìš”ê°€ ì—†ë‹¤.
    
    ï£¿ã…ì£¼ ë‹¨ìˆœí•˜ê³  ê¹”ë”í•˜ê²Œ íŠ¸ëœì­ì…˜ì„ ë¬¶ì„ ìˆ˜ ìˆë‹¤.
    

![Untitled 5](https://github.com/soohyunnn/spring-db-2/assets/58289675/80803094-5f2c-4a69-9ae8-b21cc234ce29)

- `@Transactional`ì´ `MemberService`ì—ë§Œ ë¶™ì–´ìˆê¸° ë•Œë¬¸ì— ì—¬ê¸°ì—ë§Œ íŠ¸ëœì­ì…˜ AOPê°€ ì ìš©ëœë‹¤.
    - `MemberRepository`, `LogRepository`ëŠ” íŠ¸ëœì­ì…˜ AOPê°€ ì ìš©ë˜ì§€ ì•ŠëŠ”ë‹¤.
- `MemberService`ì˜ ì‹œì‘ë¶€í„° ëê¹Œì§€, ê´€ë ¨ ë¡œì§ì€ í•´ë‹¹ íŠ¸ëœì­ì…˜ì´ ìƒì„±í•œ ì»¤ë„¥ì…˜ì„ ì‚¬ìš©í•˜ê²Œ ëœë‹¤.
    - `MemberService`ê°€ í˜¸ì¶œí•˜ëŠ” `MemberRepository`, `LogRepository`ë„ ê°™ì€ ì»¤ë„¥ì…˜ì„ ì‚¬ìš©í•˜ë©´ì„œ ìì—°ìŠ¤ëŸ½ê²Œ íŠ¸ëœì­ì…˜ ë²”ìœ„ì— í¬í•¨ëœë‹¤.

> ğŸ’¡Â ì°¸ê³ 
> 

ê°™ì€ ì“°ë ˆë“œë¥¼ ì‚¬ìš©í•˜ë©´ íŠ¸ëœì­ì…˜ ë™ê¸°í™” ë§¤ë‹ˆì €ëŠ” ê°™ì€ ì»¤ë„¥ì…˜ì„ ë°˜í™˜í•œë‹¤.

**ì§ì ‘ ì‹¤í–‰í•´ì„œ ë¡œê·¸ì™€ ê·¸ë¦¼ì„ ë¹„êµí•´ë³´ì.**

### ê°ê° íŠ¸ëœì­ì…˜ì´ í•„ìš”í•œ ìƒí™©

í•˜ì§€ë§Œ ë‹¤ìŒê³¼ ê°™ì´ ê°ê° íŠ¸ëœì­ì…˜ì´ í•„ìš”í•˜ë©´ ì–´ë–»ê²Œ í•´ì•¼í• ê¹Œ?

![Untitled 6](https://github.com/soohyunnn/spring-db-2/assets/58289675/dc5d58e6-c232-463f-9e59-b9c45b1608b0)

**íŠ¸ëœì­ì…˜ ì ìš© ë²”ìœ„**

![Untitled 7](https://github.com/soohyunnn/spring-db-2/assets/58289675/e40156b8-e1db-4f89-af94-bad56f58861d)

- í´ë¼ì´ì–¸íŠ¸ AëŠ” `MemberService`ë¶€í„° `MemberRepository`, `LogRepository`ë¥¼ ëª¨ë‘ í•˜ë‚˜ì˜ íŠ¸ëœì­ì…˜ìœ¼ë¡œ ë¬¶ê³  ì‹¶ë‹¤.
- í´ë¼ì´ì–¸íŠ¸ BëŠ” `MemberRepository`ë§Œ í˜¸ì¶œí•˜ê³  ì—¬ê¸°ì—ë§Œ íŠ¸ëœì­ì…˜ì„ ì‚¬ìš©í•˜ê³  ì‹¶ë‹¤.
- í´ë¼ì´ì–¸íŠ¸ CëŠ” `LogRepository`ë§Œ í˜¸ì¶œí•˜ê³  ì—¬ê¸°ì—ë§Œ íŠ¸ëœì­ì…˜ì„ ì‚¬ìš©í•˜ê³  ì‹¶ë‹¤.

- í´ë¼ì´ì–¸íŠ¸ Aë§Œ ìƒê°í•˜ë©´ `MemberService`ì— íŠ¸ëœì­ì…˜ ì½”ë“œë¥¼ ë‚¨ê¸°ê³ , `MemberRepository`, `LogRepository`ì˜ íŠ¸ëœì­ì…˜ ì½”ë“œë¥¼ ì œê±°í•˜ë©´ ì•ì„œ ë°°ìš´ ê²ƒì²˜ëŸ¼ ê¹”ë”í•˜ê²Œ í•˜ë‚˜ì˜ íŠ¸ëœì­ì…˜ì„ ì ìš©í•  ìˆ˜ ìˆë‹¤.
- í•˜ì§€ë§Œ ì´ë ‡ê²Œ ë˜ë©´ í´ë¼ì´ì–¸íŠ¸ B, Cê°€ í˜¸ì¶œí•˜ëŠ” `MemberRepository`, `LogRepository`ì—ëŠ” íŠ¸ëœì­ì…˜ì„ ì ìš©í•  ìˆ˜ ì—†ë‹¤.

íŠ¸ëœì­ì…˜ ì „íŒŒ ì—†ì´ ì´ëŸ° ë¬¸ì œë¥¼ í•´ê²°í•˜ë ¤ë©´ ì•„ë§ˆë„ íŠ¸ëœì­ì…˜ì´ ìˆëŠ” ë©”ì„œë“œì™€ íŠ¸ëœì­ì…˜ì´ ì—†ëŠ” ë©”ì„œë“œë¥¼ ê°ê° ë§Œë“¤ì–´ì•¼ í•  ê²ƒì´ë‹¤.

ë” ë³µì¡í•˜ê²Œ ë‹¤ìŒê³¼ ê°™ì€ ìƒí™©ì´ ë°œìƒí•  ìˆ˜ë„ ìˆë‹¤.

![Untitled 8](https://github.com/soohyunnn/spring-db-2/assets/58289675/e2a6f0bb-ca94-481d-a204-3303a511c31e)

í´ë¼ì´ì–¸íŠ¸ Zê°€ í˜¸ì¶œí•˜ëŠ” OrderServiceì—ì„œë„ íŠ¸ëœì­ì…˜ì„ ì‹œì‘í•  ìˆ˜ ìˆì–´ì•¼ í•˜ê³ , í´ë¼ì´ì–¸íŠ¸Aê°€ í˜¸ì¶œí•˜ëŠ” `MemberService`ì—ì„œë„ íŠ¸ëœì­ì…˜ì„ ì‹œì‘í•  ìˆ˜ ìˆì–´ì•¼ í•œë‹¤.

**ì´ëŸ° ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ íŠ¸ëœì­ì…˜ ì „íŒŒê°€ í•„ìš”í•œ ê²ƒì´ë‹¤.**

## íŠ¸ëœì­ì…˜ ì „íŒŒ í™œìš© 4 - ì „íŒŒ ì»¤ë°‹

ìŠ¤í”„ë§ì€ `@Transactional`ì´ ì ìš©ë˜ì–´ ìˆìœ¼ë©´ ê¸°ë³¸ìœ¼ë¡œ `REQUIRED`ë¼ëŠ” ì „íŒŒ ì˜µì…˜ì„ ì‚¬ìš©í•œë‹¤. 

ì´ ì˜µì…˜ì€ ê¸°ì¡´ íŠ¸ëœì­ì…˜ì´ ì—†ìœ¼ë©´ íŠ¸ëœì­ì…˜ì„ ìƒì„±í•˜ê³ , ê¸°ì¡´ íŠ¸ëœì­ì…˜ì´ ìˆìœ¼ë©´ ê¸°ì¡´ íŠ¸ëœì­ì…˜ì— ì°¸ì—¬í•œë‹¤. ì°¸ì—¬í•œë‹¤ëŠ” ëœ»ì€ í•´ë‹¹ íŠ¸ëœì­ì…˜ì„ ê·¸ëŒ€ë¡œ ë”°ë¥¸ë‹¤ëŠ” ëœ»ì´ê³ , ë™ì‹œì— ê°™ì€ ë™ê¸°í™” ì»¤ë„¥ì…˜ì„ ì‚¬ìš©í•œë‹¤ëŠ” ëœ»ì´ë‹¤.

![Untitled 9](https://github.com/soohyunnn/spring-db-2/assets/58289675/264aa8cf-a404-40aa-a864-019190b36164)

ì´ë ‡ê²Œ ë‘˜ ì´ìƒì˜ íŠ¸ëœì­ì…˜ì´ í•˜ë‚˜ì˜ ë¬¼ë¦¬ íŠ¸ëœì­ì…˜ì— ë¬¶ì´ê²Œ ë˜ë©´ ë‘˜ì„ êµ¬ë¶„í•˜ê¸° ìœ„í•´ ë…¼ë¦¬ íŠ¸ëœì­ì…˜ê³¼ ë¬¼ë¦¬ íŠ¸ëœì­ì…˜ìœ¼ë¡œ êµ¬ë¶„í•œë‹¤.

**ì‹ ê·œ íŠ¸ëœì­ì…˜**

![Untitled 10](https://github.com/soohyunnn/spring-db-2/assets/58289675/84533f36-0063-4900-bf73-eea6be2a5f50)

- ì´ ê²½ìš° ì™¸ë¶€ì— ìˆëŠ” ì‹ ê·œ íŠ¸ëœì­ì…˜ë§Œ ì‹¤ì œ ë¬¼ë¦¬ íŠ¸ëœì­ì…˜ì„ ì‹œì‘í•˜ê³  ì»¤ë°‹í•œë‹¤.
- ë‚´ë¶€ì— ìˆëŠ” íŠ¸ëœì­ì…˜ì€ ë¬¼ë¦¬ íŠ¸ëœì­ì…˜ ì‹œì‘í•˜ê±°ë‚˜ ì»¤ë°‹í•˜ì§€ ì•ŠëŠ”ë‹¤.

**ëª¨ë“  ë…¼ë¦¬ íŠ¸ëœì­ì…˜ ì»¤ë°‹**

![Untitled 11](https://github.com/soohyunnn/spring-db-2/assets/58289675/5ba9805f-5645-4d75-af30-355bfb904ec9)

- ëª¨ë“  ë…¼ë¦¬ íŠ¸ëœì­ì…˜ì„ ì»¤ë°‹í•´ì•¼ ë¬¼ë¦¬ íŠ¸ëœì­ì…˜ë„ ì»¤ë°‹ëœë‹¤. í•˜ë‚˜ë¼ë„ ë¡¤ë°±ë˜ë©´ ë¬¼ë¦¬ íŠ¸ëœì­ì…˜ì€ ë¡¤ë°±ëœë‹¤.

ë¨¼ì € ëª¨ë“  ë…¼ë¦¬ íŠ¸ëœì­ì…˜ì´ ì •ìƒ ì»¤ë°‹ë˜ëŠ” ê²½ìš°ë¥¼ ì½”ë“œë¡œ í™•ì¸í•´ë³´ì.

**outerTxOn_seccess**

```java
/**
 * MemberService @Transactional: ON
 * MemberRepository @Transactional: ON
 * LogRepository @Transactional: ON
 */
@Test
void outerTxOn_success() {
    //given
    String username = "outerTxOn_success";

    //when
    memberService.joinV1(username);

    //then: ëª¨ë“  ë°ì´í„°ê°€ ì •ìƒ ì €ì¥ëœë‹¤.
    assertTrue(memberRepository.find(username).isPresent());
    assertTrue(logRepository.find(username).isPresent());
}
```

í´ë˜ìŠ¤ ìœ„ì˜ ì£¼ì„ì„ í™•ì¸í•´ì„œ ëª¨ë“  ê³³ì— íŠ¸ëœì­ì…˜ì„ ì ìš©í•˜ì.

- `MemberService @Transactional: ON`
- `MemberRepository @Transactional: ON`
- `LogRepository @Transactional: ON`

![Untitled 12](https://github.com/soohyunnn/spring-db-2/assets/58289675/504fedcd-1f03-4978-9144-c98a8270a82e)

- í´ë¼ì´ì–¸íŠ¸A(ì—¬ê¸°ì„œëŠ” í…ŒìŠ¤íŠ¸ ì½”ë“œ)ê°€ `MemberService`ë¥¼ í˜¸ì¶œí•˜ë©´ì„œ íŠ¸ëœì­ì…˜ AOPê°€ í˜¸ì¶œëœë‹¤.
    - ì—¬ê¸°ì„œ ì‹ ê·œ íŠ¸ëœì­ì…˜ì´ ìƒì„±ë˜ê³ , ë¬¼ë¦¬ íŠ¸ëœì­ì…˜ë„ ì‹œì‘í•œë‹¤.
- `MemberRepository`ë¥¼ í˜¸ì¶œí•˜ë©´ì„œ íŠ¸ëœì­ì…˜ AOPê°€ í˜¸ì¶œëœë‹¤.
    - ì´ë¯¸ íŠ¸ëœì­ì…˜ì´ ìˆìœ¼ë¯€ë¡œ ê¸°ì¡´ íŠ¸ëœì­ì…˜ì— ì°¸ì—¬í•œë‹¤.
- `MemberRepository`ì˜ ë¡œì§ í˜¸ì¶œì´ ëë‚˜ê³  ì •ìƒ ì‘ë‹µí•˜ë©´ íŠ¸ëœì­ì…˜ AOPê°€ í˜¸ì¶œëœë‹¤.
    - íŠ¸ëœì­ì…˜ AOPëŠ” ì •ìƒ ì‘ë‹µì´ë¯€ë¡œ íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì €ì— ì»¤ë°‹ì„ ìš”ì²­í•œë‹¤. ì´ ê²½ìš° íŠ¸ëœì­ì…˜ì´ ì•„ë‹ˆë¯€ë¡œ ì‹¤ì œ ì»¤ë°‹ì„ í˜¸ì¶œí•˜ì§€ ì•ŠëŠ”ë‹¤.
- `LogRepository`ë¥¼ í˜¸ì¶œí•˜ë©´ì„œ íŠ¸ëœì­ì…˜ AOPê°€ í˜¸ì¶œëœë‹¤.
    - ì´ë¯¸ íŠ¸ëœì­ì…˜ì´ ìˆìœ¼ë¯€ë¡œ ê¸°ì¡´ íŠ¸ëœì­ì…˜ì— ì°¸ì—¬í•œë‹¤.
- `LogRepository`ì˜ ë¡œì§ í˜¸ì¶œì´ ëë‚˜ê³  ì •ìƒ ì‘ë‹µí•˜ë©´ íŠ¸ëœì­ì…˜ AOPê°€ í˜¸ì¶œëœë‹¤.
    - íŠ¸ëœì­ì…˜ AOPëŠ” ì •ìƒ ì‘ë‹µì´ë¯€ë¡œ íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì €ì— ì»¤ë°‹ì„ ìš”ì²­í•œë‹¤. ì´ ê²½ìš° ì‹ ê·œ íŠ¸ëœì­ì…˜ì´ ì•„ë‹ˆë¯€ë¡œ ì‹¤ì œ ì»¤ë°‹(ë¬¼ë¦¬ ì»¤ë°‹)ì„ í˜¸ì¶œí•˜ì§€ ì•ŠëŠ”ë‹¤.
- `MemberService`ì˜ ë¡œì§ í˜¸ì¶œì´ ëë‚˜ê³  ì •ìƒ ì‘ë‹µí•˜ë©´ íŠ¸ëœì­ì…˜ AOPê°€ í˜¸ì¶œëœë‹¤.
    - íŠ¸ëœì­ì…˜ AOPëŠ” ì •ìƒ ì‘ë‹µì´ë¯€ë¡œ íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì €ì— ì»¤ë°‹ì„ ìš”ì²­í•œë‹¤. ì´ ê²½ìš° ì‹ ê·œ íŠ¸ëœì­ì…˜ì´ë¯€ë¡œ ë¬¼ë¦¬ ì»¤ë°‹ì„ í˜¸ì¶œí•œë‹¤.

## íŠ¸ëœì­ì…˜ ì „íŒŒ í™œìš© 5 - ì „íŒŒ ë¡¤ë°±

ì´ë²ˆì—ëŠ” ë¡œê·¸ ë¦¬í¬ì§€í† ë¦¬ì—ì„œ ì˜ˆì™¸ê°€ ë°œìƒí•´ì„œ ì „ì²´ íŠ¸ëœì­ì…˜ì´ ë¡¤ë°±ë˜ëŠ” ê²½ìš°ë¥¼ ì•Œì•„ë³´ì.

![Untitled 13](https://github.com/soohyunnn/spring-db-2/assets/58289675/f62ad1f1-c82c-4e63-805d-205689bd8a26)

**outerTxOn_fail**

```java
/**
 * MemberService @Transactional: ON
 * MemberRepository @Transactional: ON
 * LogRepository @Transactional: ON Exception
 */
@Test
void outerTxOn_fail() {
    //given
    String username = "ë¡œê·¸ì˜ˆì™¸_outerTxOn_fail";

    //when
    assertThatThrownBy(() -> memberService.joinV1(username))
            .isInstanceOf(RuntimeException.class);

    //then: ëª¨ë“  ë°ì´í„°ê°€ ë¡¤ë°±ëœë‹¤.
    assertTrue(memberRepository.find(username).isEmpty());
    assertTrue(logRepository.find(username).isEmpty());
}
```

í´ë˜ìŠ¤ ìœ„ì˜ ì£¼ì„ì„ í™•ì¸í•´ì„œ ëª¨ë“  ê³³ì— íŠ¸ëœì­ì…˜ì„ ì ìš©í•˜ì.

- `MemberService @Transactional: ON`
- `MemberRepository @Transactional: ON`
- `LogRepository @Transactional: ON`

ì—¬ê¸°ì„œëŠ” `ë¡œê·¸ì˜ˆì™¸` ë¼ê³  ë„˜ê²¼ê¸° ë•Œë¬¸ì— `LogRepository`ì—ì„œ ëŸ°íƒ€ì„ ì˜ˆì™¸ê°€ ë°œìƒí•œë‹¤.

**íë¦„**

![Untitled 14](https://github.com/soohyunnn/spring-db-2/assets/58289675/83ed8774-7ab1-4b8c-94bc-80c4377ec24d)

- í´ë¼ì´ì–¸íŠ¸Aê°€ `MemberService`ë¥¼ í˜¸ì¶œí•˜ë©´ì„œ íŠ¸ëœì­ì…˜ AOPê°€ í˜¸ì¶œëœë‹¤.
    - ì—¬ê¸°ì„œ ì‹ ê·œ íŠ¸ëœì­ì…˜ì´ ìƒì„±ë˜ê³ , ë¬¼ë¦¬ íŠ¸ëœì­ì…˜ë„ ì‹œì‘í•œë‹¤.
- `MemberRepository`ë¥¼ í˜¸ì¶œí•˜ë©´ì„œ íŠ¸ëœì­ì…˜ AOPê°€ í˜¸ì¶œëœë‹¤.
    - ì´ë¯¸ íŠ¸ëœì­ì…˜ì´ ìˆìœ¼ë¯€ë¡œ ê¸°ì¡´ íŠ¸ëœì­ì…˜ì— ì°¸ì—¬í•œë‹¤.
- `MemberRepository`ì˜ ë¡œì§ í˜¸ì¶œì´ ëë‚˜ê³  ì •ìƒ ì‘ë‹µí•˜ë©´ íŠ¸ëœì­ì…˜ AOPê°€ í˜¸ì¶œëœë‹¤.
    - íŠ¸ëœì­ì…˜ AOPëŠ” ì •ì£ ì‘ë‹µì´ë¯€ë¡œ íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì €ì— ì»¤ë°‹ì„ ìš”ì²­í•œë‹¤. ì´ ê²½ìš° ì‹ ê·œ íŠ¸ëœì­ì…˜ì´ ì•„ë‹ˆë¯€ë¡œ ì‹¤ì œ ì»¤ë°‹ì„ í˜¸ì¶œí•˜ì§€ ì•ŠëŠ”ë‹¤.
- `LogRepository`ë¥¼ í˜¸ì¶œí•˜ë©´ì„œ íŠ¸ëœì­ì…˜ AOPê°€ í˜¸ì¶œëœë‹¤.
    - ì´ë¯¸ íŠ¸ëœì­ì…˜ì´ ìˆìœ¼ë¯€ë¡œ ê¸°ì¡´ íŠ¸ëœì­ì…˜ì— ì°¸ì—¬í•œë‹¤.
- `LogRepository` ë¡œì§ì—ì„œ ëŸ°íƒ€ì„ ì˜ˆì™¸ê°€ ë°œìƒí•œë‹¤. ì˜ˆì™¸ë¥¼ ë˜ì§€ë©´ íŠ¸ëœì­ì…˜ AOPê°€ í•´ë‹¹ ì˜ˆì™¸ë¥¼ ë°›ê²Œëœë‹¤.
    - íŠ¸ëœì­ì…˜ AOPëŠ” ëŸ°íƒ€ì„ ì˜ˆì™¸ê°€ ë°œìƒí–ˆìœ¼ë¯€ë¡œ íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì €ì— ë¡¤ë°±ì„ ìš”ì²­í•œë‹¤. ì´ ê²½ìš° ì‹ ê·œ íŠ¸ëœì­ì…˜ì´ ì•„ë‹ˆë¯€ë¡œ ë¬¼ë¦¬ ë¡¤ë°±ì„ í˜¸ì¶œí•˜ì§€ëŠ” ì•ŠëŠ”ë‹¤. ëŒ€ì‹ ì— `rollbackOnly`ë¥¼ ì„¤ì •í•œë‹¤.
    - `LogRepository`ê°€ ì˜ˆì™¸ë¥¼ ë˜ì¡Œê¸° ë•Œë¬¸ì— íŠ¸ëœì­ì…˜ AOPë„ í•´ë‹¹ ì˜ˆì™¸ë¥¼ ê·¸ëŒ€ë¡œ ë°–ìœ¼ë¡œ ë˜ì§„ë‹¤.
- `MemberService`ì—ì„œë„ ëŸ°íƒ€ì„ ì˜ˆì™¸ë¥¼ ë°›ê²Œ ë˜ëŠ”ë°, ì—¬ê¸° ë¡œì§ì—ì„œëŠ” í•´ë‹¹ ëŸ°íƒ€ì„ ì˜ˆì™¸ë¥¼ ì²˜ë¦¬í•˜ì§€ ì•Šê³  ë°–ìœ¼ë¡œ ë˜ì§„ë‹¤.
    - íŠ¸ëœì­ì…˜ AOPëŠ” ëŸ°íƒ€ì„ ì˜ˆì™¸ê°€ ë°œìƒí–ˆìœ¼ë¯€ë¡œ íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì €ì— ë¡¤ë°±ì„ ìš”ì²­í•œë‹¤. ì´ ê²½ìš° ì‹ ê·œ íŠ¸ëœì­ì…˜ì´ë¯€ë¡œ ë¬¼ë¦¬ ë¡¤ë°±ì„ í˜¸ì¶œí•œë‹¤.
    - ì°¸ê³ ë¡œ ì´ ê²½ìš° ì–´ì°¨í”¼ ë¡¤ë°±ì´ ë˜ì—ˆê¸° ë•Œë¬¸ì—, `rollbackOnly` ì„¤ì •ì€ ì°¸ê³ í•˜ì§€ ì•ŠëŠ”ë‹¤.
    - `MemberService`ê°€ ì˜ˆì™¸ë¥¼ ë˜ì¡Œê¸° ë•Œë¬¸ì— íŠ¸ëœì­ì…˜ AOPë„ í•´ë‹¹ ì˜ˆì™¸ë¥¼ ê·¸ëŒ€ë¡œ ë°–ìœ¼ë¡œ ë˜ì§„ë‹¤.
- í´ë¼ì´ì–¸íŠ¸AëŠ” `LogRepository`ë¶€í„° ë„˜ì–´ì˜¨ ëŸ°íƒ€ì„ ì˜ˆì™¸ë¥¼ ë°›ê²Œ ëœë‹¤.

**ğŸ’¡Â ì •ë¦¬**

íšŒì›ê³¼ íšŒì› ì´ë ¥ ë¡œê·¸ë¥¼ ì²˜ë¦¬í•˜ëŠ” ë¶€ë¶„ì„ í•˜ë‚˜ì˜ íŠ¸ëœì­ì…˜ìœ¼ë¡œ ë¬¶ì€ ë•ë¶„ì— ë¬¸ì œê°€ ë°œìƒí–ˆì„ ë•Œ íšŒì›ê³¼ íšŒì› ì´ë ¥ ë¡œê·¸ê°€ ëª¨ë‘ í•¨ê»˜ ë¡¤ë°±ëœë‹¤. ë”°ë¼ì„œ ë°ì´í„° ì •í•©ì„±ì— ë¬¸ì œê°€ ë°œìƒí•˜ì§€ ì•ŠëŠ”ë‹¤.

## íŠ¸ëœì­ì…˜ ì „íŒŒ í™œìš© 6 - ë³µêµ¬ REQUIRED

ì•ì—ì„œ íšŒì›ê³¼ ë¡œê·¸ë¥¼ í•˜ë‚˜ì˜ íŠ¸ëœì­ì…˜ìœ¼ë¡œ ë¬¶ì–´ì„œ ë°ì´í„° ì •í•©ì„± ë¬¸ì œë¥¼ ê¹”ë”í•˜ê²Œ í•´ê²°í–ˆë‹¤. ê·¸ëŸ°ë° íšŒì› ì´ë ¥ ë¡œê·¸ë¥¼ DBì— ë‚¨ê¸°ëŠ” ì‘ì—…ì— ê°€ë” ë¬¸ì œê°€ ë°œìƒí•´ì„œ íšŒì› ê°€ì… ìì²´ê°€ ì•ˆë˜ëŠ” ê²½ìš°ê°€ ê°€ë” ë°œìƒí•˜ê²Œ ë˜ì—ˆë‹¤. ê·¸ë˜ì„œ ì‚¬ìš©ìë“¤ì´ íšŒì› ê°€ì…ì— ì‹¤íŒ¨í•´ì„œ ì´íƒˆí•˜ëŠ” ë¬¸ì œê°€ ë°œìƒí•˜ê¸° ì‹œì‘í–ˆë‹¤.

íšŒì› ì´ë ¥ ë¡œê·¸ì˜ ê²½ìš° ì—¬ëŸ¬ê°€ì§€ ë°©ë²•ìœ¼ë¡œ ì¶”í›„ì— ë³µêµ¬ê°€ ê°€ëŠ¥í•  ê²ƒìœ¼ë¡œ ë³´ì¸ë‹¤.

ê·¸ë˜ì„œ ë¹„ì¦ˆë‹ˆìŠ¤ ìš”êµ¬ì‚¬í•­ì´ ë³€ê²½ë˜ì—ˆë‹¤.

**íšŒì› ê°€ì…ì„ ì‹œë„í•œ ë¡œê·¸ë¥¼ ë‚¨ê¸°ëŠ”ë° ì‹¤íŒ¨í•˜ë”ë¼ë„ íšŒì› ê°€ì…ì€ ìœ ì§€ë˜ì–´ì•¼ í•œë‹¤.**

![Untitled 15](https://github.com/soohyunnn/spring-db-2/assets/58289675/4e8440b3-b255-46b0-bccd-f8480db348c0)

- ë‹¨ìˆœí•˜ê²Œ ìƒê°í•´ë³´ë©´ LogRepositoryì—ì„œ ì˜ˆì™¸ê°€ ë°œìƒí•˜ë©´ ê·¸ê²ƒì„ MemberServiceì—ì„œ ì˜ˆì™¸ë¥¼ ì¡ì•„ì„œ ì²˜ë¦¬í•˜ë©´ ë  ê²ƒ ê°™ë‹¤.
- ì´ë ‡ê²Œ í•˜ë©´ MemberServiceì—ì„œ ì •ìƒ íë¦„ìœ¼ë¡œ ë°”ê¿€ ìˆ˜ ìˆê¸° ë•Œë¬¸ì— MemberServiceì˜ íŠ¸ëœì­ì…˜ AOPì—ì„œ ì»¤ë°‹ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆë‹¤.
- ì´ ë°©ë²•ì€ ì‹¤íŒ¨í•œë‹¤.

ì´ ë°©ë²•ì´ ì™œ ì‹¤íŒ¨í–ˆëŠ”ì§€ ì˜ˆì œë¥¼ í†µí•´ì„œ ì•Œì•„ë³´ì. ì°¸ê³ ë¡œ ì‹¤ë¬´ì—ì„œ ë§ì€ ê°œë°œìê°€ ì´ ë°©ë²•ì„ ì‚¬ìš©í•´ì„œ ì‹¤íŒ¨í•œë‹¤.

**recoverException_fail**

```java
/**
 * MemberService @Transactional: ON
 * MemberRepository @Transactional: ON
 * LogRepository @Transactional: ON Exception
 */
@Test
void recoverException_fail() {
    //given
    String username = "ë¡œê·¸ì˜ˆì™¸_recoverException_fail";

    //when
    assertThatThrownBy(() -> memberService.joinV2(username))
            .isInstanceOf(UnexpectedRollbackException.class);

    //then: ëª¨ë“  ë°ì´í„°ê°€ ë¡¤ë°±ëœë‹¤.
    assertTrue(memberRepository.find(username).isEmpty());
    assertTrue(logRepository.find(username).isEmpty());
}
```

**ëª¨ë“  íŠ¸ëœì­ì…˜ì„ ì¼œì**

- `MemberService @Transactional: ON`
- `MemberRepository @Transactional: ON`
- `LogRepository @Transactional: ON`

**ì—¬ê¸°ì„œ memberService.joinV2()ë¥¼ í˜¸ì¶œí•˜ëŠ” ë¶€ë¶„ì„ ì£¼ì˜í•´ì•¼ í•œë‹¤. joinV2()ì—ëŠ” ì˜ˆì™¸ë¥¼ ì¡ì•„ì„œ ì •ìƒ íë¦„ìœ¼ë¡œ ë³€í™˜í•˜ëŠ” ë¡œì§ì´ ì¶”ê°€ë˜ì–´ ìˆë‹¤.**

```java
try {
    logRepository.save(logMessage);
} catch (RuntimeException e) {
    log.info("log ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹¤. logMessage={}", logMessage.getMessage());
    log.info("ì •ìƒ íë¦„ ë³€í™˜");
}
```

![Untitled 16](https://github.com/soohyunnn/spring-db-2/assets/58289675/a11c1cb6-0ba5-4e0c-9de4-ede918d2c63e)

- ë‚´ë¶€ íŠ¸ëœì­ì…˜ì—ì„œ `rollbackOnly`ë¥¼ ì„¤ì •í•˜ê¸° ë•Œë¬¸ì— ê²°ê³¼ì ìœ¼ë¡œ ì •ìƒ íë¦„ ì²˜ë¦¬ë¥¼ í•´ì„œ ì™¸ë¶€ íŠ¸ëœì­ì…˜ì—ì„œ ì»¤ë°‹ì„ í˜¸ì¶œí•´ë„ ë¬¼ë¦¬ íŠ¸ëœì­ì…˜ì€ ë¡¤ë°±ëœë‹¤.
- ê·¸ë¦¬ê³  `UnexpectedRollbackException`ì´ ë˜ì ¸ì§„ë‹¤.

ì „ì²´ íë¦„ì„ ì¢€ ë” ìì„¸íˆ ì•Œì•„ë³´ì.

![Untitled 17](https://github.com/soohyunnn/spring-db-2/assets/58289675/2e62d0f2-5be8-4683-938f-c6d27550b59d)

- `LogRepository`ì—ì„œ ì˜ˆì™¸ê°€ ë°œìƒí•œë‹¤. ì˜ˆì™¸ë¥¼ ë˜ì§€ë©´ `LogRepository`ì˜ íŠ¸ëœì­ì…˜ AOPê°€ í•´ë‹¹ ì˜ˆì™¸ë¥¼ ë°›ëŠ”ë‹¤.
- ì‹ ê·œ íŠ¸ëœì­ì…˜ì´ ì•„ë‹ˆë¯€ë¡œ ë¬¼ë¦¬ íŠ¸ëœì­ì…˜ì„ ë¡¤ë°±í•˜ì§€ëŠ” ì•Šê³ , íŠ¸ëœì­ì…˜ ë™ê¸°í™” ë§¤ë‹ˆì €ì— `rollbackOnly`ë¥¼ í‘œì‹œí•œë‹¤.
- ì´í›„ íŠ¸ëœì­ì…˜ AOPëŠ” ì „ë‹¬ ë°›ì€ ì˜ˆì™¸ë¥¼ ë°–ìœ¼ë¡œ ë˜ì§„ë‹¤.
- ì˜ˆì™¸ê°€ `MemberService`ì— ë˜ì ¸ì§€ê³ , `MemberService`ëŠ” í•´ë‹¹ ì˜ˆì™¸ë¥¼ ë³µêµ¬í•œë‹¤. ê·¸ë¦¬ê³  ì •ìƒì ìœ¼ë¡œ ë¦¬í„´í•œë‹¤.

- ì •ìƒ íë¦„ì´ ë˜ì—ˆìœ¼ë¯€ë¡œ `MemberService`ì˜ íŠ¸ëœì­ì…˜ AOPëŠ” ì»¤ë°‹ì„ í˜¸ì¶œí•œë‹¤.
- ì»¤ë°‹ì„ í˜¸ì¶œí•  ë•Œ ì‹ ê·œ íŠ¸ëœì­ì…˜ì´ë¯€ë¡œ ì‹¤ì œ ë¬¼ë¦¬ íŠ¸ëœì­ì…˜ì„ ì»¤ë°‹í•´ì•¼ í•œë‹¤. ì´ë•Œ `rollbackOnly`ë¥¼ ì²´í¬í•œë‹¤.
- `rollbackOnly`ê°€ ì²´í¬ ë˜ì–´ ìˆìœ¼ë¯€ë¡œ ë¬¼ë¦¬ íŠ¸ëœì­ì…˜ì„ ë¡¤ë°±í•œë‹¤.
- íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì €ëŠ” `UnexpectedRollbackException` ì˜ˆì™¸ë¥¼ ë˜ì§„ë‹¤.
- íŠ¸ëœì­ì…˜ AOPë„ ì „ë‹¬ë°›ì€ `UnexpectedRollbackException`ì„ í´ë¼ì´ì–¸íŠ¸ì— ë˜ì§„ë‹¤.

**ğŸ’¡Â ì •ë¦¬**

- ë…¼ë¦¬ íŠ¸ëœì­ì…˜ ì¤‘ í•˜ë‚˜ë¼ë„ ë¡¤ë°±ë˜ë©´ ì „ì²´ íŠ¸ëœì­ì…˜ì€ ë¡¤ë°±ëœë‹¤.
- ë‚´ë¶€ íŠ¸ëœì­ì…˜ì´ ë¡¤ë°± ë˜ì—ˆëŠ”ë°, ì™¸ë¶€ íŠ¸ëœì­ì…˜ì´ ì»¤ë°‹ë˜ë©´ `UnexpectedRollbackException` ì˜ˆì™¸ê°€ ë°œìƒí•œë‹¤.
- `rollbackOnly` ìƒí™©ì—ì„œ ì»¤ë°‹ì´ ë°œìƒí•˜ë©´ `UnexpectedRollbackException` ì˜ˆì™¸ê°€ ë°œìƒí•œë‹¤.

ê·¸ë ‡ë‹¤ë©´ ì–´ë–»ê²Œ í•´ì•¼ ë‹¤ìŒ ìš”êµ¬ì‚¬í•­ì„ ë§Œì¡±í•  ìˆ˜ ìˆì„ê¹Œ?

íšŒì› ê°€ì…ì„ ì‹œë„í•œ ë¡œê·¸ë¥¼ ë‚¨ê¸°ëŠ”ë° ì‹¤íŒ¨í•˜ë”ë¼ë„ íšŒì› ê°€ì…ì€ ìœ ì§€ë˜ì–´ì•¼ í•œë‹¤.

## íŠ¸ëœì­ì…˜ ì „íŒŒ í™œìš© 7 - ë³µêµ¬ REQUIRES_NEW

**íšŒì› ê°€ì…ì„ ì‹œë„í•œ ë¡œê·¸ë¥¼ ë‚¨ê¸°ëŠ”ë° ì‹¤íŒ¨í•˜ë”ë¼ë„ íšŒì› ê°€ì…ì€ ìœ ì§€ë˜ì–´ì•¼ í•œë‹¤.**

ì´ ìš”êµ¬ì‚¬í•­ì„ ë§Œì¡±í•˜ê¸° ìœ„í•´ì„œ ë¡œê·¸ì™€ ê´€ë ¨ëœ ë¬¼ë¦¬ íŠ¸ëœì­ì…˜ì„ ë³„ë„ë¡œ ë¶„ë¦¬í•´ë³´ì. ë°”ë¡œ `REQUIRES_NEW`ë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ë‹¤.

**recoverException_success**

```java
/**
 * MemberService @Transactional: ON
 * MemberRepository @Transactional: ON
 * LogRepository @Transactional(REQUIRES_NEW) Exception
 */
@Test
void recoverException_success() {
    //given
    String username = "ë¡œê·¸ì˜ˆì™¸_recoverException_success";

    //when
    memberService.joinV2(username);

    //then: member ì €ì¥, log ë¡¤ë°±
    assertTrue(memberRepository.find(username).isPresent());
    assertTrue(logRepository.find(username).isEmpty());
}
```

- `MemberService @Transactional: ON`
- `MemberRepository @Transactional: ON`
- `LogRepository @Transactional(REQUIRES_NEW) Exception`

**LogRepository - save()**

```java
**@Transactional(propagation = Propagation.REQUIRES_NEW)**
public void save(Log logMessage) {
    log.info("log ì €ì¥");
    em.persist(logMessage);

    if (logMessage.getMessage().contains("ë¡œê·¸ì˜ˆì™¸")) {
        log.info("log ì €ì¥ì‹œ ì˜ˆì™¸ ë°œìƒ");
        throw new RuntimeException("ë¡œê·¸ì˜ˆì™¸");
    }
}
```

ì´ë ‡ê²Œ í•´ì„œ ê¸°ì¡´ íŠ¸ëœì­ì…˜ì— ì°¸ì—¬í•˜ëŠ” `REAUIRED` ëŒ€ì‹ ì—, í•­ìƒ ì‹ ê·œ íŠ¸ëœì­ì…˜ì„ ìƒì„±í•˜ëŠ” `REQUIRES_NEW`ë¥¼ ì ìš©í•˜ì.

**ì˜ˆì™¸ë¥¼ ë³µêµ¬í•˜ëŠ” memberService.joinV2()ë¥¼ ì‚¬ìš©í•œë‹¤ëŠ” ì ë„ ì£¼ì˜í•˜ì**

**REQUIRES_NEW - ë¬¼ë¦¬ íŠ¸ëœì­ì…˜ ë¶„ë¦¬**

![Untitled 18](https://github.com/soohyunnn/spring-db-2/assets/58289675/8b3b89ec-f562-45e9-b4fe-432143f73b98)

- `MemberRepository`ëŠ” `REQUIRED` ì˜µì…˜ì„ ì‚¬ìš©í•œë‹¤. ë”°ë¼ì„œ ê¸°ì¡´ íŠ¸ëœì­ì…˜ì— ì°¸ì—¬í•œë‹¤.
- `LogRepository`ì˜ íŠ¸ëœì­ì…˜ ì˜µì…˜ì— `REQUIRES_NEW`ë¥¼ ì‚¬ìš©í–ˆë‹¤.
- `REQUIRES_NEW`ëŠ” í•­ìƒ ìƒˆë¡œìš´ íŠ¸ëœì­ì…˜ì„ ë§Œë“ ë‹¤. ë”°ë¼ì„œ í•´ë‹¹ íŠ¸ëœì­ì…˜ ì•ˆì—ì„œëŠ” DB ì»¤ë„¥ì…˜ë„ ë³„ë„ë¡œ ì‚¬ìš©í•˜ê²Œ ëœë‹¤.

**REQUIRES_NEW - ë³µêµ¬**

![Untitled 19](https://github.com/soohyunnn/spring-db-2/assets/58289675/09b43cd7-dfe2-406c-83ae-722d92caa486)

- `REQUIRES_NEW`ë¥¼ ì‚¬ìš©í•˜ê²Œ ë˜ë©´ ë¬¼ë¦¬ íŠ¸ëœì­ì…˜ ìì²´ê°€ ì™„ì „íˆ ë¶„ë¦¬ë˜ì–´ ë²„ë¦°ë‹¤.
- ê·¸ë¦¬ê³  `REQUIRES_NEW`ëŠ” ì‹ ê·œ íŠ¸ëœì­ì…˜ì´ë¯€ë¡œ `rollbackOnly` í‘œì‹œê°€ ë˜ì§€ ì•ŠëŠ”ë‹¤. ê·¸ëƒ¥ í•´ë‹¹ íŠ¸ëœì­ì…˜ì´ ë¬¼ë¦¬ ë¡¤ë°±ë˜ê³  ëë‚œë‹¤.

**REQUIRES_NEW - ìì„¸íˆ**

![Untitled 20](https://github.com/soohyunnn/spring-db-2/assets/58289675/93fa68ee-ea02-44dd-ab23-e4fcc937a4e1)

- `LogRepository`ì—ì„œ ì˜ˆì™¸ê°€ ë°œìƒí•œë‹¤. ì˜ˆì™¸ë¥¼ ë˜ì§€ë©´ `LogRepository`ì˜ íŠ¸ëœì­ì…˜ AOPê°€ í•´ë‹¹ ì˜ˆì™¸ë¥¼ ë°›ëŠ”ë‹¤.
- `REQUIRES_NEW`ë¥¼ ì‚¬ìš©í•œ ì‹ ê·œ íŠ¸ëœì­ì…˜ì´ë¯€ë¡œ ë¬¼ë¦¬ íŠ¸ëœì­ì…˜ì„ ë¡¤ë°±í•œë‹¤. ë¬¼ë¦¬ íŠ¸ëœì­ì…˜ì„ ë¡¤ë°±í–ˆìœ¼ë¯€ë¡œ `rollbackOnly`ë¥¼ í‘œì‹œí•˜ì§€ ì•ŠëŠ”ë‹¤. ì—¬ê¸°ì„œ `REQUIRES_NEW`ë¥¼ ì‚¬ìš©í•œ ë¬¼ë¦¬ íŠ¸ëœì­ì…˜ì€ ë¡¤ë°±ë˜ê³  ì™„ì „íˆ ëì´ ë‚˜ë²„ë¦°ë‹¤.
- ì´í›„ íŠ¸ëœì­ì…˜ AOPëŠ” ì „ë‹¬ ë°›ì€ ì˜ˆì™¸ë¥¼ ë°–ìœ¼ë¡œ ë˜ì§„ë‹¤.
- ì˜ˆì™¸ê°€ `MemberService`ì— ë˜ì ¸ì§€ê³ , `MemberService`ëŠ” í•´ë‹¹ ì˜ˆì™¸ë¥¼ ë³µêµ¬í•œë‹¤. ê·¸ë¦¬ê³  ì •ìƒì ìœ¼ë¡œ ë¦¬í„´í•œë‹¤.
- ì •ìƒ íë¦„ì´ ë˜ì—ˆìœ¼ë¯€ë¡œ `MemberService`ì˜ íŠ¸ëœì­ì…˜ AOPëŠ” ì»¤ë°‹ì„ í˜¸ì¶œí•œë‹¤.
- ì»¤ë°‹ì„ í˜¸ì¶œí•  ë•Œ ì‹ ê·œ íŠ¸ëœì­ì…˜ì´ë¯€ë¡œ ì‹¤ì œ ë¬¼ë¦¬ íŠ¸ëœì­ì…˜ì„ ì»¤ë°‹í•´ì•¼ í•œë‹¤. ì´ë•Œ `rollbackOnly`ë¥¼ ì²´í¬í•œë‹¤.
- `rollbackOnly`ê°€ ì—†ìœ¼ë¯€ë¡œ ë¬¼ë¦¬ íŠ¸ëœì­ì…˜ì„ ì»¤ë°‹í•œë‹¤.
- ì´í›„ ì •ìƒ íë¦„ì´ ë°˜í™˜ëœë‹¤.

ê²°ê³¼ì ìœ¼ë¡œ íšŒì› ë°ì´í„°ëŠ” ì €ì¥ë˜ê³ , ë¡œê·¸ ë°ì´í„°ë§Œ ë¡¤ë°± ë˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

**ğŸ’¡Â ì •ë¦¬**

- ë…¼ë¦¬ íŠ¸ëœì­ì…˜ì€ í•˜ë‚˜ë¼ë„ ë¡¤ë°±ë˜ë©´ ê´€ë ¨ëœ ë¬¼ë¦¬ íŠ¸ëœì­ì…˜ì€ ë¡¤ë°±ë˜ì–´ ë²„ë¦°ë‹¤.
- ì´ ë¬¸ì œë¥¼ í•´ê²°í•˜ë ¤ë©´ `REQUIRES_NEW`ë¥¼ ì‚¬ìš©í•´ì„œ íŠ¸ëœì­ì…˜ì„ ë¶„ë¦¬í•´ì•¼ í•œë‹¤.
- ì°¸ê³ ë¡œ ì˜ˆì œë¥¼ ë‹¨ìˆœí™” í•˜ê¸° ìœ„í•´ `MemberService`ê°€ `MemberRepository`, `LogRepository`ë§Œ í˜¸ì¶œí•˜ì§€ë§Œ ì‹¤ì œë¡œëŠ” ë” ë§ì€ ë¦¬í¬ì§€í† ë¦¬ë“¤ì„ í˜¸ì¶œí•˜ê³  ê·¸ ì¤‘ì— `LogRepository`ë§Œ íŠ¸ëœì­ì…˜ì„ ë¶„ë¦¬í•œë‹¤ê³  ìƒê°í•´ë³´ë©´ ì´í•´í•˜ëŠ”ë° ë„ì›€ì´ ë  ê²ƒì´ë‹¤.

**âš ï¸Â ì£¼ì˜**

- `REQUIRES_NEW`ë¥¼ ì‚¬ìš©í•˜ë©´ í•˜ë‚˜ì˜ HTTP ìš”ì²­ì— ë™ì‹œì— 2ê°œì˜ ë°ì´í„°ë² ì´ìŠ¤ ì»¤ë„¥ì…˜ì„ ì‚¬ìš©í•˜ê²Œ ëœë‹¤.
    
    ë”°ë¼ì„œ ì„±ëŠ¥ì´ ì¤‘ìš”í•œ ê³³ì—ì„œëŠ” ì´ëŸ° ë¶€ë¶„ì„ ì£¼ì˜í•´ì„œ ì‚¬ìš©í•´ì•¼ í•œë‹¤.
    
- `REQUIRES_NEW`ë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šê³  ë¬¸ì œë¥¼ í•´ê²°í•  ìˆ˜ ìˆëŠ” ë‹¨ìˆœí•œ ë°©ë²•ì´ ìˆë‹¤ë©´, ê·¸ ë°©ë²•ì„ ì„ íƒí•˜ëŠ” ê²ƒì´ ë” ì¢‹ë‹¤.

ì˜ˆë¥¼ ë“¤ë©´ ë‹¤ìŒê³¼ ê°™ì´ `REQUIRES_NEW`ë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šê³  êµ¬ì¡°ë¥¼ ë³€ê²½í•˜ëŠ” ê²ƒì´ë‹¤.

![Untitled 21](https://github.com/soohyunnn/spring-db-2/assets/58289675/205bab89-8797-4c08-8650-1be862807398)

ì´ë ‡ê²Œ í•˜ë©´ HTTP ìš”ì²­ì— ë™ì‹œì— 2ê°œì˜ ì»¤ë„¥ì…˜ì„ ì‚¬ìš©í•˜ì§€ëŠ” ì•ŠëŠ”ë‹¤. ìˆœì°¨ì ìœ¼ë¡œ ì‚¬ìš©í•˜ê³  ë°˜í™˜í•˜ê²Œ ëœë‹¤.

ë¬¼ë¡  êµ¬ì¡°ìƒ `REQUIRES_NEW`ë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ë” ê¹”ë”í•œ ê²½ìš°ë„ ìˆìœ¼ë¯€ë¡œ ê°ê°ì˜ ì¥ë‹¨ì ì„ ì´í•´í•˜ê³  ì ì ˆí•˜ê²Œ ì„ íƒí•´ì„œ ì‚¬ìš©í•˜ë©´ ëœë‹¤.