# ìŠ¤í”„ë§ íŠ¸ëœì­ì…˜ ì´í•´

## ìŠ¤í”„ë§ íŠ¸ëœì­ì…˜ ì†Œê°œ

ì´ë²ˆ ì‹œê°„ì—ëŠ” ìŠ¤í”„ë§ íŠ¸ëœì­ì…˜ì„ ë” ê¹Šì´ ìˆê²Œ í•™ìŠµí•˜ê³ , ë˜ ìŠ¤í”„ë§ íŠ¸ëœì­ì…˜ì´ ì œê³µí•˜ëŠ” ë‹¤ì–‘í•œ ê¸°ëŠ¥ë“¤ì„ ìì„¸íˆ ì•Œì•„ë³´ì.

### ìŠ¤í”„ë§ íŠ¸ëœì­ì…˜ ì¶”ìƒí™”

ê°ê°ì˜ ë°ì´í„° ì ‘ê·¼ ê¸°ìˆ ë“¤ì€ íŠ¸ëœì­ì…˜ì„ ì²˜ë¦¬í•˜ëŠ” ë°©ì‹ì— ì°¨ì´ê°€ ìˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´ JDBC ê¸°ìˆ ê³¼ JPA ê¸°ìˆ ì€ íŠ¸ëœì­ì…˜ì„ ì‚¬ìš©í•˜ëŠ” ì½”ë“œ ìì²´ê°€ ë‹¤ë¥´ë‹¤.

**JDBC íŠ¸ëœì­ì…˜ ì½”ë“œ ì˜ˆì‹œ**

```java
public void accountTransfer(String fromId, String toId, int money) throws
  SQLException {

      Connection con = dataSource.getConnection();
      try {
				con.setAutoCommit(false); //íŠ¸ëœì­ì…˜ ì‹œì‘ //ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§
				bizLogic(con, fromId, toId, money);
				con.commit(); //ì„±ê³µì‹œ ì»¤ë°‹ } 
			catch (Exception e) {
				con.rollback(); //ì‹¤íŒ¨ì‹œ ë¡¤ë°±
          throw new IllegalStateException(e);
      } finally {
          release(con);
      }

}
```

**JPA íŠ¸ëœì­ì…˜ ì½”ë“œ ì˜ˆì‹œ**

```java
public static void main(String[] args) {

		//ì—”í‹°í‹° ë§¤ë‹ˆì € íŒ©í† ë¦¬ ìƒì„±
		EntityManagerFactory emf = Persistence.createEntityManagerFactory("jpabook");
		EntityManager em = emf.createEntityManager(); 
		//ì—”í‹°í‹° ë§¤ë‹ˆì € ìƒì„± 
		EntityTransaction tx = em.getTransaction(); //íŠ¸ëœì­ì…˜ ê¸°ëŠ¥ íšë“

		try {
				tx.begin(); //íŠ¸ëœì­ì…˜ ì‹œì‘ 
				logic(em); //ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ 
				tx.commit();//íŠ¸ëœì­ì…˜ ì»¤ë°‹
		} catch (Exception e) { 
				tx.rollback(); //íŠ¸ëœì­ì…˜ ë¡¤ë°±
		} finally {
				em.close(); //ì—”í‹°í‹° ë§¤ë‹ˆì € ì¢…ë£Œ
		}
		emf.close(); //ì—”í‹°í‹° ë§¤ë‹ˆì € íŒ©í† ë¦¬ ì¢…ë£Œ

}
```

ë”°ë¼ì„œ JDBC ê¸°ìˆ ì„ ì‚¬ìš©í•˜ë‹¤ê°€ JPA ê¸°ìˆ ë¡œ ë³€ê²½í•˜ê²Œ ë˜ë©´ íŠ¸ëœì­ì…˜ì„ ì‚¬ìš©í•˜ëŠ” ì½”ë“œë„ ëª¨ë‘ í•¨ê»˜ ë³€ê²½í•´ì•¼ í•œë‹¤.

ìŠ¤í”„ë§ì€ ì´ëŸ° ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ íŠ¸ëœì­ì…˜ ì¶”ìƒí™”ë¥¼ ì œê³µí•œë‹¤. íŠ¸ëœì­ì…˜ì„ ì‚¬ìš©í•˜ëŠ” ì…ì¥ì—ì„œëŠ” ìŠ¤í”„ë§ íŠ¸ëœì­ì…˜ ì¶”ìƒí™”ë¥¼ í†µí•´ ë‘˜ì„ ë™ì¼í•œ ë°©ì‹ìœ¼ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆê²Œ ë˜ëŠ” ê²ƒì´ë‹¤.

ìŠ¤í”„ë§ì€ PlatformTransactionManagerë¼ëŠ” ì¸í„°í˜ì´ìŠ¤ë¥¼ í†µí•´ íŠ¸ëœì­ì…˜ì„ ì¶”ìƒí™”í•œë‹¤.

**PlatformTransactionManager ì¸í„°í˜ì´ìŠ¤**

```java
package org.springframework.transaction;

public interface PlatformTransactionManager extends TransactionManager {

  TransactionStatus getTransaction(@Nullable TransactionDefinition definition)
          throws TransactionException;

  void commit(TransactionStatus status) throws TransactionException;
  void rollback(TransactionStatus status) throws TransactionException;

}
```

- íŠ¸ëœì­ì…˜ì€ íŠ¸ëœì­ì…˜ ì‹œì‘(íšë“), ì»¤ë°‹, ë¡¤ë°±ìœ¼ë¡œ ë‹¨ìˆœí•˜ê²Œ ì¶”ìƒí™” í•  ìˆ˜ ìˆë‹¤.

![Untitled](https://github.com/soohyunnn/spring-db-2/assets/58289675/d5944347-32b7-4870-b2bb-30b988412629)

- ìŠ¤í”„ë§ì€ íŠ¸ëœì­ì…˜ì„ ì¶”ìƒí™”í•´ì„œ ì œê³µí•  ë¿ë§Œ ì•„ë‹ˆë¼, ì‹¤ë¬´ì—ì„œ ì£¼ë¡œ ì‚¬ìš©í•˜ëŠ” ë°ì´í„° ì ‘ê·¼ ê¸°ìˆ ì— ëŒ€í•œ íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì €ì˜ êµ¬í˜„ì²´ë„ ì œê³µí•œë‹¤. ìš°ë¦¬ëŠ” í•„ìš”í•œ êµ¬í˜„ì²´ë¥¼ ìŠ¤í”„ë§ ë¹ˆìœ¼ë¡œ ë“±ë¡í•˜ê³  ì£¼ì… ë°›ì•„ì„œ ì‚¬ìš©í•˜ê¸°ë§Œ í•˜ë©´ ëœë‹¤.
- ì—¬ê¸°ì— ë”í•´ì„œ ìŠ¤í”„ë§ ë¶€íŠ¸ëŠ” ì–´ë–¤ ë°ì´í„° ì ‘ê·¼ ê¸°ìˆ ì„ ì‚¬ìš©í•˜ëŠ”ì§€ë¥¼ ìë™ìœ¼ë¡œ ì¸ì‹í•´ì„œ ì ì ˆí•œ íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì €ë¥¼ ì„ íƒí•´ì„œ ìŠ¤í”„ë§ ë¹ˆìœ¼ë¡œ ë“±ë¡í•´ì£¼ê¸° ë•Œë¬¸ì— íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì €ë¥¼ ì„ íƒí•˜ê³  ë“±ë¡í•˜ëŠ” ê³¼ì •ë„ ìƒëµí•  ìˆ˜ ìˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´ì„œ `JdbcTemplate`, `MyBatis`ë¥¼ ì‚¬ìš©í•˜ë©´ `DataSourceTransactionManager(JdbcTransactionManager)`ë¥¼ ìŠ¤í”„ë§ ë¹ˆìœ¼ë¡œ ë“±ë¡í•˜ê³ , JPAë¥¼ ì‚¬ìš©í•˜ë©´ `JpaTransactionManager`ë¥¼ ìŠ¤í”„ë§ ë¹ˆìœ¼ë¡œ ë“±ë¡í•´ì¤€ë‹¤.

ğŸ’¡ì°¸ê³ 

ìŠ¤í”„ë§ 5.3ë¶€í„°ëŠ” JDBC íŠ¸ëœì­ì…˜ì„ ê´€ë¦¬í•  ë•Œ `DataSourceTransactionManager`ë¥¼ ìƒì†ë°›ì•„ì„œ ì•½ê°„ì˜ ê¸°ëŠ¥ì„ í™•ì¥í•œ `JdbcTransactionManager`ë¥¼ ì œê³µí•œë‹¤. ë‘˜ì˜ ê¸°ëŠ¥ ì°¨ì´ëŠ” í¬ì§€ ì•Šìœ¼ë¯€ë¡œ ê°™ì€ ê²ƒìœ¼ë¡œ ì´í•´í•˜ë©´ ëœë‹¤.

### ìŠ¤í”„ë§ íŠ¸ëœì­ì…˜ ì‚¬ìš© ë°©ì‹

`PlatformTransactionManager`ë¥¼ ì‚¬ìš©í•˜ëŠ” ë°©ë²•ì€ í¬ê²Œ 2ê°€ì§€ê°€ ìˆë‹¤.

**ì„ ì–¸ì  íŠ¸ëœì­ì…˜ ê´€ë¦¬ vs í”„ë¡œê·¸ë˜ë° ë°©ì‹ íŠ¸ëœì­ì…˜ ê´€ë¦¬**

- ì„ ì–¸ì  íŠ¸ëœì­ì…˜ ê´€ë¦¬(Declarative Transaction Management)
    - `@Transactional` ì–´ë…¸í…Œì´ì…˜ í•˜ë‚˜ë§Œ ì„ ì–¸í•´ì„œ ë§¤ìš° í¸ë¦¬í•˜ê²Œ íŠ¸ëœì­ì…˜ì„ ì ìš©í•˜ëŠ” ê²ƒì„ ì„ ì–¸ì  íŠ¸ëœì­ì…˜ ê´€ë¦¬ë¼ í•œë‹¤.
    - ì„ ì–¸ì  íŠ¸ëœì­ì…˜ ê´€ë¦¬ëŠ” ê³¼ê±° XMLì— ì„¤ì •í•˜ê¸°ë„ í–ˆë‹¤.
    - ì´ë¦„ ëŒ€ë¡œ í•´ë‹¹ ë¡œì§ì— íŠ¸ëœì­ì…˜ì„ ì ìš©í•˜ê² ë‹¤í•˜ê³  ì–´ë”˜ê°€ì— ì„ ì–¸í•˜ê¸°ë§Œ í•˜ë©´ íŠ¸ëœì­ì…˜ì´ ì ìš©ë˜ëŠ” ë°©ì‹ì´ë‹¤.
- í”„ë¡œê·¸ë˜ë° ë°©ì‹ì˜ íŠ¸ëœì­ì…˜ ê´€ë¦¬(programmatic transaction management)
    - íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì € ë˜ëŠ” íŠ¸ëœì­ì…˜ í…œí”Œë¦¿ ë“±ì„ ì‚¬ìš©í•´ì„œ íŠ¸ëœì­ì…˜ ê´€ë ¨ ì½”ë“œë¥¼ ì§ì ‘ ì‘ì„±í•˜ëŠ” ê²ƒì„ í”„ë¡œê·¸ë˜ë° ë°©ì‹ì˜ íŠ¸ëœì­ì…˜ ê´€ë¦¬ë¼ í•œë‹¤.

- í”„ë¡œê·¸ë˜ë° ë°©ì‹ì˜ íŠ¸ëœì­ì…˜ ê´€ë¦¬ë¥¼ ì‚¬ìš©í•˜ê²Œ ë˜ë©´, ì• í”Œë¦¬ì¼€ì´ì…˜ ì½”ë“œê°€ íŠ¸ëœì­ì…˜ì´ë¼ëŠ” ê¸°ìˆ  ì½”ë“œì™€ ê°•í•˜ê²Œ ê²°í•©ëœë‹¤.

### ì„ ì–¸ì  íŠ¸ëœì­ì…˜ê³¼ AOP

`@Transactional`ì„ í†µí•œ ì„ ì–¸ì  íŠ¸ëœì­ì…˜ ê´€ë¦¬ ë°©ì‹ì„ ì‚¬ìš©í•˜ê²Œ ë˜ë©´ ê¸°ë³¸ì ìœ¼ë¡œ í”„ë¡ì‹œ ë°©ì‹ì˜ AOPê°€ ì ìš©ëœë‹¤.

**í”„ë¡ì‹œ ë„ì… ì „**

![Untitled 1](https://github.com/soohyunnn/spring-db-2/assets/58289675/7e21fe6f-63a1-43ae-a008-7b3d0464226d)

íŠ¸ëœì­ì…˜ì„ ì²˜ë¦¬í•˜ê¸° ìœ„í•œ í”„ë¡ì‹œë¥¼ ë„ì…í•˜ê¸° ì „ì—ëŠ” ì„œë¹„ìŠ¤ì˜ ë¡œì§ì—ì„œ íŠ¸ëœì­ì…˜ì„ ì§ì ‘ ì‹œì‘í–ˆë‹¤.

**ì„œë¹„ìŠ¤ ê³„ì¸µì˜ íŠ¸ëœì­ì…˜ ì‚¬ìš© ì½”ë“œ ì˜ˆì‹œ**

```java
//íŠ¸ëœì­ì…˜ ì‹œì‘
TransactionStatus status = transactionManager.getTransaction(new DefaultTransactionDefinition());

try {
		//ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§
		bizLogic(fromId, toId, money); 
		transactionManager.commit(status); //ì„±ê³µì‹œ ì»¤ë°‹
} catch (Exception e) { 
		transactionManager.rollback(status); //ì‹¤íŒ¨ì‹œ ë¡¤ë°±
		throw new IllegalStateException(e);
}
```

**í”„ë¡ì‹œ ë„ì… í›„**

![Untitled 2](https://github.com/soohyunnn/spring-db-2/assets/58289675/09e91ec0-eaaf-4d97-bee3-c111002e0187)

íŠ¸ëœì­ì…˜ì„ ì²˜ë¦¬í•˜ê¸° ìœ„í•œ í”„ë¡ì‹œë¥¼ ì ìš©í•˜ë©´ íŠ¸ëœì­ì…˜ì„ ì²˜ë¦¬í•˜ëŠ” ê°ì²´ì™€ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ì²˜ë¦¬í•˜ëŠ” ì„œë¹„ìŠ¤ ê³…ì²´ë¥¼ ëª…í™•í•˜ê²Œ ë¶„ë¦¬í•  ìˆ˜ ìˆë‹¤.

**íŠ¸ëœì­ì…˜ í”„ë¡ì‹œ ì½”ë“œ ì˜ˆì‹œ**

```java
public class TransactionProxy 

		private MemberService target;

		public void logic() { 
				//íŠ¸ëœì­ì…˜ ì‹œì‘
				TransactionStatus status = transactionManager.getTransaction(..);
				try {
					//ì‹¤ì œ ëŒ€ìƒ í˜¸ì¶œ target.logic();
					transactionManager.commit(status); //ì„±ê³µì‹œ ì»¤ë°‹
				catch (Exception e) {
					transactionManager.rollback(status); //ì‹¤íŒ¨ì‹œ ë¡¤ë°±
					throw new IllegalStateException(e);
				}
		} 

}
```

**íŠ¸ëœì­ì…˜ í”„ë¡ì‹œ ì ìš© í›„ ì„œë¹„ìŠ¤ ì½”ë“œ ì˜ˆì‹œ**

```java
public class Service {
      public void logic() {
					//íŠ¸ëœì­ì…˜ ê´€ë ¨ ì½”ë“œ ì œê±°, ìˆœìˆ˜ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ë§Œ ë‚¨ìŒ
          bizLogic(fromId, toId, money);
      }
}
```

- í”„ë¡ì‹œ ë„ì… ì „ : ì„œë¹„ìŠ¤ì— ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ê³¼ íŠ¸ëœì­ì…˜ ì²˜ë¦¬ ë¡œì§ì´ í•¨ê»˜ ì„ì—¬ìˆë‹¤.
- í”„ë¡ì‹œ ë„ì… í›„ : íŠ¸ëœì­ì…˜ í”„ë¡ì‹œê°€ íŠ¸ëœì­ì…˜ ì²˜ë¦¬ ë¡œì§ì„ ëª¨ë‘ ê°€ì ¸ê°„ë‹¤. ê·¸ë¦¬ê³  íŠ¸ëœì­ì…˜ì„ ì‹œì‘í•œ í›„ì— ì‹¤ì œ ì„œë¹„ìŠ¤ë¥¼ ëŒ€ì‹  í˜¸ì¶œí•œë‹¤. íŠ¸ëœì­ì…˜ í”„ë¡ì‹œ ë•ë¶„ì— ê³„ì¸µì—ëŠ” ìˆœìˆ˜í•œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ë§Œ ë‚¨ê¸¸ ìˆ˜ ìˆë‹¤.

### í”„ë¡ì‹œ ë„ì… í›„ ì „ì²´ ê³¼ì •

![Untitled 3](https://github.com/soohyunnn/spring-db-2/assets/58289675/90ce415a-1828-4f20-a0a7-1e98016b5ec8)

- íŠ¸ëœì­ì…˜ì€ ì»¤ë„¥ì…˜ì— `con.setAutocommit(false)`ë¥¼ ì§€ì •í•˜ë©´ì„œ ì‹œì‘í•œë‹¤.
- ê°™ì€ íŠ¸ëœì­ì…˜ì„ ìœ ì§€í•˜ë ¤ë©´ ê°™ì€ ë°ì´í„°ë² ì´ìŠ¤ ì»¤ë„¥ì…˜ì„ ì‚¬ìš©í•´ì•¼ í•œë‹¤.
- ì´ê²ƒì„ ìœ„í•´ ìŠ¤í”„ë§ ë‚´ë¶€ì—ì„œëŠ” íŠ¸ëœì­ì…˜ ë™ê¸°í™” ë§¤ë‹ˆì €ê°€ ì‚¬ìš©ëœë‹¤.
- `JdbcTemplate`ì„ í¬í•¨í•œ ëŒ€ë¶€ë¶„ì˜ ë°ì´í„° ì ‘ê·¼ ê¸°ìˆ ë“¤ì€ íŠ¸ëœì­ì…˜ì„ ìœ ì§€í•˜ê¸° ìœ„í•´ ë‚´ë¶€ì—ì„œ íŠ¸ëœì­ì…˜ ë™ê¸°í™” ë§¤ë‹ˆì €ë¥¼ í†µí•´ ë¦¬ì†ŒìŠ¤(ì»¤ë„¥ì…˜)ë¥¼ ë™ê¸°í™” í•œë‹¤.

### ìŠ¤í”„ë§ì´ ì œê³µí•˜ëŠ” íŠ¸ëœì­ì…˜ AOP

- ìŠ¤í”„ë§ì˜ íŠ¸ëœì­ì…˜ì€ ë§¤ìš° ì¤‘ìš”í•œ ê¸°ëŠ¥ì´ê³ , ì „ì„¸ê³„ ëˆ„êµ¬ë‚˜ ë‹¤ ì‚¬ìš©í•˜ëŠ” ê¸°ëŠ¥ì´ë‹¤. ìŠ¤í”„ë§ì€ íŠ¸ëœì­ì…˜ AOPë¥¼ ì²˜ë¦¬í•˜ê¸° ìœ„í•œ ëª¨ë“  ê¸°ëŠ¥ì„ ì œê³µí•œë‹¤. ìŠ¤í”„ë§ ë¶€íŠ¸ë¥¼ ì‚¬ìš©í•˜ë©´ íŠ¸ëœì­ì…˜ AOPë¥¼ ì²˜ë¦¬í•˜ê¸° ìœ„í•´ í•„ìš”í•œ ìŠ¤í”„ë§ ë¹ˆë“¤ë„ ìë™ìœ¼ë¡œ ë“±ë¡í•´ì¤€ë‹¤.
- ê°œë°œìëŠ” íŠ¸ëœì­ì…˜ ì²˜ë¦¬ê°€ í•„ìš”í•œ ê³³ì— `@Transactional` ì–´ë…¸í…Œì´ì…˜ë§Œ ë¶™ì—¬ì£¼ë©´ ëœë‹¤. ìŠ¤í”„ë§ì˜ íŠ¸ëœì­ì…˜ AOPëŠ” ì´ ì–´ë…¸í…Œì´ì…˜ì„ ì¸ì‹í•´ì„œ íŠ¸ëœì­ì…˜ì„ ì²˜ë¦¬í•˜ëŠ” í”„ë¡ì‹œë¥¼ ì ìš©í•´ì¤€ë‹¤.

**@Transactional**

`org.springframework.transaction.annotation.Transactional`

## í”„ë¡œì íŠ¸ ìƒì„±

```java
Project: Gradle - Groovy Project
Language: Java
Spring Boot: 3.1.x

Group: hello
Artifact: springtx
Name: springtx
Package name: **hello.springtx**
Packing: **Jar**
Java: 17

Dependencies: **Spring Data JPA, H2 Database, Lombok**
```

í…ŒìŠ¤íŠ¸ì—ì„œë„ lombokì„ ì‚¬ìš©í•˜ê¸° ìœ„í•´ ë‹¤ìŒ ì½”ë“œë¥¼ ì¶”ê°€í•œë‹¤.

```java
//í…ŒìŠ¤íŠ¸ì—ì„œ lombok ì‚¬ìš©
testCompileOnly 'org.projectlombok:lombok' 
testAnnotationProcessor 'org.projectlombok:lombok'
```

## íŠ¸ëœì­ì…˜ ì ìš© í™•ì¸

### íŠ¸ëœì­ì…˜ ì ìš© í™•ì¸

`@Transactional`ì„ í†µí•´ ì„ ì–¸ì  íŠ¸ëœì­ì…˜ ë°©ì‹ì„ ì‚¬ìš©í•˜ë©´ ë‹¨ìˆœíˆ ì–´ë…¸í…Œì´ì…˜ í•˜ë‚˜ë¡œ íŠ¸ëœì­ì…˜ì„ ì ìš©í•  ìˆ˜ ìˆë‹¤. ê·¸ëŸ°ë° ì´ ê¸°ëŠ¥ì€ íŠ¸ëœì­ì…˜ ê´€ë ¨ ì½”ë“œê°€ ëˆˆì— ë³´ì´ì§€ ì•Šê³ , AOPë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë™ì‘í•˜ê¸° ë•Œë¬¸ì—, ì‹¤ì œ íŠ¸ëœì­ì…˜ì´ ì ìš©ë˜ê³  ìˆëŠ”ì§€ ì•„ë‹Œì§€ë¥¼ í™•ì¸í•˜ê¸°ê°€ ì–´ë µë‹¤.

ìŠ¤í”„ë§ íŠ¸ëœì­ì…˜ì´ ì‹¤ì œ ì ìš©ë˜ê³  ìˆëŠ”ì§€ í™•ì¸í•˜ëŠ” ë°©ë²•ì„ ì•Œì•„ë³´ì.

**TxApplyBasicTest**

```java
package hello.springtx.apply;

import jakarta.persistence.Basic;
import lombok.extern.slf4j.Slf4j;
import org.assertj.core.api.Assertions;
import org.junit.jupiter.api.Test;
import org.springframework.aop.support.AopUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.boot.test.context.TestConfiguration;
import org.springframework.context.annotation.Bean;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.transaction.support.TransactionSynchronizationManager;

@Slf4j
@SpringBootTest
public class TxBasicTest {

    @Autowired
    BasicService basicService;

    @Test
    void proxyCheck() {
        //aop class=class hello.springtx.apply.TxBasicTest$BasicService$$SpringCGLIB$$0
        log.info("aop class={}", basicService.getClass());
        Assertions.assertThat(AopUtils.isAopProxy(basicService)).isTrue();
    }

    @Test
    void txText() {
        basicService.tx();
        basicService.nonTx();
    }

    @TestConfiguration
    static class TxApplyBasicConfig {
        @Bean
        BasicService basicService() {
            return new BasicService();
        }
    }

    @Slf4j
    static class BasicService {

        @Transactional
        public void tx() {
            log.info("call tx");
            boolean txActive = TransactionSynchronizationManager.isActualTransactionActive();
            log.info("tx active={}", txActive);
        }

        public void nonTx() {
            log.info("call nonTx");
            boolean txActive = TransactionSynchronizationManager.isActualTransactionActive();
            log.info("tx active={}", txActive);
        }

    }

}
```

**proxyCheck() - ì‹¤í–‰**

- `AopUtils.isAopProxy()` : ì„ ì–¸ì  íŠ¸ëœì­ì…˜ ë°©ì‹ì—ì„œ ìŠ¤í”„ë§ íŠ¸ëœì­ì…˜ì€ AOPë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë™ì‘í•œë‹¤.
    
    `@Transactional`ì„ ë©”ì„œë“œë‚˜ í´ë˜ìŠ¤ì— ë¶™ì´ë©´ í•´ë‹¹ ê°ì²´ëŠ” íŠ¸ëœì­ì…˜ AOP ì ìš©ì˜ ëŒ€ìƒì´ ë˜ê³ , ê²°ê³¼ì ìœ¼ë¡œ ì‹¤ì œ ê°ì²´ ëŒ€ì‹ ì— íŠ¸ëœì­ì…˜ì„ ì²˜ë¦¬í•´ì£¼ëŠ” í”„ë¡ì‹œ ê°ì²´ê°€ ìŠ¤í”„ë§ ë¹ˆì— ë“±ë¡ëœë‹¤. ê·¸ë¦¬ê³  ì£¼ì…ì„ ë°›ì„ ë•Œë„ ì‹¤ì œ ê°ì²´ ëŒ€ì‹ ì— í”„ë¡ì‹œ ê°ì²´ê°€ ì£¼ì…ëœë‹¤.
    
- í´ë˜ìŠ¤ ì´ë¦„ì„ ì¶œë ¥í•´ë³´ë©´ `basicService$$EnhancerBySpringCGLIBâ€¦`ë¼ê³  í”„ë¡ì‹œ í´ë˜ìŠ¤ì˜ ì´ë¦„ì´ ì¶œë ¥ë˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

**proxyCheck() - ì‹¤í–‰ ê²°ê³¼**

```java
TxBasicTest         : aop class=class hello.springtx.apply.TxBasicTest$BasicService$$SpringCGLIB$$0
```

**ìŠ¤í”„ë§ ì»¨í…Œì´ë„ˆì— íŠ¸ëœì­ì…˜ í”„ë¡ì‹œ ë“±ë¡**

![Untitled 4](https://github.com/soohyunnn/spring-db-2/assets/58289675/d4da3590-5fb6-4451-b8e9-9db650e86ad7)

- `@Transactional` ì–´ë…¸í…Œì´ì…˜ì´ íŠ¹ì • í´ë˜ìŠ¤ë‚˜ ë©”ì„œë“œì— í•˜ë‚˜ë¼ë„ ìˆìœ¼ë©´ íŠ¸ëœì­ì…˜ AOPëŠ” í”„ë¡ì‹œë¥¼ ë§Œë“¤ì–´ì„œ ìŠ¤í”„ë§ ì»¨í…Œì´ë„ˆì— ë“±ë¡í•œë‹¤. ê·¸ë¦¬ê³  ì‹¤ì œ `basicService` ê°ì²´ ëŒ€ì‹ ì— í”„ë¡ì‹œì¸ `basicService$$CGLIB` ë¥¼ ìŠ¤í”„ë§ ë¹ˆì— ë“±ë¡í•œë‹¤. ê·¸ë¦¬ê³  í”„ë¡ì‹œëŠ” ë‚´ë¶€ì—ì„œ ì‹¤ì œ `basicService`ë¥¼ ì°¸ì¡°í•˜ê²Œ ëœë‹¤. ì—¬ê¸°ì„œ í•µì‹¬ì€ ì‹¤ì œ ê°ì²´ ëŒ€ì‹ ì— í”„ë¡ì‹œê°€ ìŠ¤í”„ë§ ì»¨í…Œì´ë„ˆì— ë“±ë¡ë˜ì—ˆë‹¤ëŠ” ì ì´ë‹¤.
- í´ë¼ì´ì–¸íŠ¸ì¸ `txBasicTest`ëŠ” ìŠ¤í”„ë§ ì»¨í…Œì´ë„ˆì— `@Autowired BasicService basicService`ë¡œ ì˜ì¡´ê´€ê³„ ì£¼ì…ì„ ìš”ì²­í•œë‹¤. ìŠ¤í”„ë§ ì»¨í…Œì´ë„ˆì—ëŠ” ì‹¤ì œ ê°ì²´ ëŒ€ì‹ ì— í”„ë¡ì‹œê°€ ìŠ¤í”„ë§ ë¹ˆìœ¼ë¡œ ë“±ë¡ë˜ì–´ ìˆê¸° ë•Œë¬¸ì— í”„ë¡ì‹œë¥¼ ì£¼ì…í•œë‹¤.
- í”„ë¡ì‹œëŠ” `BasicService`ë¥¼ ìƒì†í•´ì„œ ë§Œë“¤ì–´ì§€ê¸° ë•Œë¬¸ì— ë‹¤í˜•ì„±ì„ í™œìš©í•  ìˆ˜ ìˆë‹¤. ë”°ë¼ì„œ `BasicService` ëŒ€ì‹ ì— í”„ë¡ì‹œì¸ `BasicService$$CGLIB`ë¥¼ ì£¼ì…í•  ìˆ˜ ìˆë‹¤.

> ğŸ’¡Â ì°¸ê³  : í”„ë¡ì‹œì— ëŒ€í•œ ìì„¸í•œ ë‚´ìš©ì€ **ìŠ¤í”„ë§ í•µì‹¬ ì›ë¦¬ - ê³ ê¸‰í¸**ì—ì„œ ë‹¤ë£¬ë‹¤.
> 

**íŠ¸ëœì­ì…˜ í”„ë¡ì‹œ ë™ì‘ ë°©ì‹**

![Untitled 5](https://github.com/soohyunnn/spring-db-2/assets/58289675/b7656325-c088-4133-8475-33cb34b7043a)

- í´ë¼ì´ì–¸íŠ¸ê°€ ì£¼ì… ë°›ì€ `basicService$$CGLIB`ëŠ” íŠ¸ëœì­ì…˜ì„ ì ìš©í•˜ëŠ” í”„ë¡ì‹œì´ë‹¤.

**txTest() ì‹¤í–‰**

ì‹¤í–‰í•˜ê¸° ì „ì— ë¨¼ì € ë‹¤ìŒ ë¡œê·¸ë¥¼ ì¶”ê°€í•˜ì.

**ë¡œê·¸ ì¶”ê°€**

`application.properties`

```java
logging.level.org.springframework.transaction.interceptor=TRACE
```

ì´ ë¡œê·¸ë¥¼ ì¶”ê°€í•˜ë©´ íŠ¸ëœì­ì…˜ í”„ë¡ì‹œê°€ í˜¸ì¶œí•˜ëŠ” íŠ¸ëœì­ì…˜ì˜ ì‹œì‘ê³¼ ì¢…ë£Œë¥¼ ëª…í™•í•˜ê²Œ ë¡œê·¸ë¡œ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

**basicService.tx() í˜¸ì¶œ**

- í´ë¼ì´ì–¸íŠ¸ê°€ `basicService.tx()`ë¥¼ í˜¸ì¶œí•˜ë©´, í”„ë¡ì‹œì˜ `tx()`ê°€ í˜¸ì¶œëœë‹¤. ì—¬ê¸°ì„œ í”„ë¡ì‹œëŠ” `tx()` ë©”ì„œë“œê°€ íŠ¸ëœì­ì…˜ì„ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ”ì§€ í™•ì¸í•´ë³¸ë‹¤. `tx()` ë©”ì„œë“œì—ëŠ” `@Transactional`ì´ ë¶™ì–´ìˆìœ¼ë¯€ë¡œ íŠ¸ëœì­ì…˜ ì ìš© ëŒ€ìƒì´ë‹¤.
- ë”°ë¼ì„œ íŠ¸ëœì­ì…˜ì„ ì‹œì‘í•œ ë‹¤ìŒì— ì‹¤ì œ `basicService.tx()`ë¥¼ í˜¸ì¶œí•œë‹¤.
- ê·¸ë¦¬ê³  ì‹¤ì œ `basicService.tx()`ì˜ í˜¸ì¶œì´ ëë‚˜ì„œ í”„ë¡ì‹œë¡œ ì œì–´ê°€(ë¦¬í„´) ëŒì•„ì˜¤ë©´ í”„ë¡ì‹œëŠ” íŠ¸ëœì­ì…˜ ë¡œì§ì„ ì»¤ë°‹í•˜ê±°ë‚˜ ë¡¤ë°±í•´ì„œ íŠ¸ëœì­ì…˜ì„ ì¢…ë£Œí•œë‹¤.

**basicService.nonTx() í˜¸ì¶œ**

- í´ë¼ì´ì–¸íŠ¸ê°€ `basicService.nonTx()`ë¥¼ í˜¸ì¶œí•˜ë©´, íŠ¸ëœì­ì…˜ í”„ë¡ì‹œì˜ `nonTx()`ê°€ í˜¸ì¶œëœë‹¤.
    
    ì—¬ê¸°ì„œ `nonTx()` ë©”ì„œë“œê°€ íŠ¸ëœì­ì…˜ì„ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ”ì§€ í™•ì¸í•´ë³¸ë‹¤. `nonTx()`ì—ëŠ” `@Transactional`ì´ ì—†ìœ¼ë¯€ë¡œ ì ìš© ëŒ€ìƒì´ ì•„ë‹ˆë‹¤.
    
- ë”°ë¼ì„œ íŠ¸ëœì­ì…˜ì„ ì‹œì‘í•˜ì§€ ì•Šê³ , `basicService.nonTx()`ë¥¼ í˜¸ì¶œí•˜ê³  ì¢…ë£Œí•œë‹¤.

**TransactionSynchronizationManager.isActualTransactionActive()**

- í˜„ì¬ ì“°ë ˆë“œì— íŠ¸ëœì­ì…˜ì´ ì ìš©ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•  ìˆ˜ ìˆëŠ” ê¸°ëŠ¥ì´ë‹¤. ê²°ê³¼ê°€ `true`ë©´ íŠ¸ëœì­ì…˜ì´ ì ìš©ë˜ì–´ ìˆëŠ” ê²ƒì´ë‹¤. íŠ¸ëœì­ì…˜ì˜ ì ìš© ì—¬ë¶€ë¥¼ ê°€ì¥ í™•ì‹¤í•˜ê²Œ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

**ì‹¤í–‰ ê²°ê³¼**

```prolog
#tx()í˜¸ì¶œ
TransactionInterceptor         : Getting transaction for [hello.springtx.apply.TxBasicTest$BasicService.tx]
TxBasicTest$BasicService       : call tx
TxBasicTest$BasicService       : tx active=true
TransactionInterceptor         : Completing transaction for [hello.springtx.apply.TxBasicTest$BasicService.tx]

#nonTx() í˜¸ì¶œ
TxBasicTest$BasicService       : call nonTx
TxBasicTest$BasicService       : tx active=false
```

- ë¡œê·¸ë¥¼ í†µí•´ `tx()` í˜¸ì¶œì‹œì—ëŠ” `tx active=true`ë¥¼ í†µí•´ íŠ¸ëœì­ì…˜ì´ ì ìš©ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.
- `TransactionInterceptor` ë¡œê·¸ë¥¼ í†µí•´ íŠ¸ëœì­ì…˜ í”„ë¡ì‹œê°€ íŠ¸ëœì­ì…˜ì„ ì‹œì‘í•˜ê³  ì™„ë£Œí•œ ë‚´ìš©ì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.
- `nonTx()` í˜¸ì¶œì‹œì—ëŠ” `tx active=false`ë¥¼ í†µí•´ íŠ¸ëœì­ì…˜ì´ ì—†ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

## íŠ¸ëœì­ì…˜ ì ìš© ìœ„ì¹˜

ì´ë²ˆì‹œê°„ì—ëŠ” ì½”ë“œë¥¼ í†µí•´ `@Transactional`ì˜ ì ìš© ìœ„ì¹˜ì— ë”°ë¥¸ ìš°ì„ ìˆœìœ„ë¥¼ í™•ì¸í•´ë³´ì.

ìŠ¤í”„ë§ì—ì„œ ìš°ì„ ìˆœìœ„ëŠ” í•­ìƒ **ë” êµ¬ì²´ì ì´ê³  ìì„¸í•œ ê²ƒì´ ë†’ì€ ìš°ì„ ìˆœìœ„ë¥¼ ê°€ì§„ë‹¤**. ì´ê²ƒë§Œ ê¸°ì–µí•˜ë©´ ìŠ¤í”„ë§ì—ì„œ ë°œìƒí•˜ëŠ” ëŒ€ë¶€ë¶„ì˜ ìš°ì„ ìˆœìœ„ë¥¼ ì‰½ê²Œ ê¸°ì–µí•  ìˆ˜ ìˆë‹¤. ê·¸ë¦¬ê³  ë” êµ¬ì²´ì ì¸ ê²ƒì€ ë” ë†’ì€ ìš°ì„ ìˆœìœ„ë¥¼ ê°€ì§€ëŠ” ê²ƒì€ ìƒì‹ì ìœ¼ë¡œ ìì—°ìŠ¤ëŸ½ë‹¤.

ì˜ˆë¥¼ ë“¤ì–´ì„œ ë©”ë”ìœ¼ì™€ í´ë˜ìŠ¤ì— ì–´ë…¸í…Œì´ì…˜ì„ ë¶™ì¼ ìˆ˜ ìˆë‹¤ë©´ ë” êµ¬ì²´ì ì¸ ë©”ì„œë“œê°€ ë” ë†’ì€ ìš°ì„ ìˆœìœ„ë¥¼ ê°€ì§„ë‹¤.

ì¸í„°í˜ì´ìŠ¤ì™€ í•´ë‹¹ ì¸í„°í˜ì´ìŠ¤ë¥¼ êµ¬í˜„í•œ í´ë˜ìŠ¤ì— ì–´ë…¸í…Œì´ì…˜ì„ ë¶™ì¼ ìˆ˜ ìˆë‹¤ë©´ ë” êµ¬ì²´ì ì¸ í´ë˜ìŠ¤ê°€ ë” ë†’ì€ ìš°ì„ ìˆœìœ„ë¥¼ ê°€ì§„ë‹¤.

**TxLevelTest**

```java
package hello.springtx.apply;

import lombok.extern.slf4j.Slf4j;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.boot.test.context.TestConfiguration;
import org.springframework.context.annotation.Bean;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.transaction.support.TransactionSynchronizationManager;

@SpringBootTest
public class TxLevelTest {

    @Autowired
    LevelService service;

    @TestConfiguration
    static class TxApplyLevelConfig {
        @Bean
        LevelService levelService() {
            return new LevelService();
        }
    }

    @Test
    void orderTest() {
        service.write();
        service.read();
    }

    @Slf4j
    @Transactional(readOnly = true)
    static class LevelService {

        @Transactional(readOnly=false)
        public void write() {
            log.info("call write");
            printTxInfo();
        }

        public void read() {
            log.info("call read");
            printTxInfo();
        }

        private void printTxInfo() {
            boolean txActive = TransactionSynchronizationManager.isActualTransactionActive();
            log.info("tx active={}", txActive);
            boolean readOnly = TransactionSynchronizationManager.isCurrentTransactionReadOnly();
            log.info("tx readOnly={}", readOnly);
        }

    }
}
```

ìŠ¤í”„ë§ì˜ `@Transactional`ì€ ë‹¤ìŒ ë‘ ê°€ì§€ ê·œì¹™ì´ ìˆë‹¤.

1. ìš°ì„ ìˆœìœ„ ê·œì¹™
2. í´ë˜ìŠ¤ì— ì ìš©í•˜ë©´ ë©”ì„œë“œëŠ” ìë™ ì ìš©

**ìš°ì„ ìˆœìœ„**

íŠ¸ëœì­ì…˜ì„ ì‚¬ìš©í•  ë•ŒëŠ” ë‹¤ì–‘í•œ ì˜µì…˜ì„ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤. ê·¸ëŸ°ë° ì–´ë–¤ ê²½ìš°ì—ëŠ” ì˜µì…˜ì„ ì£¼ê³ , ì–´ë–¤ ê²½ìš°ì—ëŠ” ì˜µì…˜ì„ ì£¼ì§€ ì•Šìœ¼ë©´ ì–´ë–¤ ê²ƒì´ ì„ íƒë ê¹Œ? ì˜ˆë¥¼ ë“¤ì–´ì„œ ì½ê¸° ì „ìš© íŠ¸ëœì­ì…˜ ì˜µì…˜ì„ ì‚¬ìš©í•˜ëŠ” ê²½ìš°ì™€ ì•„ë‹Œ ê²½ìš°ë¥¼ ë¹„êµí•´ë³´ì. (ì½ê¸° ì „ìš© ì˜µì…˜ì— ëŒ€í•œ ìì„¸í•œ ë‚´ìš©ì€ ë’¤ì—ì„œ ë‹¤ë£¬ë‹¤. ì—¬ê¸°ì„œëŠ” ì ìš© ìˆœì„œì— ì§‘ì¤‘í•˜ì.)

- `LevelService`ì˜ íƒ€ì…ì— `@Transactional(readOnly = true)`ì´ ë¶™ì–´ìˆë‹¤.
- `write()` : í•´ë‹¹ ë©”ì„œë“œì— `@Transactional(readOnly = false)`ì´ ë¶™ì–´ìˆë‹¤.
    - ì´ë ‡ê²Œ ë˜ë©´ íƒ€ì…ì— ìˆëŠ” `@Transactional(readOnly = true)`ì™€ í•´ë‹¹ ë©”ì„œë“œì— ìˆëŠ” `@Transactional(readOnly = false)` ë‘˜ ì¤‘ í•˜ë‚˜ë¥¼ ì ìš©í•´ì•¼ í•œë‹¤.
    - í´ë˜ìŠ¤ë³´ë‹¤ëŠ” ë©”ì„œë“œê°€ ë” êµ¬ì²´ì ì´ë¯€ë¡œ ë©”ì„œë“œì— ìˆëŠ” `@Transactional(readOnly = false)` ì˜µì…˜ì„ ì‚¬ìš©í•œ íŠ¸ëœì­ì…˜ì´ ì ìš©ëœë‹¤.

**í´ë˜ìŠ¤ì— ì ìš©í•˜ë©´ ë©”ì„œë“œëŠ” ìë™ ì ìš©**

- `read()` : í•´ë‹¹ ë©”ì„œë“œì— `@Transactional`ì´ ì—†ë‹¤. ì´ ê²½ìš° ë” ìƒìœ„ì¸ í´ë˜ìŠ¤ë¥¼ í™•ì¸í•œë‹¤.
    - í´ë˜ìŠ¤ì— `@Transactional(readOnly = true)`ì´ ì ìš©ë˜ì–´ ìˆë‹¤. ë”°ë¼ì„œ íŠ¸ëœì­ì…˜ì´ ì ìš©ë˜ê³  `readOnly = true` ì˜µì…˜ì„ ì‚¬ìš©í•˜ê²Œ ëœë‹¤.

ì°¸ê³ ë¡œ `readOnly = fasle`ëŠ” ê¸°ë³¸ ì˜µì…˜ì´ê¸° ë•Œë¬¸ì— ë³´í†µ ìƒëµí•œë‹¤. ì—¬ê¸°ì„œëŠ” ì´í•´ë¥¼ ë•ê¸° ìœ„í•´ ê¸°ë³¸ ì˜µì…˜ì„ ì ì–´ì£¼ì—ˆë‹¤.

`@Transactional == @Transactional(readOnly=false)`ì™€ ê°™ë‹¤.

### **TransactionSynchronizationManager.isCurrentTransactionReadOnly**

í˜„ì¬ íŠ¸ëœì­ì…˜ì— ì ìš©ëœ `readOnly` ì˜µì…˜ì˜ ê°’ì„ ë°˜í™˜í•œë‹¤.

**ì‹¤í–‰ ê²°ê³¼**

```prolog
# write() í˜¸ì¶œ
TransactionInterceptor         : Getting transaction for [hello.springtx.apply.TxLevelTest$LevelService.write]
TxLevelTest$LevelService       : call write
TxLevelTest$LevelService       : tx active=true
TxLevelTest$LevelService       : tx readOnly=false
TransactionInterceptor         : Completing transaction for [hello.springtx.apply.TxLevelTest$LevelService.write]

# read() í˜¸ì¶œ
TransactionInterceptor         : Getting transaction for [hello.springtx.apply.TxLevelTest$LevelService.read]
TxLevelTest$LevelService       : call read
TxLevelTest$LevelService       : tx active=true
TxLevelTest$LevelService       : tx readOnly=true
TransactionInterceptor         : Completing transaction for [hello.springtx.apply.TxLevelTest$LevelService.read]
```

ë‹¤ìŒ ê²°ê³¼ë¥¼ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

- `write()`ì—ì„œëŠ” `tx readOnly=false` : ì½ê¸° ì“°ê¸° íŠ¸ëœì­ì…˜ì´ ì ìš©ë˜ì—ˆë‹¤. `readOnly`ê°€ ì•„ë‹ˆë‹¤.
- `read()`ì—ì„œëŠ” `tx readOnly=true` : ì½ê¸° ì „ìš© íŠ¸ëœì­ì…˜ ì˜µì…˜ì¸ `readOnly`ê°€ ì ìš©ë˜ì—ˆë‹¤.

### ì¸í„°í˜ì´ìŠ¤ì— @Transactional ì ìš©

ì¸í„°í˜ì´ìŠ¤ì—ë„ `@Transactional`ì„ ì ìš©í•  ìˆ˜ ìˆë‹¤. ì´ ê²½ìš° ë‹¤ìŒ ìˆœì„œë¡œ ì ìš©ëœë‹¤. êµ¬ì²´ì ì¸ ê²ƒì´ ë” ë†’ì€ ìš°ì„ ìˆœìœ„ë¥¼ ê°€ì§„ë‹¤ê³  ìƒê°í•˜ë©´ ë°”ë¡œ ì´í•´ê°€ ë  ê²ƒì´ë‹¤.

1. í´ë˜ìŠ¤ì˜ ë©”ì„œë“œ (ìš°ì„ ìˆœìœ„ê°€ ê°€ì¥ ë†’ë‹¤.)
2. í´ë˜ìŠ¤ì˜ íƒ€ì…
3. ì¸í„°í˜ì´ìŠ¤ì˜ ë©”ì„œë“œ
4. ì¸í„°í˜ì´ìŠ¤ì˜ íƒ€ì… (ìš°ì„ ìˆœìœ„ê°€ ê°€ì¥ ë‚®ë‹¤.)

í´ë˜ìŠ¤ì˜ ë©”ì„œë“œë¥¼ ì°¾ê³ , ë§Œì•½ ì—†ìœ¼ë©´ í´ë˜ìŠ¤ì˜ íƒ€ì…ì„ ì°¾ê³  ë§Œì•½ ì—†ìœ¼ë©´ ì¸í„°í˜ì´ìŠ¤ì˜ ë©”ì„œë“œë¥¼ ì°¾ê³  ê·¸ë˜ë„ ì—†ìœ¼ë©´ ì¸í„°í˜ì´ìŠ¤ì˜ íƒ€ì…ì„ ì°¾ëŠ”ë‹¤.

ãƒ¥ëŸ°ë° ì¸í„°í˜ì´ìŠ¤ì— `@Trasactional` ì‚¬ìš©í•˜ëŠ” ê²ƒì€ ìŠ¤í”„ë§ ê³µì‹ ë©”ë‰´ì–¼ì—ì„œ ê¶Œì¥í•˜ì§€ ì•ŠëŠ” ë°©ë²•ì´ë‹¤.

AOPë¥¼ ì ìš©í•˜ëŠ” ë°©ì‹ì— ë”°ë¼ì„œ ì¸í„°í˜ì´ìŠ¤ì— ì–´ë…¸í…Œì´ì…˜ì„ ë‘ë©´ AOPê°€ ì ìš©ì´ ë˜ì§€ ì•ŠëŠ” ê²½ìš°ë„ ìˆê¸° ë•Œë¬¸ì´ë‹¤. ê°€ê¸‰ì  êµ¬ì²´ í´ë˜ìŠ¤ì— `@Transactional`ì„ ì‚¬ìš©í•˜ì.

> **ğŸ’¡Â ì°¸ê³ **
ìŠ¤í”„ë§ì€ ì¸í„°í˜ì´ìŠ¤ì— `@Transactional`ì„ ì‚¬ìš©í•˜ëŠ” ë°©ì‹ì„ ìŠ¤í”„ë§ 5.0ì—ì„œ ë§ì€ ë¶€ë¶„ ê°œì„ í–ˆë‹¤.
ê³¼ê±°ì—ëŠ” êµ¬ì²´ í´ë˜ìŠ¤ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í”„ë¡ì‹œë¥¼ ìƒì„±í•˜ëŠ” CGLIB ë°©ì‹ì„ ì‚¬ìš©í•˜ë©´ ì¸í„°í˜ì´ìŠ¤ì— ìˆëŠ” `@Transactional`ì„ ì¸ì‹í•˜ì§€ ëª»í–ˆë‹¤. ìŠ¤í”„ë§ 5.0 ë¶€í„°ëŠ” ì´ ë¶€ë¶„ì„ ê°œì„ í•´ì„œ ì¸í„°í˜ì´ìŠ¤ì— ìˆëŠ” `@Transactional`ë„ ì¸ì‹í•œë‹¤. í•˜ì§€ë§Œ ë‹¤ë¥¸ AOP ë°©ì‹ì—ì„œ ë˜ ì ìš©ë˜ì§€ ì•Šì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ê³µì‹ ë©”ë‰´ì–¼ì˜ ê°€ì´ë“œëŒ€ë¡œ ê°€ê¸‰ì  êµ¬ì²´ í´ë˜ìŠ¤ì— `@Transactional`ì„ ì‚¬ìš©í•˜ì.
CGLIB ë°©ì‹ì€ **ìŠ¤í”„ë§ í•µì‹¬ ì›ë¦¬ - ê³ ê¸‰í¸**ì—ì„œ ë‹¤ë£¬ë‹¤.
> 

## íŠ¸ëœì­ì…˜ AOP ì£¼ì˜ ì‚¬í•­ - í”„ë¡ì‹œ ë‚´ë¶€ í˜¸ì¶œ1

> **ğŸ’¡ì°¸ê³ **
ì—¬ê¸°ì„œ ì„¤ëª…í•˜ëŠ” ë‚´ìš©ì€ ìŠ¤í”„ë§ í•µì‹¬ì›ë¦¬ ê³ ê¸‰í¸ 13. ì‹¤ë¬´ ì£¼ì˜ì‚¬í•­ - í”„ë¡ì‹œì™€ ë‚´ë¶€ í˜¸ì¶œ ë¬¸ì œì—ì„œ ë‹¤ë£¨ëŠ” ë‚´ìš©ê³¼ ê°™ì€ ë¬¸ì œë¥¼ ë‹¤ë£¬ë‹¤. ì´ë ‡ê²Œ í•œë²ˆ ë” ì–¸ê¸‰í•˜ëŠ” ì´ìœ ëŠ” ê·¸ ë§Œí¼ ì‹¤ë¬´ì—ì„œ ë§ì´ ë§Œë‚˜ëŠ” ì£¼ì œì´ê³ , ë§ì€ ê°œë°œìë“¤ì´ ì´ ë¬¸ì œë¥¼ ì´í•´í•˜ì§€ ëª»í•´ì„œ ê³ í†µë°›ê¸° ë•Œë¬¸ì´ë‹¤.
ì—¬ê¸°ì„œëŠ” íŠ¸ëœì­ì…˜ AOPì— ê´€ì ì—ì„œ ì„¤ëª…í•œë‹¤.
> 

`@Transactional`ì„ ì‚¬ìš©í•˜ë©´ ìŠ¤í”„ë§ì˜ íŠ¸ëœì­ì…˜ AOPê°€ ì ìš©ëœë‹¤.

íŠ¸ëœì­ì…˜ AOPëŠ” ê¸°ë³¸ì ìœ¼ë¡œ í”„ë¡ì‹œ ë°©ì‹ì˜ AOPë¥¼ ì‚¬ìš©í•œë‹¤.

ì•ì„œ ë°°ìš´ ê²ƒì²˜ëŸ¼ `@Transactional`ì„ ì ìš©í•˜ë©´ í”„ë¡ì‹œ ê°ì²´ê°€ ìš”ì²­ì„ ë¨¼ì € ë°›ì•„ì„œ íŠ¸ë˜ì­ì…˜ì„ ì²˜ë¦¬í•˜ê³ , ì‹¤ì œ ê°ì²´ë¥¼ í˜¸ì¶œí•´ì¤€ë‹¤.

ë”°ë¼ì„œ íŠ¸ëœì­ì…˜ì„ ì ìš©í•˜ë ¤ë©´ í•­ìƒ í”„ë¡ì‹œë¥¼ í†µí•´ì„œ ëŒ€ìƒ ê°ì²´(Target)ì„ í˜¸ì¶œí•´ì•¼ í•œë‹¤.

ì´ë ‡ê²Œ í•´ì•¼ í”„ë¡ì‹œì—ì„œ ë¨¼ì € íŠ¸ëœì­ì…˜ì„ ì ìš©í•˜ê³ , ì´í›„ì— ëŒ€ìƒ ê°ì²´ì— í˜¸ì¶œí•˜ê²Œ ëœë‹¤.

ë§Œì•½ í”„ë¡ì‹œë¥¼ ê±°ì¹˜ì§€ ì•Šê³  ëŒ€ìƒ ê°ì²´ë¥¼ ì§ì ‘ í˜¸ì¶œí•˜ê²Œ ë˜ë©´ AOPê°€ ì ìš©ë˜ì§€ ì•Šê³ , íŠ¸ëœì­ì…˜ë„ ì ìš©ë˜ì§€ ì•ŠëŠ”ë‹¤.

![Untitled 6](https://github.com/soohyunnn/spring-db-2/assets/58289675/8290ca94-b9be-4a65-bd5e-9f568d305fb5)

AOPë¥¼ ì ìš©í•˜ë©´ ìŠ¤í”„ë§ì€ ëŒ€ìƒ ê°ì²´ ëŒ€ì‹ ì— í”„ë¡ì‹œë¥¼ ìŠ¤í”„ë§ ë¹ˆìœ¼ë¡œ ë“±ë¡í•œë‹¤. ë”°ë¼ì„œ ìŠ¤í”„ë§ì€ ì˜ì¡´ê´€ê³„ ì£¼ì…ì‹œì— í•­ìƒ ì‹¤ì œ ê°ì²´ ëŒ€ì‹ ì— í”„ë¡ì‹œ ê°ì²´ë¥¼ ì£¼ì…í•œë‹¤. í”„ë¡ì‹œ ê°ì²´ê°€ ì£¼ì…ë˜ê¸° ë•Œë¬¸ì— ëŒ€ìƒ ê°ì²´ë¥¼ ì§ì ‘ í˜¸ì¶œí•˜ëŠ” ë¬¸ì œëŠ” ì¼ë°˜ì ìœ¼ë¡œ ë°œìƒí•˜ì§€ ì•ŠëŠ”ë‹¤. í•˜ì§€ë§Œ **ëŒ€ìƒ ê°ì²´ì˜ ë‚´ë¶€ì—ì„œ ë©”ì„œë“œ í˜¸ì¶œì´ ë°œìƒí•˜ë©´ í”„ë¡ì‹œë¥¼ ê±°ì¹˜ì§€ ì•Šê³  ëŒ€ìƒ ê°ì²´ë¥¼ ì§ì ‘ í˜¸ì¶œí•˜ëŠ” ë¬¸ì œê°€ ë°œìƒ**í•˜ë‹¤. ì´ë ‡ê²Œ ë˜ë©´ `@Transactional`ì´ ìˆì–´ë„ íŠ¸ëœì­ì…˜ì´ ì ìš©ë˜ì§€ ì•ŠëŠ”ë‹¤. ì‹¤ë¬´ì—ì„œ ë°˜ë“œì‹œ í•œë²ˆì€ ë§Œë‚˜ì„œ ê³ ìƒí•˜ëŠ” ë¬¸ì œì´ê¸° ë•Œë¬¸ì— ê¼­ ì´í•´í•˜ê³  ë„˜ì–´ê°€ì!!

ì˜ˆì œë¥¼ í†µí•´ì„œ ë‚´ë¶€ í˜¸ì¶œì´ ë°œìƒí•  ë•Œ ì–´ë–¤ ë¬¸ì œê°€ ë°œìƒí•˜ëŠ”ì§€ ì•Œì•„ë³´ì. ë¨¼ì € ë‚´ë¶€ í˜¸ì¶œì´ ë°œìƒí•˜ëŠ” ì˜ˆì œë¥¼ ë§Œë“¤ì–´ë³´ì.

**InternalCallV1Test**

```java
package hello.springtx.apply;

import lombok.extern.slf4j.Slf4j;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.boot.test.context.TestConfiguration;
import org.springframework.context.annotation.Bean;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.transaction.support.TransactionSynchronizationManager;

@Slf4j
@SpringBootTest
public class InternalCallV1Test {

    @Autowired
    CallService callService;

    @TestConfiguration
    static class InternalCallV2Config {
        @Bean
        CallService callService() {
            return new CallService();
        }
    }

    @Test
    void printProxy() {
        log.info("callService class={}", callService.getClass());
    }

    @Test
    void internalCall() {
        callService.internal();
    }

    @Test
    void externalCall() {
        callService.external();
    }
    
    @Slf4j
    static class CallService {

        public void external() {
            log.info("call external");
            printTxInfo();
            internal();
        }

        @Transactional
        public void internal() {
            log.info("call internal");
            printTxInfo();
        }

        private void printTxInfo() {
            boolean txActive = TransactionSynchronizationManager.isActualTransactionActive();
            log.info("tx active={}", txActive);
        }

    }

}
```

### **CallService**

- `external()`ì€ íŠ¸ëœì­ì…˜ì´ ì—†ë‹¤.
- `internal()`ì€ `@Transactional`ì„ í†µí•´ íŠ¸ëœì­ì…˜ì„ ì ìš©í•œë‹¤.

`@Transactional`ì´ í•˜ë‚˜ë¼ë„ ìˆìœ¼ë©´ íŠ¸ëœì­ì…˜ í”„ë¡ì‹œ ê°ì²´ê°€ ë§Œë“¤ì–´ì§„ë‹¤. ê·¸ë¦¬ê³  `callService` ë¹ˆì„ ì£¼ì… ë°›ìœ¼ë©´ íŠ¸ëœì­ì…˜ í”„ë¡ì‹œ ê°ì²´ê°€ ëŒ€ì‹  ì£¼ì…ëœë‹¤.

ë‹¤ìŒ ì½”ë“œë¥¼ ì‹¤í–‰í•´ë³´ì.

```java
@Test
void printProxy() {
    log.info("callService class={}", callService.getClass());
}
```

ì—¬ê¸°ì„œëŠ” í…ŒìŠ¤íŠ¸ì—ì„œ `callService`ë¥¼ ì£¼ì… ë°›ëŠ”ë°, í•´ë‹¹ í´ë˜ìŠ¤ë¥¼ ì¶œë ¥í•´ë³´ë©´ ë’¤ì— CGLIBâ€¦ì´ ë¶™ì€ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤. ì›ë³¸ ê°ì²´ ëŒ€ì‹ ì— íŠ¸ëœì­ì…˜ì„ ì²˜ë¦¬í•˜ëŠ” í”„ë¡ì‹œ ê°ì²´ë¥¼ ì£¼ì… ë°›ì€ ê²ƒì´ë‹¤.

```prolog
callService class=class hello.springtx.apply.InternalCallV1Test$CallService$$SpringCGLIB$$0
```

### **internalCall() ì‹¤í–‰**

`internalCall()`ì€ íŠ¸ëœì­ì…˜ì´ ìˆëŠ” ì½”ë“œì¸ `internal()`ì„ í˜¸ì¶œí•œë‹¤.

**internal()**

```java
@Transactional
public void internal() {
    log.info("call internal");
    printTxInfo();
}
```

![Untitled 7](https://github.com/soohyunnn/spring-db-2/assets/58289675/2b32acf7-f004-4bea-8dc0-71743b8bec8f)

1. í´ë¼ì´ì–¸íŠ¸ì¸ í…ŒìŠ¤íŠ¸ ì½”ë“œëŠ” `callService.internal()`ì„ í˜¸ì¶œí•œë‹¤. ì—¬ê¸°ì„œ `callService`ëŠ” íŠ¸ëœì­ì…˜ í”„ë¡ì‹œì´ë‹¤.
2. `callService`ì˜ íŠ¸ëœì­ì…˜ í”„ë¡ì‹œê°€ í˜¸ì¶œëœë‹¤.
3. `internal()` ë©”ì„œë“œì— `@Transactional`ì´ ë¶™ì–´ ìˆìœ¼ë¯€ë¡œ íŠ¸ëœì­ì…˜ í”„ë¡ì‹œëŠ” íŠ¸ëœì­ì…˜ì„ ì ìš©í•œë‹¤.
4. íŠ¸ëœì­ì…˜ ì ìš© í›„ ì‹¤ì œ `callService` ê°ì²´ ì¸ìŠ¤í„´ìŠ¤ì˜ `internal()`ì„ í˜¸ì¶œí•œë‹¤.

ì‹¤ì œ `callService`ê°€ ì²˜ë¦¬ë¥¼ ì™„ë£Œí•˜ë©´ ì‘ë‹µì´ íŠ¸ëœì­ì…˜ í”„ë¡ì‹œë¡œ ëŒì•„ì˜¤ê³ , íŠ¸ëœì­ì…˜ í”„ë¡ì‹œëŠ” íŠ¸ëœì­ì…˜ì„ ì™„ë£Œí•œë‹¤.

**ì‹¤í–‰ ë¡œê·¸ - internalCall**

```prolog
TransactionInterceptor           : Getting transaction for [hello.springtx.apply.InternalCallV1Test$CallService.internal]
InternalCallV1Test$CallService   : call internal
InternalCallV1Test$CallService   : tx active=true
TransactionInterceptor           : Completing transaction for [hello.springtx.apply.InternalCallV1Test$CallService.internal]
```

- `TransactionInterceptor`ê°€ ë‚¨ê¸´ ë¡œê·¸ë¥¼ í†µí•´ íŠ¸ëœì­ì…˜ í”„ë¡ì‹œê°€ íŠ¸ëœì­ì…˜ì„ ì ìš©í•œ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.
- `CallService`ê°€ ë‚¨ê¸´ `tx active=true` ë¡œê·¸ë¥¼ í†µí•´ íŠ¸ëœì­ì…˜ì´ ì ìš©ë˜ì–´ ìˆìŒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

ì§€ê¸ˆê¹Œì§€ ë³¸ ë‚´ìš©ì€ ì•ì—ì„œ í•™ìŠµí•œ ë‚´ìš©ì´ì–´ì„œ ì´í•´í•˜ê¸° ì–´ë µì§€ ì•Šì„ ê²ƒì´ë‹¤. ì´ì œ ë³¸ê²©ì ìœ¼ë¡œ ë¬¸ì œê°€ ë˜ëŠ” ë¶€ë¶„ì„ í™•ì¸í•´ë³´ì!!

### **externalCall() ì‹¤í–‰**

`externalCall()`ì€ íŠ¸ëœì­ì…˜ì´ ì—†ëŠ” ì½”ë“œì¸ `external()`ì„ í˜¸ì¶œí•œë‹¤.

**external()**

```java
public void external() {
    log.info("call external");
    printTxInfo();
    internal();
}

@Transactional
public void internal() {
    log.info("call internal");
    printTxInfo();
}
```

`external()`ì€ `@Transactional` ì–´ë…¸í…Œì´ì…˜ì´ ì—†ë‹¤. ë”°ë¼ì„œ íŠ¸ëœì­ì…˜ ì—†ì´ ì‹œì‘í•œë‹¤. ê·¸ëŸ°ë° ë‚´ë¶€ì—ì„œ `@Transactional`ì´ ìˆëŠ” `internal()`ì„ í˜¸ì¶œí•˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

ì´ ê²½ìš° `external()`ì€ íŠ¸ëœì­ì…˜ì´ ì—†ì§€ë§Œ, `internal()`ì—ì„œëŠ” íŠ¸ëœì­ì…˜ì´ ì ìš©ë˜ëŠ” ê²ƒ ì²˜ëŸ¼ ë³´ì¸ë‹¤.

**ì‹¤í–‰ ë¡œê·¸ - externalCall()**

```prolog
CallService     : call external
CallService     : tx active=false
CallService     : call internal
CallService     : tx active=false
```

ì‹¤í–‰ ë¡œê·¸ë¥¼ ë³´ë©´ íŠ¸ëœì­ì…˜ ê´€ë ¨ ì½”ë“œê°€ ì „í˜€ ë³´ì´ì§€ ì•ŠëŠ”ë‹¤. í”„ë¡ì‹œê°€ ì•„ë‹Œ ì‹¤ì œ `callService`ì—ì„œ ë‚¨ê¸´ ë¡œê·¸ë§Œ í™•ì¸ëœë‹¤. ì¶”ê°€ë¡œ `internal()` ë‚´ë¶€ì—ì„œ í˜¸ì¶œí•œ `tx active=false` ë¡œê·¸ë¥¼ í†µí•´ í™•ì‹¤íˆ íŠ¸ëœì­ì…˜ì´ ìˆ˜í–‰ë˜ì§€ ì•Šì€ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

ìš°ë¦¬ì˜ ê¸°ëŒ€ì™€ ë‹¤ë¥´ê²Œ `internal()`ì—ì„œ íŠ¸ëœì­ì…˜ì´ ì „í˜€ ì ìš©ë˜ì§€ ì•Šì•˜ë‹¤. ì™œ ì´ëŸ° ë¬¸ì œê°€ ë°œìƒí•˜ëŠ” ê²ƒì¼ê¹Œ?

**í”„ë¡ì‹œì™€ ë‚´ë¶€ í˜¸ì¶œ**

![Untitled 8](https://github.com/soohyunnn/spring-db-2/assets/58289675/05edaf01-af84-4137-9034-ff5c9d827a3d)

ì‹¤ì œ í˜¸ì¶œë˜ëŠ” íë¦„ì„ ì²œì²œíˆ ë¶„ì„í•´ë³´ì.

1. í´ë¼ì´ì–¸íŠ¸ì¸ í…ŒìŠ¤íŠ¸ ì½”ë“œëŠ” `callService.external()`ì„ í˜¸ì¶œí•œë‹¤. ì—¬ê¸°ì„œ `callService`ëŠ” íŠ¸ëœì­ì…˜ í”„ë¡ì‹œì´ë‹¤.
2. `callSErvice`ì˜ íŠ¸ëœì­ì…˜ í”„ë¡ì‹œê°€ í˜¸ì¶œëœë‹¤.
3. `external()` ë©”ì„œë“œì—ëŠ” `@Transactional`ì´ ì—†ë‹¤. ë”°ë¼ì„œ íŠ¸ëœì­ì…˜ í”„ë¡ì‹œëŠ” íŠ¸ëœì­ì…˜ì„ ì ìš©í•˜ì§€ ì•ŠëŠ”ë‹¤.
4. íŠ¸ëœì­ì…˜ ì ìš©í•˜ì§€ ì•Šê³ , ì‹¤ì œ `callService` ê°ì²´ ì¸ìŠ¤í„´ìŠ¤ì˜ `external()`ì„ í˜¸ì¶œí•œë‹¤.
5. `external()`ì€ ë‚´ë¶€ì—ì„œ `internal()` ë©”ì„œë“œë¥¼ í˜¸ì¶œí•œë‹¤. ê·¸ëŸ°ë° ì—¬ê¸°ì„œ ë¬¸ì œê°€ ë°œìƒí•œë‹¤.

**ë¬¸ì œ ì›ì¸**

ìë°” ì–¸ì–´ì—ì„œ ë©”ì„œë“œ ì•ì— ë³„ë„ì˜ ì°¸ì¡°ê°€ ì—†ìœ¼ë©´ `this`ë¼ëŠ” ëœ»ìœ¼ë¡œ ìê¸° ìì‹ ì˜ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ê°€ë¦¬í‚¨ë‹¤.

ê²°ê³¼ì ìœ¼ë¡œ ìê¸° ìì‹ ì˜ ë‚´ë¶€ ë©”ì„œë“œë¥¼ í˜¸ì¶œí•˜ëŠ” `this.internal()`ì´ ë˜ëŠ”ë°, ì—¬ê¸°ì„œ thisëŠ” ìê¸° ìì‹ ì„ ê°€ë¦¬í‚¤ë¯€ë¡œ, ì‹¤ì œ ëŒ€ìƒ ê°ì²´(`target`)ì˜ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ëœ»í•œë‹¤. ê²°ê³¼ì ìœ¼ë¡œ ì´ëŸ¬í•œ ë‚´ë¶€ í˜¸ì¶œì€ í”„ë¡ì‹œë¥¼ ê±°ì¹˜ì§€ ì•ŠëŠ”ë‹¤. ë”°ë¼ì„œ íŠ¸ëœì­ì…˜ì„ ì ìš©í•  ìˆ˜ ì—†ë‹¤. ê²°ê³¼ì ìœ¼ë¡œ `target`ì— ìˆëŠ” `internal()`ì„ ì§ì ‘ í˜¸ì¶œí•˜ê²Œ ëœ ê²ƒì´ë‹¤.

**í”„ë¡ì‹œ ë°©ì‹ì˜ AOP í•œê³„**

`@Transactional`ë¥¼ ì‚¬ìš©í•˜ëŠ” íŠ¸ëœì­ì…˜ AOPëŠ” í”„ë¡ì‹œë¥¼ ì‚¬ìš©í•œë‹¤. í”„ë¡ì‹œë¥¼ ì‚¬ìš©í•˜ë©´ ë©”ì„œë“œ ë‚´ë¶€ í˜¸ì¶œì— í”„ë¡ì‹œë¥¼ ì ìš©í•  ìˆ˜ ì—†ë‹¤.

ê·¸ë ‡ë‹¤ë©´ ì´ ë¬¸ì œë¥¼ ì–´ë–»ê²Œ í•´ê²°í•  ìˆ˜ ìˆì„ê¹Œ?

ê°€ì¥ ë‹¨ìˆœí•œ ë°©ë²•ì€ ë‚´ë¶€ í˜¸ì¶œì„ í”¼í•˜ê¸° ìœ„í•´ `internal()` ë©”ì„œë“œë¥¼ ë³„ë„ì˜ í´ë˜ìŠ¤ë¡œ ë¶„ë¦¬í•˜ëŠ” ê²ƒì´ë‹¤.

## íŠ¸ëœì­ì…˜ AOP ì£¼ì˜ ì‚¬í•­ - í”„ë¡ì‹œ ë‚´ë¶€ í˜¸ì¶œ2

ë©”ì„œë“œ ë‚´ë¶€ í˜¸ì¶œ ë•Œë¬¸ì— íŠ¸ëœì­ì…˜ í”„ë¡ì‹œê°€ ì ìš©ë˜ì§€ ì•ŠëŠ” ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ `internal()` ë©”ì„œë“œë¥¼ ë³„ë„ì˜ í´ë˜ìŠ¤ë¡œ ë¶„ë¦¬í•˜ì.

**InternalCallV2Test**

```java
package hello.springtx.apply;

import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.boot.test.context.TestConfiguration;
import org.springframework.context.annotation.Bean;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.transaction.support.TransactionSynchronizationManager;

@SpringBootTest
public class InternalCallV2Test {

    @Autowired
    CallService callService;

    @TestConfiguration
    static class InternalCallV2Config {
        @Bean
        CallService callService() {
            return new CallService(internalService());
        }

        @Bean
        InternalService internalService() {
            return new InternalService();
        }
    }

    @Test
    void externalCallV2() {
        callService.external();
    }

    @Slf4j
    @RequiredArgsConstructor
    static class CallService {

        private final InternalService internalService;

        public void external() {
            log.info("call external");
            printTxInfo();
            internalService.internal();
        }

        private void printTxInfo() {
            boolean txActive = TransactionSynchronizationManager.isActualTransactionActive();
            log.info("tx active={}", txActive);
        }

    }

    @Slf4j
    static class InternalService {

        @Transactional
        public void internal() {
            log.info("call internal");
            printTxInfo();
        }

        private void printTxInfo() {
            boolean txActive = TransactionSynchronizationManager.isActualTransactionActive();
            log.info("tx active={}", txActive);
        }

    }

}
```

- `InternalService` í´ë˜ìŠ¤ë¥¼ ë§Œë“¤ê³  `internal()` ë©”ì„œë“œë¥¼ ì—¬ê¸°ë¡œ ì˜®ê²¼ë‹¤.
- ì´ë ‡ê²Œ ë©”ì„œë“œ ë‚´ë¶€ í˜¸ì¶œì„ ì™¸ë¶€ í˜¸ì¶œë¡œ ë³€ê²½í–ˆë‹¤.
- `CallService`ì—ëŠ” íŠ¸ëœì­ì…˜ ê´€ë ¨ ì½”ë“œê°€ ì „í˜€ ì—†ìœ¼ë¯€ë¡œ íŠ¸ëœì­ì…˜ í”„ë¡ì‹œê°€ ì ìš©ë˜ì§€ ì•ŠëŠ”ë‹¤.
- `InternalService`ì—ëŠ” íŠ¸ëœì­ì…˜ ê´€ë ¨ ì½”ë“œê°€ ìˆìœ¼ë¯€ë¡œ íŠ¸ëœì­ì…˜ í”„ë¡ì‹œê°€ ì ìš©ëœë‹¤.

![Untitled 9](https://github.com/soohyunnn/spring-db-2/assets/58289675/b026a319-fbbe-4259-8da6-7ec00ab2a4eb)

ì‹¤ì œ í˜¸ì¶œë˜ëŠ” íë¦„ì„ ë¶„ì„í•´ë³´ì.

1. í´ë¼ì´ì–¸íŠ¸ì¸ í…ŒìŠ¤íŠ¸ ì½”ë“œëŠ” `callService.external()`ì„ í˜¸ì¶œí•œë‹¤.
2. `callService`ëŠ” ì‹¤ì œ `callService` ê°ì²´ ì¸ìŠ¤í„´ìŠ¤ì´ë‹¤.
3. `callService`ëŠ” ì£¼ì… ë°›ì€ `internalService.internal()`ì„ í˜¸ì¶œí•œë‹¤.
4. `internalService`ëŠ” íŠ¸ëœì­ì…˜ í”„ë¡ì‹œì´ë‹¤. `internal()` ë©”ì„œë“œì— `@Transactional`ì´ ë¶™ì–´ìˆìœ¼ë¯€ë¡œ íŠ¸ëœì­ì…˜ í”„ë¡ì‹œëŠ” íŠ¸ëœì­ì…˜ì„ ì ìš©í•œë‹¤.
5. íŠ¸ëœì­ì…˜ ì ìš© í›„ ì‹¤ì œ `internalService` ê°ì²´ ì¸ìŠ¤í„´ìŠ¤ì˜ `internal()`ì„ í˜¸ì¶œí•œë‹¤.

**ì‹¤í–‰ ë¡œê·¸ - externalCallV2()**

```prolog
# external()
InternalCallV2Test$CallService     : call external
InternalCallV2Test$CallService     : tx active=false

# internal()
TransactionInterceptor             : Getting transaction for [hello.springtx.apply.InternalCallV2Test$InternalService.internal]
InternalCallV2Test$InternalService : call internal
InternalCallV2Test$InternalService : tx active=true
TransactionInterceptor             : Completing transaction for [hello.springtx.apply.InternalCallV2Test$InternalService.internal]
```

- `TransactionInterceptor`ë¥¼ í†µí•´ íŠ¸ëœì­ì…˜ì´ ì ìš©ë˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.
- `InternalService`ì˜ `tx active=true` ë¡œê·¸ë¥¼ í†µí•´ `internal()` í˜¸ì¶œì—ì„œ íŠ¸ëœì­ì…˜ì´ ì ìš©ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

ì—¬ëŸ¬ê°€ì§€ ë‹¤ë¥¸ í•´ê²°ë°©ì•ˆë„ ìˆì§€ë§Œ, ì‹¤ë¬´ì—ì„œëŠ” ì´ë ‡ê²Œ ë³„ë„ì˜ í´ë˜ìŠ¤ë¡œ ë¶„ë¦¬í•˜ëŠ” ë°©ë²•ì„ ì£¼ë¡œ ì‚¬ìš©í•œë‹¤.

> ğŸ’¡ì°¸ê³ 
ìŠ¤í”„ë§ í•µì‹¬ì›ë¦¬ ê³ ê¸‰í¸ 1.3 ì‹¤ë¬´ ì£¼ì˜ ì‚¬í•­ - í”„ë¡ì‹œì™€ ë‚´ë¶€ í˜¸ì¶œ ë¬¸ì œì—ì„œ ë” ë‹¤ì–‘í•œ í•´ê²° ë°©ì•ˆì„ ì†Œê°œí•œë‹¤.
> 

### public ë©”ì„œë“œë§Œ íŠ¸ëœì­ì…˜ ì ìš©

ìŠ¤í”„ë§ì˜ íŠ¸ëœì­ì…˜ AOP ê¸°ëŠ¥ì€ `public` ë©”ì„œë“œì—ë§Œ íŠ¸ëœì­ì…˜ì„ ì ìš©í•˜ë„ë¡ ê¸°ë³¸ ì„¤ì •ì´ ë˜ì–´ìˆë‹¤.

ê·¸ë˜ì„œ `protected`, `private`, `package-visible`ì—ëŠ” íŠ¸ëœì­ì…˜ì´ ì ìš©ë˜ì§€ ì•ŠëŠ”ë‹¤. ìƒê°í•´ë³´ë©´ `protected`, `package-visible`ë„ ì™¸ë¶€ì—ì„œ í˜¸ì¶œì´ ê°€ëŠ¥í•˜ë‹¤. ë”°ë¼ì„œ ì´ ë¶€ë¶„ì€ ì•ì„œ ì„¤ëª…í•œ í”„ë¡ì‹œì˜ ë‚´ë¶€ í˜¸ì¶œê³¼ëŠ” ë¬´ê´€í•˜ê³ , ìŠ¤í”„ë§ì´ ë§‰ì•„ë‘” ê²ƒì´ë‹¤.

ìŠ¤í”„ë§ì´ `public`ì—ë§Œ íŠ¸ëœì­ì…˜ì„ ì ìš©í•˜ëŠ” ì´ìœ ëŠ” ë‹¤ìŒê³¼ ê°™ë‹¤.

```java
@Transactional
public class Hello {
	  public method1();
	  method2():
	  protected method3();
	  private method4();
}
```

- ì´ë ‡ê²Œ í´ë˜ìŠ¤ ë ˆë²¨ì— íŠ¸ëœì­ì…˜ì„ ì ìš©í•˜ë©´ ëª¨ë“  ë©”ì„œë“œì— íŠ¸ëœì­ì…˜ì´ ê±¸ë¦´ ìˆ˜ ìˆë‹¤. ê·¸ëŸ¬ë©´ íŠ¸ëœì­ì…˜ì„ ì˜ë„í•˜ì§€ ì•ŠëŠ” ê³³ê¹Œì§€ íŠ¸ëœì­ì…˜ì´ ê³¼ë„í•˜ê²Œ ì ìš©ëœë‹¤. íŠ¸ëœì­ì…˜ì€ ì£¼ë¡œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì˜ ì‹œì‘ì ì— ê±¸ê¸°ë•Œë¬¸ì— ëŒ€ë¶€ë¶„ ì™¸ë¶€ì— ì—´ì–´ì¤€ ê³³ì„ ì‹œì‘ì ìœ¼ë¡œ ì‚¬ìš©í•œë‹¤. ì´ëŸ° ì´ìœ ë¡œ `public` ë©”ì„œë“œì—ë§Œ íŠ¸ëœì­ì…˜ì„ ì ìš©í•˜ë„ë¡ ì„¤ì •ë˜ì–´ ìˆë‹¤.
- ì•ì„œ ì‹¤í–‰í–ˆë˜ ì½”ë“œë¥¼ `package-visible`ë¡œ ë³€ê²½í•´ë³´ë©´ ì ìš©ë˜ì§€ ì•ŠëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

ì°¸ê³ ë¡œ `public`ì´ ì•„ë‹Œê³³ì— `@Transactional`ì´ ë¶™ì–´ ìˆìœ¼ë©´ ì˜ˆì™¸ê°€ ë°œìƒí•˜ì§€ëŠ” ì•Šê³ , íŠ¸ëœì­ì…˜ ì ìš©ë§Œ ë¬´ì‹œëœë‹¤.

> ğŸ’¡ì°¸ê³ :Â ìŠ¤í”„ë§ ë¶€íŠ¸ 3.0
ìŠ¤í”„ë§ ë¶€íŠ¸ 3.0 ë¶€í„°ëŠ” `protected`, `package-visible`(default ì ‘ê·¼ì œí•œì)ì—ë„ íŠ¸ëœì­ì…˜ì´ ì ìš©ëœë‹¤.
> 

## íŠ¸ëœì­ì…˜ AOP ì£¼ì˜ ì‚¬í•­ - ì´ˆê¸°í™” ì‹œì 

ìŠ¤í”„ë§ ì´ˆê¸°í™” ì‹œì ì—ëŠ” íŠ¸ëœì­ì…˜ AOPê°€ ì ìš©ë˜ì§€ ì•Šì„ ìˆ˜ ìˆë‹¤.

ì˜ˆì œ ì½”ë“œë¥¼ ë³´ì.

```java
package hello.springtx.apply;

import jakarta.annotation.PostConstruct;
import lombok.extern.slf4j.Slf4j;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.context.event.ApplicationReadyEvent;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.boot.test.context.TestConfiguration;
import org.springframework.context.annotation.Bean;
import org.springframework.context.event.EventListener;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.transaction.support.TransactionSynchronizationManager;

@SpringBootTest
public class InitTxTest {

    @Autowired
    Hello hello;

    @Test
    void go() {
        //ì´ˆê¸°í™” ì½”ë“œëŠ” ìŠ¤í”„ë§ì´ ì´ˆê¸°í™” ì‹œì ì— í˜¸ì¶œí•œë‹¤.
    }

    @TestConfiguration
    static class InitTxTestConfig {
        @Bean
        Hello hello() {
            return new Hello();
        }
    }

    @Slf4j
    static class Hello {

        @PostConstruct
        @Transactional
        public void initV1() {
            boolean isActive = TransactionSynchronizationManager.isActualTransactionActive();
            log.info("Hello init @PostConstruct, tx active={}", isActive);
        }

        @EventListener(value = ApplicationReadyEvent.class)
        @Transactional
        public void init2() {
            boolean isActive = TransactionSynchronizationManager.isActualTransactionActive();
            log.info("Hello init ApplicationReadyEvent tx active={}", isActive);
        }
    }

}
```

í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•´ë³´ì.

ì´ˆê¸°í™” ì½”ë“œ(ì˜ˆ: `@PostConstruct`)ì™€ `@Transactional`ì„ í•¨ê»˜ ì‚¬ìš©í•˜ë©´ íŠ¸ëœì­ì…˜ì´ ì ìš©ë˜ì§€ ì•ŠëŠ”ë‹¤.

```java
@PostConstruct
@Transactional
public void initV1() {
    log.info("Hello init @PostConstruct");
}
```

ì™œëƒí•˜ë©´ ì´ˆê¸°í™” ì½”ë“œê°€ ë¨¼ì € í˜¸ì¶œë˜ê³ , ê·¸ ë‹¤ìŒì— íŠ¸ëœì­ì…˜ AOPê°€ ì ìš©ë˜ê¸° ë•Œë¬¸ì´ë‹¤. ë”°ë¼ì„œ ì´ˆê¸°í™” ì‹œì ì—ëŠ” í•´ë‹¹ ë©”ì„œë“œì—ì„œ íŠ¸ëœì­ì…˜ì„ íšë“í•  ìˆ˜ ì—†ë‹¤.

**initV1() ê´€ë ¨ ë¡œê·¸**

```java
Hello init @PostConstruct tx active=false
```

ê°€ì¥ í™•ì‹¤í•œ ëŒ€ì•ˆì€ `ApplicationReadyEvent` ì´ë²¤íŠ¸ë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ë‹¤.

```java
@EventListener(value = ApplicationReadyEvent.class)
@Transactional
public void init2() {
    log.info("Hello init ApplicationReadyEvent");
}
```

ì´ ì´ë²¤íŠ¸ëŠ” íŠ¸ëœì­ì…˜ AOPë¥¼ í¬í•¨í•œ ìŠ¤í”„ë§ì´ ì»¨í…Œì´ë„ˆê°€ ì™„ì „íˆ ìƒì„±ë˜ê³  ë‚œ ë‹¤ìŒì— ì´ë²¤íŠ¸ê°€ ë¶™ì€ ë©”ì„œë“œë¥¼ í˜¸ì¶œí•´ì¤€ë‹¤. ë”°ë¼ì„œ init2()ëŠ” íŠ¸ëœì­ì…˜ì´ ì ìš©ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

**init2()** `ApplicationReadEvent` ì´ë²¤íŠ¸ê°€ í˜¸ì¶œí•˜ëŠ” ì½”ë“œ

```prolog
TransactionInterceptor           : Getting transaction for [hello.springtx.apply.InitTxTest$Hello.init2]
InitTxTest$Hello                 : Hello init ApplicationReadyEvent tx active=true
TransactionInterceptor           : Completing transaction for [hello.springtx.apply.InitTxTest$Hello.init2]
```

## íŠ¸ëœì­ì…˜ ì˜µì…˜ ì†Œê°œ

ìŠ¤í”„ë§ íŠ¸ëœì­ì…˜ì€ ë‹¤ì–‘í•œ ì˜µì…˜ì„ ì œê³µí•œë‹¤. ì´ë²ˆ ì‹œê°„ì—ëŠ” ê°ê°ì˜ ì˜µì…˜ë“¤ì„ ê°„ëµí•˜ê²Œ ì†Œê°œí•˜ê² ë‹¤. ê·¸ë¦¬ê³  ì£¼ìš”í•œ ì˜µì…˜ë“¤ì€ ì´í›„ ì¥ì—ì„œ í•˜ë‚˜ì”© ìì„¸íˆ ì„¤ëª…í•˜ê² ë‹¤.

**@Transactional - ì½”ë“œ, ì„¤ëª… ìˆœì„œì— ë”°ë¼ ì•½ê°„ ìˆ˜ì •í–ˆìŒ**

```java
public @interface Transactional {

    String value() default "";
    String transactionManager() default "";

    Class<? extends Throwable>[] rollbackFor() default {};
    Class<? extends Throwable>[] noRollbackFor() default {};
		Propagation propagation() default Propagation.REQUIRED;
    Isolation isolation() default Isolation.DEFAULT;
    int timeout() default TransactionDefinition.TIMEOUT_DEFAULT;
    boolean readOnly() default false;
    String[] label() default {};
}
```

### value, transactionManager

íŠ¸ëœì­ì…˜ì„ ì‚¬ìš©í•˜ë ¤ë©´ ë¨¼ì € ìŠ¤í”„ë§ ë¹ˆì— ë“±ë¡ëœ ì–´ë–¤ íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì €ë¥¼ ì‚¬ìš©í• ì§€ ì•Œì•„ì•¼ í•œë‹¤.

ìƒê°í•´ë³´ë©´ ì½”ë“œë¡œ ì§ì ‘ íŠ¸ëœì­ì…˜ì„ ì‚¬ìš©í•  ë•Œ ë¶„ëª… íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì €ë¥¼ ì£¼ì… ë°›ì•„ì„œ ì‚¬ìš©í–ˆë‹¤.

`@Transactional`ì—ì„œë„ íŠ¸ëœì­ì…˜ í”„ë¡ì‹œê°€ ì‚¬ìš©í•  íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì €ë¥¼ ì§€ì •í•´ì£¼ì–´ì•¼ í•œë‹¤.

ì‚¬ìš©í•  íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì €ë¥¼ ì§€ì •í•  ë•ŒëŠ” `value`, `transactionManager` ë‘˜ ì¤‘ í•˜ë‚˜ì— íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì €ì˜ ìŠ¤í”„ë§ ë¹ˆì˜ ì´ë¦„ì„ ì ì–´ì£¼ë©´ ëœë‹¤.

ì´ ê°’ì„ ìƒëµí•˜ë©´ ê¸°ë³¸ìœ¼ë¡œ ë“±ë¡ëœ íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì €ë¥¼ ì‚¬ìš©í•˜ê¸° ë•Œë¬¸ì— ëŒ€ë¶€ë¶„ ìƒëµí•œë‹¤. ê·¸ëŸ°ë° ì‚¬ìš©í•˜ëŠ” íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì €ê°€ ë‘˜ ì´ìƒì´ë¼ë©´ ë‹¤ìŒê³¼ ê°™ì´ íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì €ì˜ ì´ë¦„ì„ ì§€ì •í•´ì„œ êµ¬ë¶„í•˜ë©´ ëœë‹¤.

```java
public class TxService {

    @Transactional("memberTxManager")
    public void member() {...}

    @Transactional("orderTxManager")
    public void order() {...}

}
```

ì°¸ê³ ë¡œ ì–´ë…¸í…Œì´ì…˜ì—ì„œ ì†ì„±ì´ í•˜ë‚˜ì¸ ê²½ìš° ìœ„ ì˜ˆì²˜ëŸ¼ `value`ëŠ” ìƒëµí•˜ê³  ê°’ì„ ë°”ë¡œ ë„£ì„ ìˆ˜ ìˆë‹¤.

### rollbackFor

ì˜ˆì™¸ ë°œìƒì‹œ ìŠ¤í”„ë§ íŠ¸ëœì­ì…˜ì˜ ê¸°ë³¸ ì •ì±…ì€ ë‹¤ìŒê³¼ ê°™ë‹¤.

- ì–¸ì²´í¬ ì˜ˆì™¸ì¸ `RuntimeException`, `Error`ì™€ ê·¸ í•˜ìœ„ ì˜ˆì™¸ê°€ ë°œìƒí•˜ë©´ ë¡¤ë°±í•œë‹¤.
- ì²´í¬ ì˜ˆì™¸ì¸ `Exception`ê³¼ ê·¸ í•˜ìœ„ ì˜ˆì™¸ë“¤ì€ ì»¤ë°‹í•œë‹¤.

ì´ ì˜µì…˜ì„ ì‚¬ìš©í•˜ë©´ ê¸°ë³¸ ì •ì±…ì— ì¶”ê°€ë¡œ ì–´ë–¤ ì˜ˆì™¸ê°€ ë°œìƒí•  ë•Œ ë¡¤ë°±í•  ì§€ ì§€ì •í•  ìˆ˜ ìˆë‹¤.

```java
@Transactional(rollbackFor = Exception.class)
```

ì˜ˆë¥¼ ë“¤ì–´ì„œ ì´ë ‡ê²Œ ì§€ì •í•˜ë©´ ì²´í¬ ì˜ˆì™¸ì¸ `Exception`ì´ ë°œìƒí•´ë„ ë¡¤ë°±í•˜ê²Œ ëœë‹¤. (í•˜ìœ„ ì˜ˆì™¸ë“¤ë„ ëŒ€ìƒì— í¬í•¨ëœë‹¤.)

`rollbackForClassName`ë„ ìˆëŠ”ë°, `rollbackFor`ëŠ” ì˜ˆì™¸ í´ë˜ìŠ¤ë¥¼ ì§ì ‘ ì§€ì •í•˜ê³ , `rollbackForClassName`ëŠ” ì˜ˆì™¸ ì´ë¦„ì„ ë¬¸ìë¡œ ë„£ìœ¼ë©´ ëœë‹¤.

### noRollbackFor

ì•ì„œ ì„¤ëª…í•œ `rollbackFor`ì™€ ë°˜ëŒ€ì´ë‹¤. ê¸°ë³¸ ì •ì±…ì— ì¶”ê°€ë¡œ ì–´ë–¤ ì˜ˆì™¸ê°€ ë°œìƒí–ˆì„ ë•Œ ë¡¤ë°±í•˜ë©´ ì•ˆë˜ëŠ”ì§€ ì§€ì •í•  ìˆ˜ ìˆë‹¤.

ì˜ˆì™¸ ì´ë¦„ì„ ë¬¸ìë¡œ ë„£ì„ ìˆ˜ ìˆëŠ” `noRollbackForClassName`ë„ ìˆë‹¤.

ë¡¤ë°± ê´€ë ¨ ì˜µì…˜ì— ëŒ€í•œ ë” ìì„¸í•œ ë‚´ìš©ì€ ë’¤ì—ì„œ ë” ìì„¸íˆ ì„¤ëª…í•œë‹¤.

### propagation

íŠ¸ëœì­ì…˜ ì „íŒŒì— ëŒ€í•œ ì˜µì…˜ì´ë‹¤. ìì„¸í•œ ë‚´ìš©ì€ ë’¤ì—ì„œ ì„¤ëª…í•œë‹¤.

### isolation

íŠ¸ëœì­ì…˜ ê²©ë¦¬ ìˆ˜ì¤€ì„ ì§€ì •í•  ìˆ˜ ìˆë‹¤. ê¸°ë³¸ ê°’ì€ ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ì„¤ì •í•œ íŠ¸ëœì­ì…˜ ê²©ë¦¬ ìˆ˜ì¤€ì„ ì‚¬ìš©í•˜ëŠ” `DEFAULT`ì´ë‹¤. ëŒ€ë¶€ë¶„ ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ì„¤ì •í•œ ê¸°ì¤€ì„ ë”°ë¥¸ë‹¤. ì• í”Œë¦¬ì¼€ì´ì…˜ ê°œë°œìê°€ íŠ¸ëœì­ì…˜ ê²©ë¦¬ ìˆ˜ì¤€ì„ ì§ì ‘ ì§€ì •í•˜ëŠ” ê²½ìš°ëŠ” ë“œë¬¼ë‹¤.

- `DEFAULT` : ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ì„¤ì •í•œ ê²©ë¦¬ ìˆ˜ì¤€ì„ ë”°ë¥¸ë‹¤.
- `READ_UNCOMMITTED` : ì»¤ë°‹ë˜ì§€ ì•Šì€ ì½ê¸°
- `READ_COMITTED` : ì»¤ë°‹ëœ ì½ê¸°
- `REPEATABLE_READ` : ë°˜ë³µ ê°€ëŠ¥í•œ ì½ê¸°
- `SERIALIZABLE` : ì§ë ¬í™” ê°€ëŠ¥

> ğŸ’¡ì°¸ê³  : ê°•ì˜ì—ì„œëŠ” ì¼ë°˜ì ìœ¼ë¡œ ë§ì´ ì‚¬ìš©í•˜ëŠ” READ COMMITTED(ì»¤ë°‹ëœ ì½ê¸°) íŠ¸ëœì­ì…˜ ê²©ë¦¬ ìˆ˜ì¤€ì„ ê¸°ì¤€ìœ¼ë¡œ ì„¤ëª…í•œë‹¤.
íŠ¸ëœì­ì…˜ ê²©ë¦¬ ìˆ˜ì¤€ì— ëŒ€í•œ ë” ìì„¸í•œ ë‚´ìš©ì€ ë°ì´í„°ë² ì´ìŠ¤ ë©”ë‰´ì–¼ì´ë‚˜, JPA ì±… 16.1 íŠ¸ëœì­ì…˜ê³¼ ë½ì„ ì°¸ê³ í•˜ì.
> 

### timeout

íŠ¸ëœì­ì…˜ ìˆ˜í–‰ ì‹œê°„ì— ëŒ€í•œ íƒ€ì„ì•„ì›ƒì„ ì´ˆ ë‹¨ìœ„ë¡œ ì§€ì •í•œë‹¤. ê¸°ë³¸ ê°’ì€ íŠ¸ëœì­ì…˜ ì‹œìŠ¤í…œì˜ íƒ€ì„ì•„ì›ƒì„ ì‚¬ìš©í•œë‹¤. ìš´ì˜ í™˜ê²½ì— ë”°ë¼ ë™ì‘í•˜ëŠ” ê²½ìš°ë„ ìˆê³  ê·¸ë ‡ì§€ ì•Šì€ ê²½ìš°ë„ ìˆê¸° ë•Œë¬¸ì— ê¼­ í™•ì¸í•˜ê³  ì‚¬ìš©í•´ì•¼ í•œë‹¤.

`timeoutString`ë„ ìˆëŠ”ë°, ìˆ«ì ëŒ€ì‹  ë¬¸ì ê°’ìœ¼ë¡œ ì§€ì •í•  ìˆ˜ ìˆë‹¤.

### label

íŠ¸ëœì­ì…˜ ì–´ë…¸í…Œì´ì…˜ì— ìˆëŠ” ê°’ì„ ì§ì ‘ ì½ì–´ì„œ ì–´ë–¤ ë™ì‘ì„ í•˜ê³  ì‹¶ì„ ë•Œ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤. ì¼ë°˜ì ìœ¼ë¡œ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ”ë‹¤.

### readOnly

íŠ¸ëœì­ì…˜ì€ ê¸°ë³¸ì ìœ¼ë¡œ ì½ê¸° ì“°ê¸°ê°€ ëª¨ë‘ ê°€ëŠ¥í•œ íŠ¸ëœì­ì…˜ì´ ìƒì„±ëœë‹¤.

`readOnly=true` ì˜µì…˜ì„ ì‚¬ìš©í•˜ë©´ ì½ê¸° ì „ìš© íŠ¸ëœì­ì…˜ì´ ìƒì„±ëœë‹¤. ì´ ê²½ìš° ë“±ë¡, ìˆ˜ì •, ì‚­ì œê°€ ì•ˆë˜ê³  ì½ê¸° ê¸°ëŠ¥ë§Œ ì‘ë™í•œë‹¤. (ë“œë¼ì´ë²„ë‚˜ ë°ì´í„°ë² ì´ìŠ¤ì— ë”°ë¼ ì •ìƒ ë™ì‘í•˜ì§€ ì•ŠëŠ” ê²½ìš°ë„ ìˆë‹¤.) ê·¸ë¦¬ê³  `readOnly` ì˜µì…˜ì„ ì‚¬ìš©í•˜ë©´ ì½ê¸°ì—ì„œ ë‹¤ì–‘í•œ ì„±ëŠ¥ ìµœì í™”ê°€ ë°œìƒí•  ìˆ˜ ìˆë‹¤.

`readOnly` ì˜µì…˜ì€ í¬ê²Œ 3ê³³ì—ì„œ ì ìš©ëœë‹¤.

- **í”„ë ˆì„ì›Œí¬**
    - JdbcTemplateì€ ì½ê¸° ì „ìš© íŠ¸ëœì­ì…˜ ì•ˆì—ì„œ ë³€ê²½ ê¸°ëŠ¥ì„ ì‹¤í–‰í•˜ë©´ ì˜ˆì™¸ë¥¼ ë˜ì§„ë‹¤.
    - JPA(í•˜ì´ë²„ë„¤ì´íŠ¸)ëŠ” ì½ê¸° ì „ìš© íŠ¸ëœì­ì…˜ì˜ ê²½ìš° ì»¤ë°‹ ì‹œì ì— í”ŒëŸ¬ì‹œë¥¼ í˜¸ì¶œí•˜ì§€ ì•ŠëŠ”ë‹¤. ì½ê¸° ì „ìš©ì´ë‹ˆ ë³€ê²½ì— ì‚¬ìš©ë˜ëŠ” í”ŒëŸ¬ì‹œë¥¼ í˜¸ì¶œí•  í•„ìš”ê°€ ì—†ë‹¤. ì¶”ê°€ë¡œ ë³€ê²½ì´ í•„ìš” ì—†ìœ¼ë‹ˆ ë³€ê²½ ê°ì§€ë¥¼ ìœ„í•œ ìŠ¤ëƒ…ìƒ· ê°ì²´ë„ ìƒì„±í•˜ì§€ ì•ŠëŠ”ë‹¤. ì´ë ‡ê²Œ JPAì—ì„œëŠ” ë‹¤ì–‘í•œ ìµœì í™”ê°€ ë°œìƒí•œë‹¤.
        - JPA ê´€ë ¨ ë‚´ìš©ì€ JPAë¥¼ ë” í•™ìŠµí•´ì•¼ ì´í•´í•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì§€ê¸ˆì€ ì´ëŸ° ê²ƒì´ ìˆë‹¤ ì •ë„ë§Œ ì•Œì•„ë‘ì.
- JDBC ë“œë¼ì´ë²„
    - ì°¸ê³ ë¡œ ì—¬ê¸°ì„œ ì„¤ëª…í•˜ëŠ” ë‚´ìš©ë“¤ì€ DBì™€ ë“œë¼ì´ë²„ ë²„ì „ì— ë”°ë¼ì„œ ë‹¤ë¥´ê²Œ ë™ì‘í•˜ê¸° ë•Œë¬¸ì— ì‚¬ì „ì— í™•ì¸ì´ í•„ìš”í•˜ë‹¤.
    - ì½ê¸° ì „ìš© íŠ¸ëœì­ì…˜ì—ì„œ ë³€ê²½ ì¿¼ë¦¬ê°€ ë°œìƒí•˜ë©´ ì˜ˆì™¸ë¥¼ ë˜ì§„ë‹¤.
    - ì½ê¸°, ì“°ê¸°(ë§ˆìŠ¤í„°, ìŠ¬ë ˆì´ë¸Œ) ë°ì´í„°ë² ì´ìŠ¤ë¥¼ êµ¬ë¶„í•´ì„œ ìš”ì²­í•œë‹¤. ì½ê¸° ì „ìš© íŠ¸ëœì­ì…˜ì˜ ê²½ìš° ì½ê¸°(ìŠ¬ë ˆì´ë¸Œ) ë°ì´í„°ë² ì´ìŠ¤ì˜ ì»¤ë„¥ì…˜ì„ íšë“í•´ì„œ ì‚¬ìš©í•œë‹¤.
        
        [MySQL :: MySQL Connector/J 8.0 Developer Guide :: 9.4 Configuring Source/Replica Replication with Connector/J](https://dev.mysql.com/doc/connector-j/8.0/en/connector-j-source-replica-replication-connection.html)
        
- **ë°ì´í„°ë² ì´ìŠ¤**
    - ë°ì´í„°ë² ì´ìŠ¤ì— ë”°ë¼ ì½ê¸° ì „ìš© íŠ¸ëœì­ì…˜ì˜ ê²½ìš° ì½ê¸°ë§Œ í•˜ë©´ ë˜ë¯€ë¡œ, ë‚´ë¶€ì—ì„œ ì„±ëŠ¥ ìµœì í™”ê°€ ë°œìƒí•œë‹¤.

## ì˜ˆì™¸ì™€ íŠ¸ëœì­ì…˜ ì»¤ë°‹, ë¡¤ë°± - ê¸°ë³¸

ì˜ˆì™¸ê°€ ë°œìƒí–ˆëŠ”ë°, ë‚´ë¶€ì—ì„œ ì˜ˆì™¸ë¥¼ ì²˜ë¦¬í•˜ì§€ ëª»í•˜ê³ , íŠ¸ëœì­ì…˜ ë²”ìœ„(@Transactionalê°€ ì ìš©ëœ AOP) ë°–ìœ¼ë¡œ ì˜ˆì™¸ë¥¼ ë˜ì§€ë©´ ì–´ë–»ê²Œ ë ê¹Œ?

![Untitled 10](https://github.com/soohyunnn/spring-db-2/assets/58289675/ad21eefa-b0f1-436d-9e05-afb81825c35e)

ì˜ˆì™¸ ë°œìƒì‹œ ìŠ¤í”„ë§ íŠ¸ëœì­ì…˜ AOPëŠ” ì˜ˆì™¸ì˜ ì¢…ë¥˜ì— ë”°ë¼ íŠ¸ëœì­ì…˜ì„ ì»¤ë°‹í•˜ê±°ë‚˜ ë¡¤ë°±í•œë‹¤.

- ì–¸ì²´í¬ ì˜ˆì™¸ì¸ RuntimeException, Errorì™€ ê·¸ í•˜ìœ„ ì˜ˆì™¸ê°€ ë°œìƒí•˜ë©´ íŠ¸ëœì­ì…˜ì„ ë¡¤ë°±í•œë‹¤.
- ì²´í¬ ì˜ˆì™¸ì¸ Exceptionê³¼ ê·¸ í•˜ìœ„ ì˜ˆì™¸ê°€ ë°œìƒí•˜ë©´ íŠ¸ëœì­ì…˜ì„ ì»¤ë°‹í•œë‹¤.
- ë¬¼ë¡  ì •ìƒ ì‘ë‹µ(ë¦¬í„´)í•˜ë©´ íŠ¸ëœì­ì…˜ì„ ì»¤ë°‹í•œë‹¤.

ì‹¤ì œ ì´ë ‡ê²Œ ë™ì‘í•˜ëŠ”ì§€ ì½”ë“œë¡œ í™•ì¸í•´ë³´ì.

RollbackTest

```java
package hello.springtx.exception;

import lombok.extern.slf4j.Slf4j;
import org.assertj.core.api.Assertions;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.boot.test.context.TestConfiguration;
import org.springframework.context.annotation.Bean;
import org.springframework.transaction.annotation.Transactional;

import static org.assertj.core.api.Assertions.assertThatThrownBy;

@SpringBootTest
public class RollbackTest {

    @Autowired
    RollbackService service;

    @Test
    void runtimeException() {
        assertThatThrownBy(() -> service.runtimeException())
                .isInstanceOf(RuntimeException.class);
    }

    @Test
    void checkedException() {
        assertThatThrownBy(() -> service.checkedException())
                .isInstanceOf(MyException.class);
    }

    @Test
    void rollbackFor() throws MyException {
        assertThatThrownBy(() -> service.rollbackFor())
                .isInstanceOf(MyException.class);
    }

    @TestConfiguration
    static class RollbackTestConfig {
        @Bean
        RollbackService rollbackService() {
            return new RollbackService();
        }
    }

    @Slf4j
    static class RollbackService {

        //ëŸ°íƒ€ì„ ì˜ˆì™¸ ë°œìƒ: ë¡¤ë°±
        @Transactional
        public void runtimeException() {
            log.info("call runtimeException");
            throw new RuntimeException();
        }

        //ì²´í¬ ì˜ˆì™¸ ë°œìƒ: ì»¤ë°‹
        @Transactional
        public void checkedException() throws MyException {
            log.info("call checkedException");
            throw new MyException();
        }

        //ì²´í¬ ì˜ˆì™¸ rollbackFor ì§€ì • : ë¡¤ë°±
        @Transactional(rollbackFor = MyException.class)
        public void rollbackFor() throws MyException {
            log.info("call rollbackFor");
            throw new MyException();
        }

    }

    static class MyException extends Exception {
    }

}
```

ì‹¤í–‰í•˜ê¸° ì „ì— ë‹¤ìŒì„ ì¶”ê°€í•˜ì. ì´ë ‡ê²Œ í•˜ë©´ íŠ¸ëœì­ì…˜ì´ ì»¤ë°‹ë˜ì—ˆëŠ”ì§€ ë¡¤ë°± ë˜ì—ˆëŠ”ì§€ ë¡œê·¸ë¡œ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

`application.properties`

```java
logging.level.org.springframework.transaction.interceptor=TRACE
logging.level.org.springframework.jdbc.datasource.DataSourceTransactionManager=DEBUG

#JPA log
logging.level.org.springframework.orm.jpa.JpaTransactionManager=DEBUG
logging.level.org.hibernate.resource.transaction=DEBUG
```

ì°¸ê³ ë¡œ ì§€ê¸ˆì€ JPAë¥¼ ì‚¬ìš©í•˜ë¯€ë¡œ íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì €ë¡œ `JpaTransactionManager`ê°€ ì‹¤í–‰ë˜ê³ , ì—¬ê¸°ì˜ ë¡œê·¸ë¥¼ ì¶œë ¥í•˜ê²Œ ëœë‹¤.

ì´ì œ í•˜ë‚˜ì”© ì‹¤í–‰í•˜ë©´ì„œ ê²°ê³¼ë¥¼ í™•ì¸í•´ë³´ì.

**runtimeException()ì‹¤í–‰ - ëŸ°íƒ€ì„ ì˜ˆì™¸**

```java
//ëŸ°íƒ€ì„ ì˜ˆì™¸ ë°œìƒ: ë¡¤ë°±
@Transactional
public void runtimeException() {
    log.info("call runtimeException");
    throw new RuntimeException();
}
```

- `RuntimeException`ì´ ë°œìƒí•˜ë¯€ë¡œ íŠ¸ëœì­ì…˜ì´ ë¡¤ë°±ëœë‹¤.

```prolog
TransactionInterceptor           : Getting transaction for [hello.springtx.exception.RollbackTest$RollbackService.runtimeException]
RollbackTest$RollbackService     : call runtimeException
TransactionInterceptor           : Completing transaction for [hello.springtx.exception.RollbackTest$RollbackService.runtimeException] after exception: java.lang.RuntimeException
jpa.JpaTransactionManager        : Initiating transaction rollback
```

**checkedException() ì‹¤í–‰ - ì²´í¬ ì˜ˆì™¸**

```java
//ì²´í¬ ì˜ˆì™¸ ë°œìƒ: ì»¤ë°‹
@Transactional
public void checkedException() throws MyException {
    log.info("call checkedException");
    throw new MyException();
}
```

- `MyException`ì€ `Exception`ì„ ìƒì†ë°›ì€ ì²´í¬ ì˜ˆì™¸ì´ë‹¤. ë”°ë¼ì„œ ì˜ˆì™¸ê°€ ë°œìƒí•´ë„ íŠ¸ëœì­ì…˜ì´ ì»¤ë°‹ëœë‹¤.

```prolog
TransactionInterceptor           : Getting transaction for [hello.springtx.exception.RollbackTest$RollbackService.checkedException]
RollbackTest$RollbackService     : call checkedException
TransactionInterceptor           : Completing transaction for [hello.springtx.exception.RollbackTest$RollbackService.checkedException] after exception: hello.springtx.exception.RollbackTest$MyException
jpa.JpaTransactionManager        : Initiating transaction commit
jpa.JpaTransactionManager        : Committing JPA transaction on EntityManager [SessionImpl(1359003971<open>)]
jpa.JpaTransactionManager        : Closing JPA EntityManager [SessionImpl(1359003971<open>)] after transaction
```

**rollbackFor**

ì´ ì˜µì…˜ì„ ì‚¬ìš©í•˜ë©´ ê¸°ë³¸ ì •ì±…ì— ì¶”ê°€ë¡œ ì–´ë–¤ ì˜ˆì™¸ê°€ ë°œìƒí•  ë•Œ ë¡¤ë°±í•  ì§€ ì§€ì •í•  ìˆ˜ ìˆë‹¤.

```java
@Transactional(rollbackFor = Exception.class)
```

ì˜ˆë¥¼ ë“¤ì–´ì„œ ì´ë ‡ê²Œ ì§€ì •í•˜ë©´ ì²´í¬ ì˜ˆì™¸ì¸ `Exception`ì´ ë°œìƒí•´ë„ ì»¤ë°‹ ëŒ€ì‹  ë¡¤ë°±ëœë‹¤. (ìì‹ íƒ€ì…ë„ ë¡¤ë°±ëœë‹¤.)

**rollbackFor() ì‹¤í–‰ - ì²´í¬ ì˜ˆì™¸ë¥¼ ê°•ì œë¡œ ë¡¤ë°±**

```java
//ì²´í¬ ì˜ˆì™¸ rollbackFor ì§€ì • : ë¡¤ë°±
@Transactional(rollbackFor = MyException.class)
public void rollbackFor() throws MyException {
    log.info("call rollbackFor");
    throw new MyException();
}
```

- ê¸°ë³¸ ì •ì±…ê³¼ ë¬´ê´€í•˜ê²Œ íŠ¹ì • ì˜ˆì™¸ë¥¼ ê°•ì œë¡œ ë¡¤ë°±í•˜ê³  ì‹¶ìœ¼ë©´ `rollbackFor`ë¥¼ ì‚¬ìš©í•˜ë©´ ëœë‹¤. (í•´ë‹¹ ì˜ˆì™¸ì˜ ìì‹ë„ í¬í•¨ëœë‹¤.)
- `rollbackFor = MyException.class`ì„ ì§€ì •í–ˆê¸° ë•Œë¬¸ì— `MyException`ì´ ë°œìƒí•˜ë©´ ì²´í¬ ì˜ˆì™¸ì´ì§€ë§Œ íŠ¸ëœì­ì…˜ì´ ë¡¤ë°±ëœë‹¤.

```prolog
TransactionInterceptor           : Getting transaction for [hello.springtx.exception.RollbackTest$RollbackService.rollbackFor]
RollbackTest$RollbackService     : call rollbackFor
TransactionInterceptor           : Completing transaction for [hello.springtx.exception.RollbackTest$RollbackService.rollbackFor] after exception: hello.springtx.exception.RollbackTest$MyException
jpa.JpaTransactionManager        : Initiating transaction rollback
jpa.JpaTransactionManager        : Rolling back JPA transaction on EntityManager [SessionImpl(994228009<open>)]
jpa.JpaTransactionManager        : Closing JPA EntityManager [SessionImpl(994228009<open>)] after transaction
```

## ì˜ˆì™¸ì™€ íŠ¸ëœì­ì…˜ ì»¤ë°‹, ë¡¤ë°± - í™œìš©

ìŠ¤í”„ë§ì€ ì™œ ì²´í¬ ì˜ˆì™¸ëŠ” ì»¤ë°‹í•˜ê³ , ì–¸ì²´í¬(ëŸ°íƒ€ì„) ì˜ˆì™¸ëŠ” ë¡¤ë°±í• ê¹Œ?

ìŠ¤í”„ë§ ê¸°ë³¸ì ìœ¼ë¡œ ì²´í¬ ì˜ˆì™¸ëŠ” ë¹„ì¦ˆë‹ˆìŠ¤ ì˜ë¯¸ê°€ ìˆì„ ë•Œ ì‚¬ìš©í•˜ê³ , ëŸ°íƒ€ì„(ì–¸ì²´í¬) ì˜ˆì™¸ëŠ” ë³µêµ¬ ë¶ˆê°€ëŠ¥í•œ ì˜ˆì™¸ë¡œ ê°€ì •í•œë‹¤.

- ì²´í¬ ì˜ˆì™¸: ë¹„ì¦ˆë‹ˆìŠ¤ ì˜ë¯¸ê°€ ìˆì„ ë•Œ ì‚¬ìš©
- ì–¸ì²´í¬ ì˜ˆì™¸: ë³µêµ¬ ë¶ˆê°€ëŠ¥í•œ ì˜ˆì™¸

ì°¸ê³ ë¡œ ê¼­ ì´ëŸ° ì •ì±…ì„ ë”°ë¥¼ í•„ìš”ëŠ” ì—†ë‹¤. ê·¸ë•ŒëŠ” ì•ì„œ ë°°ìš´ `rollbackFor`ë¼ëŠ” ì˜µì…˜ì„ ì‚¬ìš©í•´ì„œ ì²´í¬ ì˜ˆì™¸ë„ ë¡¤ë°±í•˜ë©´ ëœë‹¤.

ê·¸ëŸ°ë° ë¹„ì¦ˆë‹ˆìŠ¤ ì˜ë¯¸ê°€ ìˆëŠ” **ë¹„ì¦ˆë‹ˆìŠ¤ ì˜ˆì™¸**ë¼ëŠ” ê²ƒì´ ë¬´ìŠ¨ ëœ»ì¼ê¹Œ? ê°„ë‹¨í•œ ì˜ˆì œë¡œ ì•Œì•„ë³´ì.

### ë¹„ì¦ˆë‹ˆìŠ¤ ìš”êµ¬ì‚¬í•­

ì£¼ë¬¸ì„ í•˜ëŠ”ë° ìƒí™©ì— ë”°ë¼ ë‹¤ìŒê³¼ ê°™ì´ ì¡°ì¹˜í•œë‹¤.

1. **ì •ìƒ** : ì£¼ë¬¸ì‹œ ê²°ì œë¥¼ ì„±ê³µí•˜ë©´ ì£¼ë¬¸ ë°ì´í„°ë¥¼ ì €ì¥í•˜ê³  ê²°ì œ ìƒíƒœë¥¼ `ì™„ë£Œ`ë¡œ ì²˜ë¦¬í•œë‹¤.
2. **ì‹œìŠ¤í…œ ì˜ˆì™¸**: ì£¼ë¬¸ì‹œ ë‚´ë¶€ì— ë³µêµ¬ ë¶ˆê°€ëŠ¥í•œ ì˜ˆì™¸ê°€ ë°œìƒí•˜ë©´ ì „ì²´ ë°ì´í„°ë¥¼ ë¡¤ë°±í•œë‹¤.
3. **ë¹„ì¦ˆë‹ˆìŠ¤ ì˜ˆì™¸**: ì£¼ë¬¸ì‹œ ê²°ì œ ì”ê³ ê°€ ë¶€ì¡±í•˜ë©´ ì£¼ë¬¸ ë°ì´í„°ë¥¼ ì €ì¥í•˜ê³ , ê²°ì œ ìƒíƒœë¥¼ `ëŒ€ê¸°`ë¡œ ì²˜ë¦¬í•œë‹¤.
    - ì´ ê²½ìš° **ê³ ê°ì—ê²Œ ì”ê³  ë¶€ì¡±ì„ ì•Œë¦¬ê³  ë³„ë„ì˜ ê³„ì¢Œë¡œ ì…ê¸ˆí•˜ë„ë¡ ì•ˆë‚´í•œë‹¤.**

ì´ë•Œ ê²°ì œ ì”ê³ ê°€ ë¶€ì¡±í•˜ë©´ `NotEnoughMoneyException`ì´ë¼ëŠ” ì²´í¬ ì˜ˆì™¸ê°€ ë°œìƒí•œë‹¤ê³  ê°€ì •í•˜ê² ë‹¤. ì´ ì˜ˆì™¸ëŠ” ì‹œìŠ¤í…œì— ë¬¸ì œê°€ ìˆì–´ì„œ ë°œìƒí•˜ëŠ” ì‹œìŠ¤í…œ ì˜ˆì™¸ê°€ ì•„ë‹ˆë‹¤. ì‹œìŠ¤í…œì€ ì •ìƒ ë™ì‘í–ˆì§€ë§Œ, ë¹„ì¦ˆë‹ˆìŠ¤ ìƒí™©ì—ì„œ ë¬¸ì œê°€ ë˜ê¸° ë•Œë¬¸ì— ë°œìƒí•œ ì˜ˆì™¸ì´ë‹¤. ë” ìì„¸íˆ ì„¤ëª…í•˜ìë©´, ê³ ê°ì˜ ì”ê³ ê°€ ë¶€ì¡±í•œ ê²ƒì€ ì‹œìŠ¤í…œì— ë¬¸ì œê°€ ìˆëŠ” ê²ƒì´ ì•„ë‹ˆë‹¤. ì˜¤íˆë ¤ ì‹œìŠ¤í…œì€ ë¬¸ì œ ì—†ì´ ë™ì‘í•œ ê²ƒì´ê³ , ë¹„ì¦ˆë‹ˆìŠ¤ ìƒí™©ì´ ì˜ˆì™¸ì¸ ê²ƒì´ë‹¤. ì´ëŸ° ì˜ˆì™¸ë¥¼ ë¹„ì¦ˆë‹ˆìŠ¤ ì˜ˆì™¸ë¼ í•œë‹¤. ê·¸ë¦¬ê³  ë¹„ì¦ˆë‹ˆìŠ¤ ì˜ˆì™¸ëŠ” ë§¤ìš° ì¤‘ìš”í•˜ê³ , ë°˜ë“œì‹œ ì²˜ë¦¬í•´ì•¼ í•˜ëŠ” ê²½ìš°ê°€ ë§ìœ¼ë¯€ë¡œ ì²´í¬ ì˜ˆì™¸ë¥¼ ê³ ë ¤í•  ìˆ˜ ìˆë‹¤.

ì‹¤ì œ ì½”ë“œë¡œ ì•Œì•„ë³´ì.

ë‹¤ìŒ ë¶€ë¶„ì€ í…ŒìŠ¤íŠ¸ë¥¼ ì œì™¸í•˜ê³  `src/main`ì— ì‘ì„±í•˜ì.

**NotEnoughMoneyException**

```java
package hello.springtx.order;

public class NotEnoughMoneyException extends Exception{

    public NotEnoughMoneyException(String message) {
        super(message);
    }

}
```

- ê²°ì œ ì”ê³ ê°€ ë¶€ì¡±í•˜ë©´ ë°œìƒí•˜ëŠ” ë¹„ì¦ˆë‹ˆìŠ¤ ì˜ˆì™¸ì´ë‹¤. Exceptionì„ ìƒì† ë°›ì•„ì„œ ì²´í¬ ì˜ˆì™¸ê°€ ëœë‹¤.

**Order**

```java
package hello.springtx.order;

import jakarta.persistence.Entity;
import jakarta.persistence.GeneratedValue;
import jakarta.persistence.Id;
import jakarta.persistence.Table;
import lombok.Getter;
import lombok.Setter;

@Entity
@Table(name = "orders")
@Getter
@Setter
public class Order {

    @Id
    @GeneratedValue
    private Long id;

    private String username; //ì •ìƒ, ì˜ˆì™¸, ì”ê³ ë¶€ì¡±
    private String payStatus; //ëŒ€ê¸°, ì™„ë£Œ
   
}
```

- JPAë¥¼ ì‚¬ìš©í•˜ëŠ” `Order` ì—”í‹°í‹°ì´ë‹¤.
- ì˜ˆì œë¥¼ ë‹¨ìˆœí•˜ê²Œ í•˜ê¸° ìœ„í•´ `@Getter`, `@Setter`ë¥¼ ì‚¬ìš©í–ˆë‹¤. ì°¸ê³ ë¡œ ì‹¤ë¬´ì—ì„œ ì—”í‹°í‹°ì— `@Setter`ë¥¼ ë‚¨ë°œí•´ì„œ ë¶ˆí•„ìš”í•œ ë³€ê²½ í¬ì¸íŠ¸ë¥¼ ë…¸ì¶œí•˜ëŠ” ê²ƒì€ ì¢‹ì§€ ì•Šë‹¤.

> **âš ï¸Â ì£¼ì˜!** 
`@Table(name = â€œordersâ€)`ë¼ê³  í–ˆëŠ”ë°, í…Œì´ë¸” ì´ë¦„ì„ ì§€ì •í•˜ì§€ ì•Šìœ¼ë©´ í…Œì´ë¸” ì´ë¦„ì´ í´ë˜ìŠ¤ ì´ë¦„ì¸ `order`ê°€ ëœë‹¤. `order`ëŠ” ë°ì´í„°ë² ì´ìŠ¤ ì˜ˆì•½ì–´(`order by`)ì—¬ì„œ ì‚¬ìš©í•  ìˆ˜ ì—†ë‹¤. ê·¸ë˜ì„œ `orders`ë¼ëŠ” í…Œì´ë¸” ì´ë¦„ì„ ë”°ë¡œ ì§€ì •í•´ì£¼ì—ˆë‹¤.
> 

**OrderRepository**

```java
package hello.springtx.order;

import org.springframework.data.jpa.repository.JpaRepository;

public interface OrderRepository  extends JpaRepository<Order, Long> {
}
```

- ìŠ¤í”„ë§ ë°ì´í„° JPAë¥¼ ì‚¬ìš©í•œë‹¤.

**OrderService**

```java
package hello.springtx.order;

import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

@Slf4j
@Service
@RequiredArgsConstructor
public class OrderService {

    private final OrderRepository orderRepository;

    //JPAëŠ” íŠ¸ëœì­ì…˜ ì»¤ë°‹ ì‹œì ì— Order ë°ì´í„°ë¥¼ DBì— ë°˜ì˜í•œë‹¤.
    @Transactional
    public void order(Order order) throws NotEnoughMoneyException {
        log.info("order í˜¸ì¶œ");
        orderRepository.save(order);

        log.info("ê²°ì œ í”„ë¡œì„¸ìŠ¤ ì§„ì…");
        if (order.getUsername().equals("ì˜ˆì™¸")) {
            log.info("ì‹œìŠ¤í…œ ì˜ˆì™¸ ë°œìƒ");
            throw new RuntimeException("ì‹œìŠ¤í…œ ì˜ˆì™¸");
        } else if (order.getUsername().equals("ì”ê³ ë¶€ì¡±")) {
            log.info("ì”ê³  ë¶€ì¡± ë¹„ì¦ˆë‹ˆìŠ¤ ì˜ˆì™¸ ë°œìƒ");
            order.setPayStatus("ëŒ€ê¸°");
            throw new NotEnoughMoneyException("ì”ê³ ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤");
        } else {
            //ì •ì‚° ìŠ¹ì¸
            log.info("ì •ìƒ ìŠ¹ì¸");
            order.setPayStatus("ì™„ë£Œ");
        }
        log.info("ê²°ì œ í”„ë¡œì„¸ìŠ¤ ì™„ë£Œ");
    }

}
```

- ì—¬ëŸ¬ ìƒí™©ì„ ë§Œë“¤ê¸° ìœ„í•´ì„œ ì‚¬ìš©ì ì´ë¦„(`username`)ì— ë”°ë¼ì„œ ì²˜ë¦¬ í”„ë¡œì„¸ìŠ¤ë¥¼ ë‹¤ë¥´ê²Œ í–ˆë‹¤.
    - `ê¸°ë³¸` : `payStatus`ë¥¼ `ì™„ë£Œ` ìƒíƒœë¡œ ì²˜ë¦¬í•˜ê³  ì •ìƒ ì²˜ë¦¬ëœë‹¤.
    - `ì˜ˆì™¸` : `RuntimeException(â€ì‹œìŠ¤í…œ ì˜ˆì™¸â€)` ëŸ°íƒ€ì„ ì˜ˆì™¸ê°€ ë°œìƒí•œë‹¤.
    - `ì”ê³ ë¶€ì¡±` :
        - `payStatus`ë¥¼ `ëŒ€ê¸°` ìƒíƒœë¡œ ì²˜ë¦¬í•œë‹¤.
        - `NotEnoughMoneyException(â€ì”ê³ ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤â€)` ì²´í¬ ì˜ˆì™¸ê°€ ë°œìƒí•œë‹¤.
        - ì”ê³  ë¶€ì¡±ì€ `payStatus`ë¥¼ `ëŒ€ê¸°` ìƒíƒœë¡œ ë‘ê³ , ì²´í¬ ì˜ˆì™¸ê°€ ë°œìƒí•˜ì§€ë§Œ, `order` ë°ì´í„°ëŠ” ì»¤ë°‹ë˜ê¸°ë¥¼ ê¸°ëŒ€í•œë‹¤.

**OrderServiceTest**

```java
package hello.springtx.order;

import lombok.extern.slf4j.Slf4j;
import org.assertj.core.api.Assertions;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;

import java.util.Optional;

import static org.assertj.core.api.Assertions.assertThat;
import static org.assertj.core.api.Assertions.assertThatThrownBy;
import static org.junit.jupiter.api.Assertions.*;

@Slf4j
@SpringBootTest
class OrderServiceTest {

    @Autowired
    OrderService orderService;

    @Autowired
    OrderRepository orderRepository;

    @Test
    void complete() throws NotEnoughMoneyException {
        //given
        Order order = new Order();
        order.setUsername("ì •ìƒ");

        //when
        orderService.order(order);

        //then
        Order findOrder = orderRepository.findById(order.getId()).get();
        assertThat(findOrder.getPayStatus()).isEqualTo("ì™„ë£Œ");
    }

    @Test
    void runtimeException() {
        //given
        Order order = new Order();
        order.setUsername("ì˜ˆì™¸");

        //when, then
        assertThatThrownBy(() -> orderService.order(order))
                .isInstanceOf(RuntimeException.class);

        //then: ë¡¤ë°±ë˜ì—ˆìœ¼ë¯€ë¡œ ë°ì´í„°ê°€ ì—†ì–´ì•¼ í•œë‹¤.
        Optional<Order> orderOptional = orderRepository.findById(order.getId());
        assertThat(orderOptional.isEmpty()).isTrue();
    }

    @Test
    void bizException() {
        //given
        Order order = new Order();
        order.setUsername("ì”ê³ ë¶€ì¡±");

        //when
        try {
            orderService.order(order);
            fail("ì”ê³  ë¶€ì¡± ì˜ˆì™¸ê°€ ë°œìƒí•´ì•¼ í•©ë‹ˆë‹¤.");
        } catch (NotEnoughMoneyException e) {
            log.info("ê³ ê°ì—ê²Œ ì”ê³  ë¶€ì¡±ì„ ì•Œë¦¬ê³  ë³„ë„ì˜ ê³„ì¢Œë¡œ ì…ê¸ˆí•˜ë„ë¡ ì•ˆë‚´");
        }

        //then
        Order findOrder = orderRepository.findById(order.getId()).get();
        assertThat(findOrder.getPayStatus()).isEqualTo("ëŒ€ê¸°");

    }

}
```

**ì¤€ë¹„**

ì‹¤í–‰í•˜ê¸° ì „ì— ë‹¤ìŒì„ ì¶”ê°€í•˜ì. ì´ë ‡ê²Œ í•˜ë©´ JPA(í•˜ì´ë²„ë„¤ì´íŠ¸)ê°€ ì‹¤í–‰í•˜ëŠ” SQLì„ ë¡œê·¸ë¡œ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

`logging.level.org.hibernate.SQL=DEBUG`

`application.properties`

```java
logging.level.org.springframework.transaction.interceptor=TRACE
logging.level.org.springframework.jdbc.datasource.DataSourceTransactionManager=DEBUG

#JPA log
logging.level.org.springframework.orm.jpa.JpaTransactionManager=DEBUG
logging.level.org.hibernate.resource.transaction=DEBUG

#JPA SQL
logging.level.org.hibernate.SQL=DEBUG
```

ê·¸ëŸ°ë° ì•„ì§ í…Œì´ë¸”ì„ ìƒì„±í•˜ì§€ ì•Šì•˜ë‹¤. í…Œì´ë¸” ìë™ ìƒì„± ì˜µì…˜ì„ í™œì„±í™”í•˜ì.

`application.properties`ì— `spring.jpa.hibernate.ddl-auto` ì˜µì…˜ìœ¼ë¡œ ì¡°ì •í•  ìˆ˜ ìˆë‹¤.

- `none` : í…Œì´ë¸”ì„ ìƒì„±í•˜ì§€ ì•ŠëŠ”ë‹¤.
- `create`: ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ ì‹œì ì— í…Œì´ë¸”ì„ ìƒì„±í•œë‹¤.

### complete()

ì‚¬ìš©ì ì´ë¦„ì„ `ì •ìƒ` ìœ¼ë¡œ ì„¤ì •í–ˆë‹¤. ëª¨ë“  í”„ë¡œì„¸ìŠ¤ê°€ ì •ìƒ ìˆ˜í–‰ëœë‹¤.

ë‹¤ìŒì„ í†µí•´ì„œ ë°ì´í„°ê°€ `ì™„ë£Œ` ìƒíƒœë¡œ ì €ì¥ ë˜ì—ˆëŠ”ì§€ ê²€ì¦í•œë‹¤.

`assertThat(findOrder.getPayStatus()).isEqualTo("ì™„ë£Œ");`

### runtimeException()

ì‚¬ìš©ì ì´ë¦„ì„ `ì˜ˆì™¸` ë¡œ ì„¤ì •í–ˆë‹¤.

`RuntimeException(â€ì‹œìŠ¤í…œ ì˜ˆì™¸â€)`ì´ ë°œìƒí•œë‹¤.

ëŸ°íƒ€ì„ ì˜ˆì™¸ë¡œ ë¡¤ë°±ì´ ìˆ˜í–‰ë˜ì—ˆê¸° ë•Œë¬¸ì— `Order` ë°ì´í„°ê°€ ë¹„ì–´ ìˆëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

### bizException()

ì‚¬ìš©ì ì´ë¦„ì„ `ì”ê³ ë¶€ì¡±` ìœ¼ë¡œ ì„¤ì •í–ˆë‹¤.

`NotEnoughMoneyException("ì”ê³ ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤")` ì´ ë°œìƒí•œë‹¤.

ì²´í¬ ì˜ˆì™¸ë¡œ ì»¤ë°‹ì´ ìˆ˜í–‰ë˜ì—ˆê¸° ë•Œë¬¸ì— `Order` ë°ì´í„°ê°€ ì €ì¥ëœë‹¤.

ë‹¤ìŒì„ í†µí•´ì„œ ë°ì´í„°ê°€ `ëŒ€ê¸°` ìƒíƒœë¡œ ì˜ ì €ì¥ ë˜ì—ˆëŠ”ì§€ ê²€ì¦í•œë‹¤.

`assertThat(findOrder.getPayStatus()).isEqualTo("ëŒ€ê¸°");`

### ì •ë¦¬

- `NotEnoughMoneyException` ì€ ì‹œìŠ¤í…œì— ë¬¸ì œê°€ ë°œìƒí•œ ê²ƒì´ ì•„ë‹ˆë¼, ë¹„ì¦ˆë‹ˆìŠ¤ ë¬¸ì œ ìƒí™©ì„ ì˜ˆì™¸ë¥¼ í†µí•´ ì•Œë ¤ì¤€ë‹¤. ë§ˆì¹˜ ì˜ˆì™¸ê°€ ë¦¬í„´ ê°’ ì²˜ëŸ¼ ì‚¬ìš©ëœë‹¤. ë”°ë¼ì„œ ì´ ê²½ìš°ì—ëŠ” íŠ¸ëœì­ì…˜ì„ ì»¤ë°‹í•˜ëŠ” ê²ƒì´ ë§ë‹¤. ì´ ê²½ìš° ë¡¤ë°±í•˜ë©´ ìƒì„±í•œ `Order` ìì²´ê°€ ì‚¬ë¼ì§„ë‹¤. ê·¸ëŸ¬ë©´ ê³ ê°ì—ê²Œ ì”ê³  ë¶€ì¡±ì„ ì•Œë¦¬ê³  ë³„ë„ì˜ ê³„ì¢Œë¡œ ì…ê¸ˆí•˜ë„ë¡ ì£¼ë¬¸(`Order`) ìì²´ê°€ ì‚¬ë¼ì§€ê¸° ë•Œë¬¸ì— ë¬¸ì œê°€ ëœë‹¤.
- ãƒ¥ëŸ°ë° ë¹„ì¦ˆë‹ˆìŠ¤ ìƒí™©ì— ë”°ë¼ ì²´í¬ ì˜ˆì™¸ì˜ ê²½ìš°ì—ë„ íŠ¸ëœì­ì…˜ì„ ì»¤ë°‹í•˜ì§€ ì•Šê³ , ë¡¤ì­í•˜ê³  ì‹¶ì„ ìˆ˜ ìˆë‹¤.
ì´ë•ŒëŠ” `rollbackFor` ì˜µì…˜ì„ ì‚¬ìš©í•˜ë©´ ëœë‹¤.
- ëŸ°íƒ€ì„ ì˜ˆì™¸ëŠ” í•­ìƒ ë¡¤ë°±ëœë‹¤. ì²´í¬ ì˜ˆì™¸ì˜ ê²½ìš° `rollbackFor` ì˜µì…˜ì„ ì‚¬ìš©í•´ì„œ ë¹„ì¦ˆë‹ˆìŠ¤ ìƒí™©ì— ë”°ë¼ì„œ ì»¤ë°‹ê³¼ ë¡¤ë°±ì„ ì„ íƒí•˜ë©´ ëœë‹¤.